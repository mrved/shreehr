---
phase: 02-time-attendance
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - src/app/(dashboard)/attendance/page.tsx
  - src/app/(dashboard)/attendance/team/page.tsx
  - src/app/(dashboard)/leave/page.tsx
  - src/app/(dashboard)/leave/apply/page.tsx
  - src/app/(dashboard)/leave/types/page.tsx
  - src/components/attendance/check-in-button.tsx
  - src/components/attendance/attendance-calendar.tsx
  - src/components/attendance/team-attendance.tsx
  - src/components/leave/leave-balance-card.tsx
  - src/components/leave/leave-request-form.tsx
  - src/components/leave/leave-requests-list.tsx
autonomous: false

must_haves:
  truths:
    - "Employee can check-in and check-out via web interface"
    - "Manager can view team attendance summary and identify missing punches"
    - "Employee can view leave balances and apply for leave"
    - "Admin can configure leave types with annual quotas"
  artifacts:
    - path: "src/app/(dashboard)/attendance/page.tsx"
      provides: "Employee attendance page"
      min_lines: 50
    - path: "src/app/(dashboard)/attendance/team/page.tsx"
      provides: "Manager team attendance view"
      min_lines: 50
    - path: "src/app/(dashboard)/leave/page.tsx"
      provides: "Leave dashboard"
      min_lines: 50
    - path: "src/components/attendance/check-in-button.tsx"
      provides: "Check-in/out button component"
      min_lines: 30
    - path: "src/components/leave/leave-balance-card.tsx"
      provides: "Leave balance display"
      min_lines: 30
  key_links:
    - from: "src/components/attendance/check-in-button.tsx"
      to: "/api/attendance/check-in"
      via: "fetch on click"
      pattern: "fetch.*api/attendance/check-in"
    - from: "src/components/leave/leave-request-form.tsx"
      to: "/api/leave-requests"
      via: "form submission"
      pattern: "fetch.*api/leave-requests"
---

<objective>
Create the attendance and leave management UI for employees and managers.

Purpose: Provide employees with a web interface to check-in/out and view attendance, managers with team attendance summary, and leave management for all users. This is the user-facing layer that makes Phase 2 capabilities accessible.
Output: Attendance pages, leave pages, reusable components
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-time-attendance/02-01-SUMMARY.md
@.planning/phases/02-time-attendance/02-02-SUMMARY.md
@.planning/phases/02-time-attendance/02-03-SUMMARY.md
@src/app/(dashboard)/employees/page.tsx
@src/components/employees/employee-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create attendance UI components and pages</name>
  <files>
    src/components/attendance/check-in-button.tsx
    src/components/attendance/attendance-calendar.tsx
    src/components/attendance/team-attendance.tsx
    src/app/(dashboard)/attendance/page.tsx
    src/app/(dashboard)/attendance/team/page.tsx
  </files>
  <action>
Create check-in/out button component at src/components/attendance/check-in-button.tsx:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Clock, LogIn, LogOut, Loader2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

interface AttendanceStatus {
  checkedIn: boolean;
  checkedOut: boolean;
  checkInTime?: string;
  checkOutTime?: string;
  workMinutes?: number;
}

export function CheckInButton() {
  const [status, setStatus] = useState<AttendanceStatus | null>(null);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState(false);
  const { toast } = useToast();

  useEffect(() => {
    fetchStatus();
  }, []);

  async function fetchStatus() {
    try {
      const today = new Date().toISOString().split('T')[0];
      const res = await fetch(`/api/attendance?startDate=${today}&endDate=${today}`);
      const data = await res.json();

      if (data.attendances && data.attendances.length > 0) {
        const todayRecord = data.attendances[0];
        setStatus({
          checkedIn: !!todayRecord.check_in,
          checkedOut: !!todayRecord.check_out,
          checkInTime: todayRecord.check_in,
          checkOutTime: todayRecord.check_out,
          workMinutes: todayRecord.work_minutes,
        });
      } else {
        setStatus({ checkedIn: false, checkedOut: false });
      }
    } catch (error) {
      console.error('Failed to fetch attendance status:', error);
      setStatus({ checkedIn: false, checkedOut: false });
    } finally {
      setLoading(false);
    }
  }

  async function handleCheckIn() {
    setActionLoading(true);
    try {
      const res = await fetch('/api/attendance/check-in', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
      });

      if (res.ok) {
        toast({ title: 'Checked in successfully' });
        fetchStatus();
      } else {
        const data = await res.json();
        toast({ title: 'Check-in failed', description: data.error, variant: 'destructive' });
      }
    } catch (error) {
      toast({ title: 'Check-in failed', variant: 'destructive' });
    } finally {
      setActionLoading(false);
    }
  }

  async function handleCheckOut() {
    setActionLoading(true);
    try {
      const res = await fetch('/api/attendance/check-out', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
      });

      if (res.ok) {
        toast({ title: 'Checked out successfully' });
        fetchStatus();
      } else {
        const data = await res.json();
        toast({ title: 'Check-out failed', description: data.error, variant: 'destructive' });
      }
    } catch (error) {
      toast({ title: 'Check-out failed', variant: 'destructive' });
    } finally {
      setActionLoading(false);
    }
  }

  function formatTime(isoString: string) {
    return new Date(isoString).toLocaleTimeString('en-IN', {
      hour: '2-digit',
      minute: '2-digit',
    });
  }

  function formatDuration(minutes: number) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h ${mins}m`;
  }

  if (loading) {
    return (
      <Card>
        <CardContent className="p-6 flex items-center justify-center">
          <Loader2 className="h-6 w-6 animate-spin" />
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardContent className="p-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Clock className="h-8 w-8 text-muted-foreground" />
            <div>
              <p className="text-sm text-muted-foreground">Today's Attendance</p>
              {status?.checkedIn && (
                <p className="text-sm">
                  In: {formatTime(status.checkInTime!)}
                  {status.checkedOut && ` | Out: ${formatTime(status.checkOutTime!)}`}
                </p>
              )}
              {status?.workMinutes && status.workMinutes > 0 && (
                <p className="text-sm font-medium">
                  Work: {formatDuration(status.workMinutes)}
                </p>
              )}
            </div>
          </div>

          <div className="flex items-center gap-2">
            {!status?.checkedIn && (
              <Button onClick={handleCheckIn} disabled={actionLoading}>
                {actionLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : <LogIn className="h-4 w-4 mr-2" />}
                Check In
              </Button>
            )}

            {status?.checkedIn && !status?.checkedOut && (
              <Button onClick={handleCheckOut} disabled={actionLoading} variant="outline">
                {actionLoading ? <Loader2 className="h-4 w-4 animate-spin" /> : <LogOut className="h-4 w-4 mr-2" />}
                Check Out
              </Button>
            )}

            {status?.checkedOut && (
              <Badge variant="secondary">Day Complete</Badge>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

Create attendance calendar component at src/components/attendance/attendance-calendar.tsx:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { ChevronLeft, ChevronRight, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface AttendanceRecord {
  id: string;
  date: string;
  check_in: string | null;
  check_out: string | null;
  work_minutes: number;
  status: string;
}

const statusColors: Record<string, string> = {
  PRESENT: 'bg-green-500',
  HALF_DAY: 'bg-yellow-500',
  ABSENT: 'bg-red-500',
  ON_LEAVE: 'bg-blue-500',
  HOLIDAY: 'bg-purple-500',
  WEEKEND: 'bg-gray-300',
};

export function AttendanceCalendar({ employeeId }: { employeeId?: string }) {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [attendance, setAttendance] = useState<AttendanceRecord[]>([]);
  const [loading, setLoading] = useState(true);

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  useEffect(() => {
    fetchAttendance();
  }, [year, month, employeeId]);

  async function fetchAttendance() {
    setLoading(true);
    try {
      const startDate = new Date(year, month, 1).toISOString();
      const endDate = new Date(year, month + 1, 0).toISOString();

      const params = new URLSearchParams({
        startDate,
        endDate,
        limit: '31',
      });

      if (employeeId) {
        params.set('employeeId', employeeId);
      }

      const res = await fetch(`/api/attendance?${params}`);
      const data = await res.json();
      setAttendance(data.attendances || []);
    } catch (error) {
      console.error('Failed to fetch attendance:', error);
    } finally {
      setLoading(false);
    }
  }

  function getDaysInMonth() {
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const days = [];

    // Add empty cells for days before the first day of month
    for (let i = 0; i < firstDay; i++) {
      days.push(null);
    }

    // Add all days of the month
    for (let i = 1; i <= daysInMonth; i++) {
      days.push(i);
    }

    return days;
  }

  function getAttendanceForDay(day: number) {
    const dateStr = new Date(year, month, day).toISOString().split('T')[0];
    return attendance.find(a => a.date.startsWith(dateStr));
  }

  function previousMonth() {
    setCurrentDate(new Date(year, month - 1, 1));
  }

  function nextMonth() {
    setCurrentDate(new Date(year, month + 1, 1));
  }

  const monthName = currentDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
  const days = getDaysInMonth();
  const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <CardTitle className="text-lg">{monthName}</CardTitle>
        <div className="flex gap-1">
          <Button variant="ghost" size="icon" onClick={previousMonth}>
            <ChevronLeft className="h-4 w-4" />
          </Button>
          <Button variant="ghost" size="icon" onClick={nextMonth}>
            <ChevronRight className="h-4 w-4" />
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        {loading ? (
          <div className="flex justify-center py-8">
            <Loader2 className="h-6 w-6 animate-spin" />
          </div>
        ) : (
          <>
            <div className="grid grid-cols-7 gap-1 mb-2">
              {weekDays.map(day => (
                <div key={day} className="text-center text-xs font-medium text-muted-foreground py-1">
                  {day}
                </div>
              ))}
            </div>
            <div className="grid grid-cols-7 gap-1">
              {days.map((day, index) => {
                if (day === null) {
                  return <div key={`empty-${index}`} className="h-10" />;
                }

                const record = getAttendanceForDay(day);
                const isWeekend = new Date(year, month, day).getDay() % 6 === 0;
                const status = record?.status || (isWeekend ? 'WEEKEND' : null);

                return (
                  <div
                    key={day}
                    className={cn(
                      'h-10 flex items-center justify-center rounded text-sm relative',
                      status && statusColors[status],
                      status && 'text-white',
                      !status && 'hover:bg-muted'
                    )}
                    title={status ? `${status} - ${record?.work_minutes || 0} mins` : undefined}
                  >
                    {day}
                  </div>
                );
              })}
            </div>

            <div className="flex flex-wrap gap-2 mt-4 pt-4 border-t">
              {Object.entries(statusColors).map(([status, color]) => (
                <div key={status} className="flex items-center gap-1 text-xs">
                  <div className={cn('w-3 h-3 rounded', color)} />
                  <span>{status.replace('_', ' ')}</span>
                </div>
              ))}
            </div>
          </>
        )}
      </CardContent>
    </Card>
  );
}
```

Create team attendance component at src/components/attendance/team-attendance.tsx:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Loader2, AlertCircle } from 'lucide-react';

interface TeamMember {
  id: string;
  first_name: string;
  last_name: string;
  employee_code: string;
  todayStatus?: string;
  checkIn?: string;
  checkOut?: string;
  missingPunch: boolean;
}

export function TeamAttendance() {
  const [team, setTeam] = useState<TeamMember[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<string>('all');

  useEffect(() => {
    fetchTeamAttendance();
  }, []);

  async function fetchTeamAttendance() {
    setLoading(true);
    try {
      const today = new Date().toISOString().split('T')[0];

      // Get team members (direct reports)
      const empRes = await fetch('/api/employees?limit=100');
      const empData = await empRes.json();

      // Get today's attendance for all
      const attRes = await fetch(`/api/attendance?startDate=${today}&endDate=${today}&limit=100`);
      const attData = await attRes.json();

      const attendanceMap = new Map(
        attData.attendances?.map((a: any) => [a.employee_id, a]) || []
      );

      const teamMembers = empData.employees?.map((emp: any) => {
        const att = attendanceMap.get(emp.id);
        return {
          id: emp.id,
          first_name: emp.first_name,
          last_name: emp.last_name,
          employee_code: emp.employee_code,
          todayStatus: att?.status || 'NOT_RECORDED',
          checkIn: att?.check_in,
          checkOut: att?.check_out,
          missingPunch: att?.check_in && !att?.check_out,
        };
      }) || [];

      setTeam(teamMembers);
    } catch (error) {
      console.error('Failed to fetch team attendance:', error);
    } finally {
      setLoading(false);
    }
  }

  const filteredTeam = team.filter(m => {
    if (filter === 'all') return true;
    if (filter === 'present') return m.todayStatus === 'PRESENT' || m.todayStatus === 'HALF_DAY';
    if (filter === 'absent') return m.todayStatus === 'ABSENT' || m.todayStatus === 'NOT_RECORDED';
    if (filter === 'missing') return m.missingPunch;
    return true;
  });

  function formatTime(isoString?: string) {
    if (!isoString) return '-';
    return new Date(isoString).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
  }

  const statusBadge = (status: string) => {
    const variants: Record<string, 'default' | 'secondary' | 'destructive' | 'outline'> = {
      PRESENT: 'default',
      HALF_DAY: 'secondary',
      ABSENT: 'destructive',
      ON_LEAVE: 'outline',
      NOT_RECORDED: 'destructive',
    };
    return <Badge variant={variants[status] || 'secondary'}>{status.replace('_', ' ')}</Badge>;
  };

  const missingCount = team.filter(m => m.missingPunch).length;
  const absentCount = team.filter(m => m.todayStatus === 'ABSENT' || m.todayStatus === 'NOT_RECORDED').length;

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <div>
          <CardTitle>Team Attendance</CardTitle>
          <p className="text-sm text-muted-foreground mt-1">
            {team.length} team members | {absentCount} absent | {missingCount} missing punches
          </p>
        </div>
        <Select value={filter} onValueChange={setFilter}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Filter" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All</SelectItem>
            <SelectItem value="present">Present</SelectItem>
            <SelectItem value="absent">Absent</SelectItem>
            <SelectItem value="missing">Missing Punch</SelectItem>
          </SelectContent>
        </Select>
      </CardHeader>
      <CardContent>
        {loading ? (
          <div className="flex justify-center py-8">
            <Loader2 className="h-6 w-6 animate-spin" />
          </div>
        ) : (
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Employee</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Check In</TableHead>
                <TableHead>Check Out</TableHead>
                <TableHead></TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {filteredTeam.map(member => (
                <TableRow key={member.id}>
                  <TableCell>
                    <div>
                      <p className="font-medium">{member.first_name} {member.last_name}</p>
                      <p className="text-xs text-muted-foreground">{member.employee_code}</p>
                    </div>
                  </TableCell>
                  <TableCell>{statusBadge(member.todayStatus || 'NOT_RECORDED')}</TableCell>
                  <TableCell>{formatTime(member.checkIn)}</TableCell>
                  <TableCell>{formatTime(member.checkOut)}</TableCell>
                  <TableCell>
                    {member.missingPunch && (
                      <AlertCircle className="h-4 w-4 text-yellow-500" title="Missing check-out" />
                    )}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        )}
      </CardContent>
    </Card>
  );
}
```

Create employee attendance page at src/app/(dashboard)/attendance/page.tsx:

```tsx
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { CheckInButton } from '@/components/attendance/check-in-button';
import { AttendanceCalendar } from '@/components/attendance/attendance-calendar';

export default async function AttendancePage() {
  const session = await auth();
  if (!session?.user) {
    redirect('/login');
  }

  return (
    <div className="p-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">My Attendance</h1>
        <p className="text-muted-foreground">Track your daily attendance</p>
      </div>

      <CheckInButton />

      <AttendanceCalendar employeeId={session.user.employeeId} />
    </div>
  );
}
```

Create team attendance page at src/app/(dashboard)/attendance/team/page.tsx:

```tsx
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { TeamAttendance } from '@/components/attendance/team-attendance';

export default async function TeamAttendancePage() {
  const session = await auth();
  if (!session?.user) {
    redirect('/login');
  }

  // Only managers and admins can access
  if (!['ADMIN', 'SUPER_ADMIN', 'HR_MANAGER', 'PAYROLL_MANAGER'].includes(session.user.role)) {
    redirect('/attendance');
  }

  return (
    <div className="p-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Team Attendance</h1>
        <p className="text-muted-foreground">Monitor team attendance and identify missing punches</p>
      </div>

      <TeamAttendance />
    </div>
  );
}
```
  </action>
  <verify>
Run `pnpm tsc --noEmit` to verify TypeScript compilation.
Run `pnpm build` to verify pages build correctly.
  </verify>
  <done>Attendance UI components and pages created with check-in/out, calendar view, and team view</done>
</task>

<task type="auto">
  <name>Task 2: Create leave UI components and pages</name>
  <files>
    src/components/leave/leave-balance-card.tsx
    src/components/leave/leave-request-form.tsx
    src/components/leave/leave-requests-list.tsx
    src/app/(dashboard)/leave/page.tsx
    src/app/(dashboard)/leave/apply/page.tsx
    src/app/(dashboard)/leave/types/page.tsx
  </files>
  <action>
Create leave balance card component at src/components/leave/leave-balance-card.tsx:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Loader2 } from 'lucide-react';

interface LeaveBalance {
  leaveTypeId: string;
  leaveTypeName: string;
  leaveTypeCode: string;
  isPaid: boolean;
  opening: number;
  used: number;
  pending: number;
  balance: number;
  available: number;
}

export function LeaveBalanceCard() {
  const [balances, setBalances] = useState<LeaveBalance[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function fetchBalances() {
      try {
        const res = await fetch('/api/leave-balances');
        const data = await res.json();
        setBalances(data.balances || []);
      } catch (error) {
        console.error('Failed to fetch leave balances:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchBalances();
  }, []);

  if (loading) {
    return (
      <Card>
        <CardContent className="p-6 flex justify-center">
          <Loader2 className="h-6 w-6 animate-spin" />
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      {balances.map(balance => {
        const usedPercent = balance.opening > 0 ? (balance.used / balance.opening) * 100 : 0;
        const pendingPercent = balance.opening > 0 ? (balance.pending / balance.opening) * 100 : 0;

        return (
          <Card key={balance.leaveTypeId}>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium flex items-center justify-between">
                {balance.leaveTypeName}
                <span className="text-xs text-muted-foreground">{balance.leaveTypeCode}</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                <div className="flex justify-between text-2xl font-bold">
                  <span>{balance.available}</span>
                  <span className="text-sm text-muted-foreground font-normal">
                    of {balance.opening}
                  </span>
                </div>

                <Progress value={usedPercent + pendingPercent} className="h-2" />

                <div className="flex justify-between text-xs text-muted-foreground">
                  <span>Used: {balance.used}</span>
                  {balance.pending > 0 && <span>Pending: {balance.pending}</span>}
                </div>
              </div>
            </CardContent>
          </Card>
        );
      })}
    </div>
  );
}
```

Create leave request form at src/components/leave/leave-request-form.tsx:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { useToast } from '@/hooks/use-toast';
import { Loader2 } from 'lucide-react';

interface LeaveType {
  id: string;
  name: string;
  code: string;
  is_paid: boolean;
  requires_approval: boolean;
  min_days_notice: number;
}

export function LeaveRequestForm() {
  const router = useRouter();
  const { toast } = useToast();
  const [leaveTypes, setLeaveTypes] = useState<LeaveType[]>([]);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);

  const [formData, setFormData] = useState({
    leaveTypeId: '',
    startDate: '',
    endDate: '',
    isHalfDay: false,
    halfDayPeriod: 'FIRST_HALF',
    reason: '',
  });

  useEffect(() => {
    async function fetchLeaveTypes() {
      try {
        const res = await fetch('/api/leave-types?activeOnly=true');
        const data = await res.json();
        setLeaveTypes(data);
      } catch (error) {
        console.error('Failed to fetch leave types:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchLeaveTypes();
  }, []);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setSubmitting(true);

    try {
      const payload = {
        ...formData,
        startDate: new Date(formData.startDate).toISOString(),
        endDate: new Date(formData.endDate).toISOString(),
      };

      const res = await fetch('/api/leave-requests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        toast({ title: 'Leave request submitted successfully' });
        router.push('/leave');
      } else {
        const data = await res.json();
        toast({ title: 'Failed to submit', description: data.error, variant: 'destructive' });
      }
    } catch (error) {
      toast({ title: 'Failed to submit leave request', variant: 'destructive' });
    } finally {
      setSubmitting(false);
    }
  }

  if (loading) {
    return (
      <Card>
        <CardContent className="p-6 flex justify-center">
          <Loader2 className="h-6 w-6 animate-spin" />
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Apply for Leave</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="leaveType">Leave Type</Label>
            <Select
              value={formData.leaveTypeId}
              onValueChange={(value) => setFormData({ ...formData, leaveTypeId: value })}
            >
              <SelectTrigger>
                <SelectValue placeholder="Select leave type" />
              </SelectTrigger>
              <SelectContent>
                {leaveTypes.map(lt => (
                  <SelectItem key={lt.id} value={lt.id}>
                    {lt.name} ({lt.code})
                    {!lt.is_paid && ' - Unpaid'}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="startDate">Start Date</Label>
              <Input
                type="date"
                id="startDate"
                value={formData.startDate}
                onChange={(e) => setFormData({
                  ...formData,
                  startDate: e.target.value,
                  endDate: formData.isHalfDay ? e.target.value : formData.endDate
                })}
                required
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="endDate">End Date</Label>
              <Input
                type="date"
                id="endDate"
                value={formData.endDate}
                onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                min={formData.startDate}
                disabled={formData.isHalfDay}
                required
              />
            </div>
          </div>

          <div className="flex items-center space-x-2">
            <Switch
              id="halfDay"
              checked={formData.isHalfDay}
              onCheckedChange={(checked) => setFormData({
                ...formData,
                isHalfDay: checked,
                endDate: checked ? formData.startDate : formData.endDate
              })}
            />
            <Label htmlFor="halfDay">Half Day Leave</Label>
          </div>

          {formData.isHalfDay && (
            <div className="space-y-2">
              <Label>Half Day Period</Label>
              <Select
                value={formData.halfDayPeriod}
                onValueChange={(value) => setFormData({ ...formData, halfDayPeriod: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="FIRST_HALF">First Half (Morning)</SelectItem>
                  <SelectItem value="SECOND_HALF">Second Half (Afternoon)</SelectItem>
                </SelectContent>
              </Select>
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="reason">Reason</Label>
            <Textarea
              id="reason"
              value={formData.reason}
              onChange={(e) => setFormData({ ...formData, reason: e.target.value })}
              placeholder="Enter reason for leave"
              required
              minLength={3}
            />
          </div>

          <div className="flex gap-4">
            <Button type="submit" disabled={submitting}>
              {submitting && <Loader2 className="h-4 w-4 animate-spin mr-2" />}
              Submit Request
            </Button>
            <Button type="button" variant="outline" onClick={() => router.back()}>
              Cancel
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
```

Create leave requests list at src/components/leave/leave-requests-list.tsx:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Loader2, X, Check } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

interface LeaveRequest {
  id: string;
  employee: { first_name: string; last_name: string; employee_code: string };
  leave_type: { name: string; code: string };
  start_date: string;
  end_date: string;
  days_count: number;
  is_half_day: boolean;
  reason: string;
  status: string;
  approver?: { name: string };
  approved_at?: string;
  rejection_reason?: string;
}

interface LeaveRequestsListProps {
  showApproval?: boolean;
}

export function LeaveRequestsList({ showApproval = false }: LeaveRequestsListProps) {
  const [requests, setRequests] = useState<LeaveRequest[]>([]);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  useEffect(() => {
    fetchRequests();
  }, []);

  async function fetchRequests() {
    try {
      const params = new URLSearchParams({ limit: '50' });
      if (showApproval) {
        params.set('status', 'PENDING');
      }

      const res = await fetch(`/api/leave-requests?${params}`);
      const data = await res.json();
      setRequests(data.requests || []);
    } catch (error) {
      console.error('Failed to fetch leave requests:', error);
    } finally {
      setLoading(false);
    }
  }

  async function handleAction(id: string, action: 'approve' | 'reject' | 'cancel', reason?: string) {
    try {
      const res = await fetch(`/api/leave-requests/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, reason }),
      });

      if (res.ok) {
        toast({ title: `Leave request ${action}d` });
        fetchRequests();
      } else {
        const data = await res.json();
        toast({ title: `Failed to ${action}`, description: data.error, variant: 'destructive' });
      }
    } catch (error) {
      toast({ title: `Failed to ${action} leave request`, variant: 'destructive' });
    }
  }

  function formatDate(isoString: string) {
    return new Date(isoString).toLocaleDateString('en-IN', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
    });
  }

  const statusBadge = (status: string) => {
    const variants: Record<string, 'default' | 'secondary' | 'destructive' | 'outline'> = {
      PENDING: 'secondary',
      APPROVED: 'default',
      REJECTED: 'destructive',
      CANCELLED: 'outline',
    };
    return <Badge variant={variants[status] || 'secondary'}>{status}</Badge>;
  };

  if (loading) {
    return (
      <Card>
        <CardContent className="p-6 flex justify-center">
          <Loader2 className="h-6 w-6 animate-spin" />
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>{showApproval ? 'Pending Approvals' : 'My Leave Requests'}</CardTitle>
      </CardHeader>
      <CardContent>
        {requests.length === 0 ? (
          <p className="text-center text-muted-foreground py-8">No leave requests found</p>
        ) : (
          <Table>
            <TableHeader>
              <TableRow>
                {showApproval && <TableHead>Employee</TableHead>}
                <TableHead>Type</TableHead>
                <TableHead>Dates</TableHead>
                <TableHead>Days</TableHead>
                <TableHead>Reason</TableHead>
                <TableHead>Status</TableHead>
                <TableHead></TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {requests.map(req => (
                <TableRow key={req.id}>
                  {showApproval && (
                    <TableCell>
                      <div>
                        <p className="font-medium">{req.employee.first_name} {req.employee.last_name}</p>
                        <p className="text-xs text-muted-foreground">{req.employee.employee_code}</p>
                      </div>
                    </TableCell>
                  )}
                  <TableCell>
                    <Badge variant="outline">{req.leave_type.code}</Badge>
                  </TableCell>
                  <TableCell>
                    {formatDate(req.start_date)}
                    {req.start_date !== req.end_date && ` - ${formatDate(req.end_date)}`}
                  </TableCell>
                  <TableCell>
                    {req.days_count}{req.is_half_day && ' (half)'}
                  </TableCell>
                  <TableCell className="max-w-[200px] truncate" title={req.reason}>
                    {req.reason}
                  </TableCell>
                  <TableCell>{statusBadge(req.status)}</TableCell>
                  <TableCell>
                    {showApproval && req.status === 'PENDING' && (
                      <div className="flex gap-1">
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => handleAction(req.id, 'approve')}
                        >
                          <Check className="h-4 w-4 text-green-500" />
                        </Button>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => {
                            const reason = prompt('Rejection reason:');
                            if (reason) handleAction(req.id, 'reject', reason);
                          }}
                        >
                          <X className="h-4 w-4 text-red-500" />
                        </Button>
                      </div>
                    )}
                    {!showApproval && req.status === 'PENDING' && (
                      <Button
                        size="sm"
                        variant="ghost"
                        onClick={() => handleAction(req.id, 'cancel')}
                      >
                        Cancel
                      </Button>
                    )}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        )}
      </CardContent>
    </Card>
  );
}
```

Create leave dashboard page at src/app/(dashboard)/leave/page.tsx:

```tsx
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { LeaveBalanceCard } from '@/components/leave/leave-balance-card';
import { LeaveRequestsList } from '@/components/leave/leave-requests-list';
import { Plus } from 'lucide-react';

export default async function LeavePage() {
  const session = await auth();
  if (!session?.user) {
    redirect('/login');
  }

  const isManager = ['ADMIN', 'SUPER_ADMIN', 'HR_MANAGER', 'PAYROLL_MANAGER'].includes(session.user.role);

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Leave Management</h1>
          <p className="text-muted-foreground">View balances and manage leave requests</p>
        </div>
        <Link href="/leave/apply">
          <Button>
            <Plus className="h-4 w-4 mr-2" />
            Apply Leave
          </Button>
        </Link>
      </div>

      <LeaveBalanceCard />

      <LeaveRequestsList />

      {isManager && (
        <LeaveRequestsList showApproval />
      )}
    </div>
  );
}
```

Create leave apply page at src/app/(dashboard)/leave/apply/page.tsx:

```tsx
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { LeaveRequestForm } from '@/components/leave/leave-request-form';

export default async function ApplyLeavePage() {
  const session = await auth();
  if (!session?.user) {
    redirect('/login');
  }

  return (
    <div className="p-6 max-w-2xl">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">Apply for Leave</h1>
        <p className="text-muted-foreground">Submit a new leave request</p>
      </div>

      <LeaveRequestForm />
    </div>
  );
}
```

Create leave types admin page at src/app/(dashboard)/leave/types/page.tsx:

```tsx
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { LeaveTypesManager } from '@/components/leave/leave-types-manager';

export default async function LeaveTypesPage() {
  const session = await auth();
  if (!session?.user || !['ADMIN', 'SUPER_ADMIN', 'HR_MANAGER'].includes(session.user.role)) {
    redirect('/leave');
  }

  return (
    <div className="p-6">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">Leave Type Configuration</h1>
        <p className="text-muted-foreground">Configure leave types and annual quotas</p>
      </div>

      <LeaveTypesManager />
    </div>
  );
}
```

Also create leave types manager component at src/components/leave/leave-types-manager.tsx:

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { useToast } from '@/hooks/use-toast';
import { Loader2, Plus, Pencil, Trash2 } from 'lucide-react';

interface LeaveType {
  id: string;
  name: string;
  code: string;
  description?: string;
  annual_quota: number;
  max_carry_forward: number;
  is_paid: boolean;
  requires_approval: boolean;
  min_days_notice: number;
  is_active: boolean;
}

export function LeaveTypesManager() {
  const [leaveTypes, setLeaveTypes] = useState<LeaveType[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingType, setEditingType] = useState<LeaveType | null>(null);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const { toast } = useToast();

  const [formData, setFormData] = useState({
    name: '',
    code: '',
    description: '',
    annualQuota: 0,
    maxCarryForward: 0,
    isPaid: true,
    requiresApproval: true,
    minDaysNotice: 0,
  });

  useEffect(() => {
    fetchLeaveTypes();
  }, []);

  async function fetchLeaveTypes() {
    try {
      const res = await fetch('/api/leave-types');
      const data = await res.json();
      setLeaveTypes(data);
    } catch (error) {
      console.error('Failed to fetch leave types:', error);
    } finally {
      setLoading(false);
    }
  }

  function resetForm() {
    setFormData({
      name: '',
      code: '',
      description: '',
      annualQuota: 0,
      maxCarryForward: 0,
      isPaid: true,
      requiresApproval: true,
      minDaysNotice: 0,
    });
    setEditingType(null);
  }

  function openEdit(lt: LeaveType) {
    setEditingType(lt);
    setFormData({
      name: lt.name,
      code: lt.code,
      description: lt.description || '',
      annualQuota: lt.annual_quota,
      maxCarryForward: lt.max_carry_forward,
      isPaid: lt.is_paid,
      requiresApproval: lt.requires_approval,
      minDaysNotice: lt.min_days_notice,
    });
    setIsDialogOpen(true);
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    try {
      const url = editingType
        ? `/api/leave-types/${editingType.id}`
        : '/api/leave-types';
      const method = editingType ? 'PATCH' : 'POST';

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      if (res.ok) {
        toast({ title: `Leave type ${editingType ? 'updated' : 'created'}` });
        setIsDialogOpen(false);
        resetForm();
        fetchLeaveTypes();
      } else {
        const data = await res.json();
        toast({ title: 'Failed', description: data.error, variant: 'destructive' });
      }
    } catch (error) {
      toast({ title: 'Failed to save leave type', variant: 'destructive' });
    }
  }

  async function handleDelete(id: string) {
    if (!confirm('Are you sure you want to delete this leave type?')) return;

    try {
      const res = await fetch(`/api/leave-types/${id}`, { method: 'DELETE' });
      if (res.ok) {
        toast({ title: 'Leave type deleted' });
        fetchLeaveTypes();
      } else {
        const data = await res.json();
        toast({ title: 'Failed to delete', description: data.error, variant: 'destructive' });
      }
    } catch (error) {
      toast({ title: 'Failed to delete leave type', variant: 'destructive' });
    }
  }

  if (loading) {
    return (
      <Card>
        <CardContent className="p-6 flex justify-center">
          <Loader2 className="h-6 w-6 animate-spin" />
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <CardTitle>Leave Types</CardTitle>
        <Dialog open={isDialogOpen} onOpenChange={(open) => { setIsDialogOpen(open); if (!open) resetForm(); }}>
          <DialogTrigger asChild>
            <Button size="sm">
              <Plus className="h-4 w-4 mr-2" />
              Add Leave Type
            </Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>{editingType ? 'Edit' : 'Add'} Leave Type</DialogTitle>
            </DialogHeader>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Name</Label>
                  <Input
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    required
                  />
                </div>
                <div className="space-y-2">
                  <Label>Code</Label>
                  <Input
                    value={formData.code}
                    onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}
                    required
                    maxLength={10}
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Annual Quota</Label>
                  <Input
                    type="number"
                    value={formData.annualQuota}
                    onChange={(e) => setFormData({ ...formData, annualQuota: parseFloat(e.target.value) })}
                    min={0}
                    step={0.5}
                  />
                </div>
                <div className="space-y-2">
                  <Label>Max Carry Forward</Label>
                  <Input
                    type="number"
                    value={formData.maxCarryForward}
                    onChange={(e) => setFormData({ ...formData, maxCarryForward: parseFloat(e.target.value) })}
                    min={0}
                    step={0.5}
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label>Min Days Notice</Label>
                <Input
                  type="number"
                  value={formData.minDaysNotice}
                  onChange={(e) => setFormData({ ...formData, minDaysNotice: parseInt(e.target.value) })}
                  min={0}
                />
              </div>

              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-2">
                  <Switch
                    checked={formData.isPaid}
                    onCheckedChange={(checked) => setFormData({ ...formData, isPaid: checked })}
                  />
                  <Label>Paid Leave</Label>
                </div>

                <div className="flex items-center space-x-2">
                  <Switch
                    checked={formData.requiresApproval}
                    onCheckedChange={(checked) => setFormData({ ...formData, requiresApproval: checked })}
                  />
                  <Label>Requires Approval</Label>
                </div>
              </div>

              <Button type="submit" className="w-full">
                {editingType ? 'Update' : 'Create'} Leave Type
              </Button>
            </form>
          </DialogContent>
        </Dialog>
      </CardHeader>
      <CardContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Name</TableHead>
              <TableHead>Code</TableHead>
              <TableHead>Annual Quota</TableHead>
              <TableHead>Carry Forward</TableHead>
              <TableHead>Paid</TableHead>
              <TableHead>Approval</TableHead>
              <TableHead></TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {leaveTypes.map(lt => (
              <TableRow key={lt.id} className={!lt.is_active ? 'opacity-50' : ''}>
                <TableCell className="font-medium">{lt.name}</TableCell>
                <TableCell>{lt.code}</TableCell>
                <TableCell>{lt.annual_quota}</TableCell>
                <TableCell>{lt.max_carry_forward}</TableCell>
                <TableCell>{lt.is_paid ? 'Yes' : 'No'}</TableCell>
                <TableCell>{lt.requires_approval ? 'Yes' : 'No'}</TableCell>
                <TableCell>
                  <div className="flex gap-1">
                    <Button size="sm" variant="ghost" onClick={() => openEdit(lt)}>
                      <Pencil className="h-4 w-4" />
                    </Button>
                    <Button size="sm" variant="ghost" onClick={() => handleDelete(lt.id)}>
                      <Trash2 className="h-4 w-4 text-red-500" />
                    </Button>
                  </div>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  );
}
```
  </action>
  <verify>
Run `pnpm tsc --noEmit` to verify TypeScript compilation.
Run `pnpm build` to verify pages build correctly.
  </verify>
  <done>Leave UI components and pages created with balance view, request form, and admin configuration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Attendance and Leave UI:
    1. Attendance page with check-in/check-out button
    2. Attendance calendar showing monthly status
    3. Team attendance view for managers
    4. Leave balance cards showing available days
    5. Leave request form with validation
    6. Leave requests list with approval actions
    7. Leave type configuration for admins
  </what-built>
  <how-to-verify>
    1. Start dev server: `pnpm dev`
    2. Login as admin (admin@shreehr.local / admin123)
    3. Navigate to /attendance - verify check-in/out button works
    4. Navigate to /attendance/team - verify team view shows employees
    5. Navigate to /leave - verify balance cards display
    6. Navigate to /leave/apply - submit a leave request
    7. Navigate to /leave/types - configure leave types (add CL, SL, EL)
    8. Check responsive design on mobile viewport

    Expected:
    - Check-in creates attendance record for today
    - Check-out calculates work hours and updates status
    - Leave balance shows correct available days
    - Leave request validates against balance
    - Leave types can be configured with quotas
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Run `pnpm tsc --noEmit` - no TypeScript errors
2. Run `pnpm build` - build completes
3. Visual verification of all UI flows
</verification>

<success_criteria>
- Employee can check-in and check-out via web interface
- Attendance calendar shows monthly attendance with status colors
- Manager can view team attendance and identify missing punches
- Leave balance cards show opening, used, pending, available
- Employee can apply for leave with date picker and validation
- Manager can approve/reject leave requests
- Admin can configure leave types with quotas
- All pages are responsive and follow existing UI patterns
</success_criteria>

<output>
After completion, create `.planning/phases/02-time-attendance/02-04-SUMMARY.md`
</output>
