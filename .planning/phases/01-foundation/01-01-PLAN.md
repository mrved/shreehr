---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - next.config.ts
  - tsconfig.json
  - biome.json
  - .env.example
  - .gitignore
  - prisma/schema.prisma
  - src/lib/db.ts
  - src/lib/encryption.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Project runs with pnpm dev and shows Next.js welcome page"
    - "Database schema exists with all core models (Employee, Department, Designation, User)"
    - "PII fields are encrypted at rest (PAN, Aadhaar, bank account)"
    - "Audit columns exist on all tables (created_by, created_at, updated_by, updated_at)"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies and scripts"
      contains: "next"
    - path: "prisma/schema.prisma"
      provides: "Database schema with all models"
      contains: "model Employee"
    - path: "src/lib/encryption.ts"
      provides: "PII encryption utilities"
      exports: ["encrypt", "decrypt"]
    - path: "src/lib/db.ts"
      provides: "Prisma client singleton"
      exports: ["prisma"]
  key_links:
    - from: "prisma/schema.prisma"
      to: "node_modules/.prisma/client"
      via: "prisma generate"
      pattern: "generator client"
    - from: "src/lib/encryption.ts"
      to: "prisma/schema.prisma"
      via: "encrypted field types"
      pattern: "encrypt.*decrypt"
---

<objective>
Initialize Next.js 16 project with complete database schema for HR domain including PII encryption infrastructure.

Purpose: Establish the technical foundation with all data models required for employee management, organizational structure, and compliance-ready audit trails.

Output: Working Next.js project with Prisma schema, encryption utilities, and development environment ready for feature implementation.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js 16 project with tooling</name>
  <files>
    package.json
    pnpm-lock.yaml
    next.config.ts
    tsconfig.json
    biome.json
    .env.example
    .gitignore
    src/app/layout.tsx
    src/app/page.tsx
  </files>
  <action>
    Initialize Next.js 16 project with pnpm:

    1. Run `pnpm create next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"` (accept defaults for other prompts)

    2. Install core dependencies:
       - `pnpm add prisma @prisma/client`
       - `pnpm add -D @biomejs/biome vitest @vitejs/plugin-react jsdom @testing-library/react`

    3. Replace ESLint with Biome - create biome.json:
       ```json
       {
         "$schema": "https://biomejs.dev/schemas/1.9.4/schema.json",
         "organizeImports": { "enabled": true },
         "linter": {
           "enabled": true,
           "rules": { "recommended": true }
         },
         "formatter": {
           "enabled": true,
           "indentStyle": "tab"
         }
       }
       ```

    4. Update package.json scripts:
       - "lint": "biome check ."
       - "format": "biome format . --write"
       - "test": "vitest"

    5. Create .env.example with:
       ```
       DATABASE_URL="postgresql://user:password@localhost:5432/shreehr"
       NEXTAUTH_SECRET="generate-with-openssl-rand-base64-32"
       NEXTAUTH_URL="http://localhost:3000"
       ENCRYPTION_KEY="generate-32-byte-hex-key"
       ```

    6. Update .gitignore to include:
       - .env
       - .env.local
       - uploads/

    7. Remove ESLint config files (.eslintrc.json if created)
  </action>
  <verify>
    Run `pnpm dev` - should start on localhost:3000 without errors.
    Run `pnpm lint` - Biome should execute without errors.
  </verify>
  <done>
    Next.js 16 app runs, Biome configured, Prisma installed, env template exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create complete Prisma schema with audit infrastructure</name>
  <files>
    prisma/schema.prisma
    src/lib/db.ts
    src/types/index.ts
  </files>
  <action>
    Create prisma/schema.prisma with the following models. CRITICAL: All models MUST have audit columns (createdAt, updatedAt, createdBy, updatedBy).

    ```prisma
    generator client {
      provider = "prisma-client-js"
    }

    datasource db {
      provider = "postgresql"
      url      = env("DATABASE_URL")
    }

    // Enums
    enum Role {
      ADMIN
      MANAGER
      EMPLOYEE
    }

    enum Gender {
      MALE
      FEMALE
      OTHER
    }

    enum EmploymentStatus {
      ACTIVE
      INACTIVE
      TERMINATED
      ON_NOTICE
    }

    enum DocumentType {
      OFFER_LETTER
      ID_PROOF
      ADDRESS_PROOF
      EDUCATION_CERT
      EXPERIENCE_CERT
      PAN_CARD
      AADHAAR_CARD
      BANK_PROOF
      OTHER
    }

    // Auth
    model User {
      id            String    @id @default(cuid())
      email         String    @unique
      passwordHash  String
      role          Role      @default(EMPLOYEE)
      employeeId    String?   @unique
      employee      Employee? @relation(fields: [employeeId], references: [id])
      isActive      Boolean   @default(true)
      lastLoginAt   DateTime?
      createdAt     DateTime  @default(now())
      updatedAt     DateTime  @updatedAt
      createdBy     String?
      updatedBy     String?
    }

    // Organization
    model Department {
      id          String     @id @default(cuid())
      name        String     @unique
      code        String     @unique
      description String?
      isActive    Boolean    @default(true)
      employees   Employee[]
      createdAt   DateTime   @default(now())
      updatedAt   DateTime   @updatedAt
      createdBy   String?
      updatedBy   String?
    }

    model Designation {
      id          String     @id @default(cuid())
      title       String     @unique
      level       Int        @default(1)  // For hierarchy (1=entry, 5=senior, etc.)
      description String?
      isActive    Boolean    @default(true)
      employees   Employee[]
      createdAt   DateTime   @default(now())
      updatedAt   DateTime   @updatedAt
      createdBy   String?
      updatedBy   String?
    }

    // Employee
    model Employee {
      id                  String           @id @default(cuid())
      employeeCode        String           @unique  // e.g., "EMP001"

      // Personal Info
      firstName           String
      lastName            String
      dateOfBirth         DateTime
      gender              Gender
      personalEmail       String?
      workEmail           String           @unique
      phone               String
      emergencyContact    String?
      emergencyPhone      String?

      // Address
      currentAddress      String?
      permanentAddress    String?
      city                String?
      state               String?          // Important for PT calculation
      pincode             String?

      // Employment
      dateOfJoining       DateTime
      dateOfExit          DateTime?
      status              EmploymentStatus @default(ACTIVE)
      probationEndDate    DateTime?
      confirmationDate    DateTime?
      noticePeriodDays    Int              @default(30)

      // Organization
      departmentId        String?
      department          Department?      @relation(fields: [departmentId], references: [id])
      designationId       String?
      designation         Designation?     @relation(fields: [designationId], references: [id])
      reportingManagerId  String?
      reportingManager    Employee?        @relation("ReportingHierarchy", fields: [reportingManagerId], references: [id])
      directReports       Employee[]       @relation("ReportingHierarchy")

      // Sensitive/Encrypted fields - stored as encrypted strings
      panNumber           String?          // Encrypted
      aadhaarNumber       String?          // Encrypted
      bankAccountNumber   String?          // Encrypted
      bankIfscCode        String?
      bankName            String?

      // UAN for PF
      uanNumber           String?
      pfNumber            String?
      esiNumber           String?

      // Relations
      user                User?
      documents           Document[]
      salaryHistory       SalaryRecord[]
      leaveBalances       LeaveBalance[]

      // Audit
      createdAt           DateTime         @default(now())
      updatedAt           DateTime         @updatedAt
      createdBy           String?
      updatedBy           String?

      @@index([departmentId])
      @@index([designationId])
      @@index([reportingManagerId])
      @@index([status])
    }

    // Documents with 8-year retention
    model Document {
      id              String       @id @default(cuid())
      employeeId      String
      employee        Employee     @relation(fields: [employeeId], references: [id])
      type            DocumentType
      fileName        String
      originalName    String
      mimeType        String
      fileSize        Int
      storagePath     String       // Path in local storage
      description     String?

      // Retention (8 years for compliance)
      uploadedAt      DateTime     @default(now())
      retentionUntil  DateTime     // Set to uploadedAt + 8 years
      isDeleted       Boolean      @default(false)
      deletedAt       DateTime?

      // Audit
      createdAt       DateTime     @default(now())
      updatedAt       DateTime     @updatedAt
      createdBy       String?
      updatedBy       String?

      @@index([employeeId])
      @@index([type])
      @@index([retentionUntil])
    }

    // Salary History (for Keka import and Form 16 continuity)
    model SalaryRecord {
      id              String    @id @default(cuid())
      employeeId      String
      employee        Employee  @relation(fields: [employeeId], references: [id])

      // Period
      month           Int       // 1-12
      year            Int

      // Components (stored in paise for precision)
      basicPay        Int
      hra             Int       @default(0)
      conveyance      Int       @default(0)
      specialAllowance Int      @default(0)
      otherAllowances Int       @default(0)
      grossSalary     Int

      // Deductions
      pfEmployee      Int       @default(0)
      pfEmployer      Int       @default(0)
      esiEmployee     Int       @default(0)
      esiEmployer     Int       @default(0)
      professionalTax Int       @default(0)
      tds             Int       @default(0)
      otherDeductions Int       @default(0)

      netSalary       Int

      // Source tracking for imports
      source          String    @default("SYSTEM")  // SYSTEM, KEKA_IMPORT
      importBatchId   String?

      // Audit
      createdAt       DateTime  @default(now())
      updatedAt       DateTime  @updatedAt
      createdBy       String?
      updatedBy       String?

      @@unique([employeeId, month, year])
      @@index([employeeId])
      @@index([year, month])
    }

    // Leave Balances (for Keka import)
    model LeaveBalance {
      id              String    @id @default(cuid())
      employeeId      String
      employee        Employee  @relation(fields: [employeeId], references: [id])

      leaveType       String    // CL, SL, EL, etc.
      year            Int

      opening         Float     @default(0)
      accrued         Float     @default(0)
      used            Float     @default(0)
      adjusted        Float     @default(0)  // Manual adjustments
      balance         Float     @default(0)  // Computed: opening + accrued - used + adjusted

      // Source tracking for imports
      source          String    @default("SYSTEM")
      importBatchId   String?

      // Audit
      createdAt       DateTime  @default(now())
      updatedAt       DateTime  @updatedAt
      createdBy       String?
      updatedBy       String?

      @@unique([employeeId, leaveType, year])
      @@index([employeeId])
      @@index([year])
    }

    // Import tracking
    model ImportBatch {
      id              String    @id @default(cuid())
      type            String    // EMPLOYEES, SALARY_HISTORY, LEAVE_BALANCES
      fileName        String
      status          String    @default("PENDING")  // PENDING, PROCESSING, COMPLETED, FAILED
      totalRecords    Int       @default(0)
      successCount    Int       @default(0)
      errorCount      Int       @default(0)
      errors          Json?     // Array of error details

      startedAt       DateTime?
      completedAt     DateTime?

      createdAt       DateTime  @default(now())
      updatedAt       DateTime  @updatedAt
      createdBy       String?
      updatedBy       String?
    }
    ```

    Create src/lib/db.ts - Prisma singleton:
    ```typescript
    import { PrismaClient } from '@prisma/client';

    const globalForPrisma = globalThis as unknown as {
      prisma: PrismaClient | undefined;
    };

    export const prisma = globalForPrisma.prisma ?? new PrismaClient({
      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
    });

    if (process.env.NODE_ENV !== 'production') {
      globalForPrisma.prisma = prisma;
    }
    ```

    Create src/types/index.ts with shared types:
    ```typescript
    import type { Role, Gender, EmploymentStatus, DocumentType } from '@prisma/client';

    export type { Role, Gender, EmploymentStatus, DocumentType };

    // Re-export for convenience
    export const ROLES = ['ADMIN', 'MANAGER', 'EMPLOYEE'] as const;
    export const GENDERS = ['MALE', 'FEMALE', 'OTHER'] as const;
    export const EMPLOYMENT_STATUSES = ['ACTIVE', 'INACTIVE', 'TERMINATED', 'ON_NOTICE'] as const;
    export const DOCUMENT_TYPES = [
      'OFFER_LETTER', 'ID_PROOF', 'ADDRESS_PROOF', 'EDUCATION_CERT',
      'EXPERIENCE_CERT', 'PAN_CARD', 'AADHAAR_CARD', 'BANK_PROOF', 'OTHER'
    ] as const;

    // Audit info type for all entities
    export interface AuditInfo {
      createdAt: Date;
      updatedAt: Date;
      createdBy: string | null;
      updatedBy: string | null;
    }
    ```

    Run `pnpm prisma generate` to generate the Prisma client.
  </action>
  <verify>
    Run `pnpm prisma validate` - should pass with no errors.
    Run `pnpm prisma generate` - should generate client successfully.
    Check that src/lib/db.ts imports work: `pnpm tsc --noEmit`
  </verify>
  <done>
    Prisma schema has all models (User, Employee, Department, Designation, Document, SalaryRecord, LeaveBalance, ImportBatch).
    All models have audit columns. Prisma client generates successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PII encryption utilities</name>
  <files>
    src/lib/encryption.ts
    src/lib/encryption.test.ts
  </files>
  <action>
    Create src/lib/encryption.ts for PII field encryption (PAN, Aadhaar, bank account):

    ```typescript
    import { createCipheriv, createDecipheriv, randomBytes, scryptSync } from 'crypto';

    const ALGORITHM = 'aes-256-gcm';
    const IV_LENGTH = 16;
    const AUTH_TAG_LENGTH = 16;
    const SALT_LENGTH = 32;

    function getKey(): Buffer {
      const key = process.env.ENCRYPTION_KEY;
      if (!key) {
        throw new Error('ENCRYPTION_KEY environment variable is not set');
      }
      // Derive a 32-byte key from the provided key using scrypt
      return scryptSync(key, 'shreehr-salt', 32);
    }

    /**
     * Encrypts a plaintext string using AES-256-GCM.
     * Returns a base64-encoded string containing IV + authTag + ciphertext.
     */
    export function encrypt(plaintext: string): string {
      if (!plaintext) return '';

      const key = getKey();
      const iv = randomBytes(IV_LENGTH);
      const cipher = createCipheriv(ALGORITHM, key, iv);

      let encrypted = cipher.update(plaintext, 'utf8', 'hex');
      encrypted += cipher.final('hex');

      const authTag = cipher.getAuthTag();

      // Combine IV + authTag + ciphertext
      const combined = Buffer.concat([
        iv,
        authTag,
        Buffer.from(encrypted, 'hex')
      ]);

      return combined.toString('base64');
    }

    /**
     * Decrypts a base64-encoded encrypted string.
     * Expects format: IV (16 bytes) + authTag (16 bytes) + ciphertext
     */
    export function decrypt(encryptedData: string): string {
      if (!encryptedData) return '';

      const key = getKey();
      const combined = Buffer.from(encryptedData, 'base64');

      // Extract components
      const iv = combined.subarray(0, IV_LENGTH);
      const authTag = combined.subarray(IV_LENGTH, IV_LENGTH + AUTH_TAG_LENGTH);
      const ciphertext = combined.subarray(IV_LENGTH + AUTH_TAG_LENGTH);

      const decipher = createDecipheriv(ALGORITHM, key, iv);
      decipher.setAuthTag(authTag);

      let decrypted = decipher.update(ciphertext.toString('hex'), 'hex', 'utf8');
      decrypted += decipher.final('utf8');

      return decrypted;
    }

    /**
     * Masks a PAN number for display: ABCDE1234F -> ABCDE****F
     */
    export function maskPan(pan: string): string {
      if (!pan || pan.length !== 10) return '**********';
      return `${pan.slice(0, 5)}****${pan.slice(9)}`;
    }

    /**
     * Masks an Aadhaar number for display: 123456789012 -> XXXX XXXX 9012
     */
    export function maskAadhaar(aadhaar: string): string {
      if (!aadhaar || aadhaar.length !== 12) return 'XXXX XXXX XXXX';
      return `XXXX XXXX ${aadhaar.slice(8)}`;
    }

    /**
     * Masks a bank account number for display: 12345678901234 -> XXXXXX1234
     */
    export function maskBankAccount(account: string): string {
      if (!account || account.length < 4) return 'XXXX';
      return `${'X'.repeat(account.length - 4)}${account.slice(-4)}`;
    }
    ```

    Create src/lib/encryption.test.ts:
    ```typescript
    import { describe, it, expect, beforeAll } from 'vitest';
    import { encrypt, decrypt, maskPan, maskAadhaar, maskBankAccount } from './encryption';

    beforeAll(() => {
      // Set test encryption key
      process.env.ENCRYPTION_KEY = 'test-encryption-key-for-testing-only';
    });

    describe('encryption', () => {
      it('encrypts and decrypts a string correctly', () => {
        const original = 'ABCDE1234F';
        const encrypted = encrypt(original);
        const decrypted = decrypt(encrypted);

        expect(encrypted).not.toBe(original);
        expect(decrypted).toBe(original);
      });

      it('produces different ciphertext for same input (due to random IV)', () => {
        const original = 'test-data';
        const encrypted1 = encrypt(original);
        const encrypted2 = encrypt(original);

        expect(encrypted1).not.toBe(encrypted2);
        expect(decrypt(encrypted1)).toBe(original);
        expect(decrypt(encrypted2)).toBe(original);
      });

      it('handles empty strings', () => {
        expect(encrypt('')).toBe('');
        expect(decrypt('')).toBe('');
      });
    });

    describe('masking', () => {
      it('masks PAN correctly', () => {
        expect(maskPan('ABCDE1234F')).toBe('ABCDE****F');
        expect(maskPan('invalid')).toBe('**********');
      });

      it('masks Aadhaar correctly', () => {
        expect(maskAadhaar('123456789012')).toBe('XXXX XXXX 9012');
        expect(maskAadhaar('invalid')).toBe('XXXX XXXX XXXX');
      });

      it('masks bank account correctly', () => {
        expect(maskBankAccount('12345678901234')).toBe('XXXXXXXXXX1234');
        expect(maskBankAccount('1234')).toBe('1234');
      });
    });
    ```

    Create vitest.config.ts at project root:
    ```typescript
    import { defineConfig } from 'vitest/config';
    import react from '@vitejs/plugin-react';
    import { resolve } from 'path';

    export default defineConfig({
      plugins: [react()],
      test: {
        environment: 'jsdom',
        globals: true,
      },
      resolve: {
        alias: {
          '@': resolve(__dirname, './src'),
        },
      },
    });
    ```
  </action>
  <verify>
    Run `pnpm test` - all encryption tests should pass.
    Run `pnpm tsc --noEmit` - no TypeScript errors.
  </verify>
  <done>
    Encryption utilities working with AES-256-GCM. Tests pass for encrypt/decrypt and masking functions.
  </done>
</task>

</tasks>

<verification>
1. `pnpm dev` starts Next.js on localhost:3000
2. `pnpm lint` (Biome) passes
3. `pnpm prisma validate` passes
4. `pnpm prisma generate` succeeds
5. `pnpm test` passes (encryption tests)
6. `pnpm tsc --noEmit` has no errors
</verification>

<success_criteria>
- Next.js 16 project initialized with TypeScript, Tailwind, App Router
- Biome configured as linter/formatter (not ESLint)
- Prisma schema contains: User, Employee, Department, Designation, Document, SalaryRecord, LeaveBalance, ImportBatch
- All models have audit columns (createdAt, updatedAt, createdBy, updatedBy)
- Encryption utilities work for PAN, Aadhaar, bank account
- Tests pass for encryption module
- .env.example documents all required environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
