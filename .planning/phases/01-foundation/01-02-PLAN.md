---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/api/auth/[...nextauth]/route.ts
  - src/lib/auth.ts
  - src/lib/auth-options.ts
  - src/middleware.ts
  - src/components/auth/login-form.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can log in with email and password"
    - "Unauthenticated users are redirected to login page"
    - "Session persists across page refreshes"
    - "Role is stored in session (ADMIN, MANAGER, EMPLOYEE)"
    - "Protected routes check authentication before rendering"
  artifacts:
    - path: "src/lib/auth-options.ts"
      provides: "NextAuth configuration"
      exports: ["authOptions"]
    - path: "src/app/api/auth/[...nextauth]/route.ts"
      provides: "Auth API routes"
      exports: ["GET", "POST"]
    - path: "src/middleware.ts"
      provides: "Route protection middleware"
      contains: "matcher"
    - path: "src/components/auth/login-form.tsx"
      provides: "Login form component"
      min_lines: 50
  key_links:
    - from: "src/components/auth/login-form.tsx"
      to: "next-auth/react"
      via: "signIn function"
      pattern: "signIn.*credentials"
    - from: "src/middleware.ts"
      to: "next-auth"
      via: "auth function"
      pattern: "auth|getToken"
---

<objective>
Implement NextAuth v5 authentication with credentials provider, role-based sessions, and protected route middleware.

Purpose: Secure the application with authentication and establish role-based access control (Admin/Manager/Employee) that other features will build upon.

Output: Working login flow, session management, protected routes, and authentication utilities.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@prisma/schema.prisma
@src/lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure NextAuth v5 with credentials provider</name>
  <files>
    src/lib/auth-options.ts
    src/lib/auth.ts
    src/app/api/auth/[...nextauth]/route.ts
    package.json
  </files>
  <action>
    Install NextAuth v5 and bcrypt:
    ```bash
    pnpm add next-auth@beta @auth/prisma-adapter bcrypt
    pnpm add -D @types/bcrypt
    ```

    Create src/lib/auth-options.ts:
    ```typescript
    import type { NextAuthConfig } from 'next-auth';
    import Credentials from 'next-auth/providers/credentials';
    import bcrypt from 'bcrypt';
    import { prisma } from './db';

    export const authOptions: NextAuthConfig = {
      providers: [
        Credentials({
          name: 'credentials',
          credentials: {
            email: { label: 'Email', type: 'email' },
            password: { label: 'Password', type: 'password' },
          },
          async authorize(credentials) {
            if (!credentials?.email || !credentials?.password) {
              return null;
            }

            const user = await prisma.user.findUnique({
              where: { email: credentials.email as string },
              include: { employee: true },
            });

            if (!user || !user.isActive) {
              return null;
            }

            const isValid = await bcrypt.compare(
              credentials.password as string,
              user.passwordHash
            );

            if (!isValid) {
              return null;
            }

            // Update last login
            await prisma.user.update({
              where: { id: user.id },
              data: { lastLoginAt: new Date() },
            });

            return {
              id: user.id,
              email: user.email,
              role: user.role,
              employeeId: user.employeeId,
              name: user.employee
                ? `${user.employee.firstName} ${user.employee.lastName}`
                : user.email,
            };
          },
        }),
      ],
      callbacks: {
        async jwt({ token, user }) {
          if (user) {
            token.role = user.role;
            token.employeeId = user.employeeId;
          }
          return token;
        },
        async session({ session, token }) {
          if (session.user) {
            session.user.id = token.sub as string;
            session.user.role = token.role as string;
            session.user.employeeId = token.employeeId as string | null;
          }
          return session;
        },
      },
      pages: {
        signIn: '/login',
        error: '/login',
      },
      session: {
        strategy: 'jwt',
        maxAge: 24 * 60 * 60, // 24 hours
      },
    };
    ```

    Create src/lib/auth.ts:
    ```typescript
    import NextAuth from 'next-auth';
    import { authOptions } from './auth-options';

    export const { handlers, auth, signIn, signOut } = NextAuth(authOptions);

    // Type augmentation for session
    declare module 'next-auth' {
      interface Session {
        user: {
          id: string;
          email: string;
          name?: string | null;
          role: string;
          employeeId: string | null;
        };
      }

      interface User {
        role: string;
        employeeId: string | null;
      }
    }

    declare module '@auth/core/jwt' {
      interface JWT {
        role: string;
        employeeId: string | null;
      }
    }
    ```

    Create src/app/api/auth/[...nextauth]/route.ts:
    ```typescript
    import { handlers } from '@/lib/auth';

    export const { GET, POST } = handlers;
    ```

    Create a seed script to create initial admin user - src/lib/seed-admin.ts:
    ```typescript
    import bcrypt from 'bcrypt';
    import { prisma } from './db';

    async function seedAdmin() {
      const email = 'admin@shreehr.local';
      const password = 'admin123'; // Change in production!

      const existingUser = await prisma.user.findUnique({
        where: { email },
      });

      if (existingUser) {
        console.log('Admin user already exists');
        return;
      }

      const passwordHash = await bcrypt.hash(password, 12);

      await prisma.user.create({
        data: {
          email,
          passwordHash,
          role: 'ADMIN',
          isActive: true,
        },
      });

      console.log('Admin user created:', email);
      console.log('Password:', password);
    }

    seedAdmin()
      .catch(console.error)
      .finally(() => prisma.$disconnect());
    ```

    Add seed script to package.json:
    ```json
    "scripts": {
      "db:seed": "npx tsx src/lib/seed-admin.ts"
    }
    ```
  </action>
  <verify>
    TypeScript compiles: `pnpm tsc --noEmit`
    API route file exists and exports GET, POST
  </verify>
  <done>
    NextAuth v5 configured with credentials provider. JWT strategy with role in token.
    Admin seed script ready. Type augmentation for session includes role and employeeId.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login page and protected route middleware</name>
  <files>
    src/middleware.ts
    src/components/auth/login-form.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/layout.tsx
    src/components/ui/button.tsx
    src/components/ui/input.tsx
    src/components/ui/card.tsx
    src/components/ui/label.tsx
  </files>
  <action>
    Install shadcn/ui CLI and add required components:
    ```bash
    pnpm dlx shadcn@latest init -d
    pnpm dlx shadcn@latest add button input card label
    ```

    Create src/middleware.ts for route protection:
    ```typescript
    import { auth } from '@/lib/auth';
    import { NextResponse } from 'next/server';

    export default auth((req) => {
      const { nextUrl, auth: session } = req;
      const isLoggedIn = !!session?.user;
      const isAuthRoute = nextUrl.pathname.startsWith('/login');
      const isApiRoute = nextUrl.pathname.startsWith('/api');
      const isPublicRoute = nextUrl.pathname === '/';

      // Allow API routes (they handle their own auth)
      if (isApiRoute) {
        return NextResponse.next();
      }

      // Redirect logged-in users away from login page
      if (isAuthRoute && isLoggedIn) {
        return NextResponse.redirect(new URL('/dashboard', nextUrl));
      }

      // Redirect unauthenticated users to login (except public routes)
      if (!isLoggedIn && !isAuthRoute && !isPublicRoute) {
        const loginUrl = new URL('/login', nextUrl);
        loginUrl.searchParams.set('callbackUrl', nextUrl.pathname);
        return NextResponse.redirect(loginUrl);
      }

      return NextResponse.next();
    });

    export const config = {
      matcher: [
        /*
         * Match all request paths except:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico, sitemap.xml, robots.txt (metadata files)
         */
        '/((?!_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)',
      ],
    };
    ```

    Create src/app/(auth)/layout.tsx:
    ```typescript
    export default function AuthLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          {children}
        </div>
      );
    }
    ```

    Create src/components/auth/login-form.tsx:
    ```typescript
    'use client';

    import { useState } from 'react';
    import { signIn } from 'next-auth/react';
    import { useRouter, useSearchParams } from 'next/navigation';
    import { Button } from '@/components/ui/button';
    import { Input } from '@/components/ui/input';
    import { Label } from '@/components/ui/label';
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

    export function LoginForm() {
      const router = useRouter();
      const searchParams = useSearchParams();
      const callbackUrl = searchParams.get('callbackUrl') || '/dashboard';

      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      async function onSubmit(e: React.FormEvent) {
        e.preventDefault();
        setError('');
        setIsLoading(true);

        try {
          const result = await signIn('credentials', {
            email,
            password,
            redirect: false,
          });

          if (result?.error) {
            setError('Invalid email or password');
            return;
          }

          router.push(callbackUrl);
          router.refresh();
        } catch (err) {
          setError('An error occurred. Please try again.');
        } finally {
          setIsLoading(false);
        }
      }

      return (
        <Card className="w-full max-w-md">
          <CardHeader className="space-y-1">
            <CardTitle className="text-2xl font-bold">ShreeHR</CardTitle>
            <CardDescription>
              Enter your credentials to access the HR portal
            </CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={onSubmit} className="space-y-4">
              {error && (
                <div className="p-3 text-sm text-red-600 bg-red-50 rounded-md">
                  {error}
                </div>
              )}

              <div className="space-y-2">
                <Label htmlFor="email">Email</Label>
                <Input
                  id="email"
                  type="email"
                  placeholder="admin@shreehr.local"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  disabled={isLoading}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="password">Password</Label>
                <Input
                  id="password"
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  disabled={isLoading}
                />
              </div>

              <Button type="submit" className="w-full" disabled={isLoading}>
                {isLoading ? 'Signing in...' : 'Sign in'}
              </Button>
            </form>
          </CardContent>
        </Card>
      );
    }
    ```

    Create src/app/(auth)/login/page.tsx:
    ```typescript
    import { Suspense } from 'react';
    import { LoginForm } from '@/components/auth/login-form';

    export default function LoginPage() {
      return (
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
      );
    }
    ```
  </action>
  <verify>
    `pnpm dev` - visit /login, form renders
    `pnpm tsc --noEmit` - no TypeScript errors
  </verify>
  <done>
    Login page with form component. Middleware protects routes and redirects to /login.
    shadcn/ui components installed (Button, Input, Card, Label).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create protected dashboard shell</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/page.tsx
    src/components/layout/sidebar.tsx
    src/components/layout/header.tsx
    src/lib/utils.ts
  </files>
  <action>
    Create src/app/(dashboard)/layout.tsx:
    ```typescript
    import { auth } from '@/lib/auth';
    import { redirect } from 'next/navigation';
    import { Sidebar } from '@/components/layout/sidebar';
    import { Header } from '@/components/layout/header';

    export default async function DashboardLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      const session = await auth();

      if (!session?.user) {
        redirect('/login');
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <Sidebar role={session.user.role} />
          <div className="lg:pl-64">
            <Header user={session.user} />
            <main className="p-6">{children}</main>
          </div>
        </div>
      );
    }
    ```

    Create src/components/layout/sidebar.tsx:
    ```typescript
    'use client';

    import Link from 'next/link';
    import { usePathname } from 'next/navigation';
    import { cn } from '@/lib/utils';
    import {
      Users,
      Building2,
      FileText,
      Upload,
      Home,
      Settings,
    } from 'lucide-react';

    interface SidebarProps {
      role: string;
    }

    const navigation = [
      { name: 'Dashboard', href: '/dashboard', icon: Home, roles: ['ADMIN', 'MANAGER', 'EMPLOYEE'] },
      { name: 'Employees', href: '/dashboard/employees', icon: Users, roles: ['ADMIN', 'MANAGER'] },
      { name: 'Departments', href: '/dashboard/departments', icon: Building2, roles: ['ADMIN'] },
      { name: 'Documents', href: '/dashboard/documents', icon: FileText, roles: ['ADMIN', 'MANAGER', 'EMPLOYEE'] },
      { name: 'Import Data', href: '/dashboard/import', icon: Upload, roles: ['ADMIN'] },
      { name: 'Settings', href: '/dashboard/settings', icon: Settings, roles: ['ADMIN'] },
    ];

    export function Sidebar({ role }: SidebarProps) {
      const pathname = usePathname();

      const filteredNav = navigation.filter((item) => item.roles.includes(role));

      return (
        <div className="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-64 lg:flex-col">
          <div className="flex grow flex-col gap-y-5 overflow-y-auto border-r border-gray-200 bg-white px-6 pb-4">
            <div className="flex h-16 shrink-0 items-center">
              <span className="text-xl font-bold text-gray-900">ShreeHR</span>
            </div>
            <nav className="flex flex-1 flex-col">
              <ul className="flex flex-1 flex-col gap-y-1">
                {filteredNav.map((item) => {
                  const isActive = pathname === item.href || pathname.startsWith(`${item.href}/`);
                  return (
                    <li key={item.name}>
                      <Link
                        href={item.href}
                        className={cn(
                          'group flex gap-x-3 rounded-md p-2 text-sm font-medium',
                          isActive
                            ? 'bg-gray-100 text-gray-900'
                            : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                        )}
                      >
                        <item.icon className="h-5 w-5 shrink-0" />
                        {item.name}
                      </Link>
                    </li>
                  );
                })}
              </ul>
            </nav>
          </div>
        </div>
      );
    }
    ```

    Install lucide-react for icons:
    ```bash
    pnpm add lucide-react
    ```

    Create src/components/layout/header.tsx:
    ```typescript
    'use client';

    import { signOut } from 'next-auth/react';
    import { Button } from '@/components/ui/button';
    import { LogOut, User } from 'lucide-react';

    interface HeaderProps {
      user: {
        name?: string | null;
        email: string;
        role: string;
      };
    }

    export function Header({ user }: HeaderProps) {
      return (
        <header className="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-200 bg-white px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8">
          <div className="flex flex-1 gap-x-4 self-stretch lg:gap-x-6">
            <div className="flex flex-1" />
            <div className="flex items-center gap-x-4 lg:gap-x-6">
              <div className="flex items-center gap-x-3">
                <div className="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100">
                  <User className="h-4 w-4 text-gray-600" />
                </div>
                <div className="hidden sm:block">
                  <p className="text-sm font-medium text-gray-900">
                    {user.name || user.email}
                  </p>
                  <p className="text-xs text-gray-500">{user.role}</p>
                </div>
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={() => signOut({ callbackUrl: '/login' })}
              >
                <LogOut className="h-4 w-4" />
                <span className="ml-2 hidden sm:inline">Sign out</span>
              </Button>
            </div>
          </div>
        </header>
      );
    }
    ```

    Create src/lib/utils.ts (if not created by shadcn):
    ```typescript
    import { type ClassValue, clsx } from 'clsx';
    import { twMerge } from 'tailwind-merge';

    export function cn(...inputs: ClassValue[]) {
      return twMerge(clsx(inputs));
    }
    ```

    Install clsx and tailwind-merge if not already:
    ```bash
    pnpm add clsx tailwind-merge
    ```

    Create src/app/(dashboard)/page.tsx:
    ```typescript
    import { auth } from '@/lib/auth';
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { Users, Building2, FileText } from 'lucide-react';

    export default async function DashboardPage() {
      const session = await auth();

      return (
        <div className="space-y-6">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
            <p className="text-gray-600">
              Welcome back, {session?.user?.name || session?.user?.email}
            </p>
          </div>

          <div className="grid gap-4 md:grid-cols-3">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Total Employees</CardTitle>
                <Users className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">0</div>
                <p className="text-xs text-muted-foreground">
                  No employees yet
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Departments</CardTitle>
                <Building2 className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">0</div>
                <p className="text-xs text-muted-foreground">
                  No departments yet
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Documents</CardTitle>
                <FileText className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">0</div>
                <p className="text-xs text-muted-foreground">
                  No documents yet
                </p>
              </CardContent>
            </Card>
          </div>

          {session?.user?.role === 'ADMIN' && (
            <Card>
              <CardHeader>
                <CardTitle>Getting Started</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2 text-sm text-gray-600">
                <p>1. Set up departments and designations</p>
                <p>2. Import employee data from Keka or add manually</p>
                <p>3. Upload employee documents</p>
              </CardContent>
            </Card>
          )}
        </div>
      );
    }
    ```

    Update src/app/page.tsx to redirect to dashboard:
    ```typescript
    import { redirect } from 'next/navigation';
    import { auth } from '@/lib/auth';

    export default async function HomePage() {
      const session = await auth();

      if (session?.user) {
        redirect('/dashboard');
      }

      redirect('/login');
    }
    ```
  </action>
  <verify>
    1. Start PostgreSQL and run `pnpm prisma db push`
    2. Run `pnpm db:seed` to create admin user
    3. `pnpm dev` and visit http://localhost:3000
    4. Should redirect to /login
    5. Log in with admin@shreehr.local / admin123
    6. Should see dashboard with sidebar
    7. Sign out button works
  </verify>
  <done>
    Protected dashboard shell with sidebar navigation (role-filtered), header with user info and sign out.
    Root page redirects to dashboard or login based on auth state.
  </done>
</task>

</tasks>

<verification>
1. Visit / -> redirects to /login (unauthenticated)
2. Login with admin@shreehr.local / admin123 -> redirects to /dashboard
3. Dashboard shows sidebar with role-appropriate navigation
4. Sign out returns to /login
5. Direct visit to /dashboard when logged out -> redirects to /login
6. Session persists on page refresh
</verification>

<success_criteria>
- NextAuth v5 with credentials provider working
- JWT session with role (ADMIN/MANAGER/EMPLOYEE) in token
- Middleware protects all /dashboard routes
- Login form validates and shows errors
- Dashboard shell with role-based sidebar navigation
- Header shows user info and sign out
- Admin seed script creates initial user
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
