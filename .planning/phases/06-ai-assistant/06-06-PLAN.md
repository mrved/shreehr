---
phase: 06-ai-assistant
plan: 06
type: execute
wave: 4
depends_on: ["06-01", "06-02", "06-03", "06-04", "06-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Employee can ask about leave balance and get accurate response"
    - "Employee can ask about company policies and get relevant answers"
    - "Chat respects RBAC - employee cannot see other employees' data"
    - "Conversation history persists across page refreshes"
    - "Admin can create policy documents that become searchable"
---

<objective>
Verify the complete AI Assistant functionality end-to-end including data queries, policy search, RBAC enforcement, and conversation persistence.

Purpose: Ensure all Phase 6 requirements are met and the AI assistant is working correctly before marking phase complete.
Output: Verified working AI chat system with all success criteria met.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify AI Assistant End-to-End</name>
  <what-built>
Complete AI Assistant with:
- Chat API with streaming responses and tool calling
- Employee data tools (leave, attendance, salary, loans)
- Policy search via RAG (Qdrant vector database)
- Conversation history persistence
- Chat UI in employee portal
- Policy management for admins
  </what-built>
  <how-to-verify>

**Prerequisites:**
1. Start all services:
   ```bash
   docker compose up -d  # Redis and Qdrant
   ollama serve          # In separate terminal
   ollama pull llama3.2:3b
   ollama pull nomic-embed-text
   pnpm dev              # Next.js dev server
   ```

2. Run embedding worker (separate terminal):
   ```bash
   npx tsx src/lib/queues/workers/embedding.worker.ts
   ```

**Test 1: Admin Policy Creation**
1. Login as admin user
2. Navigate to /policies (or /dashboard/policies)
3. Click "Add Policy"
4. Create a test policy:
   - Title: "Leave Policy"
   - Category: LEAVE
   - Content: Sample leave policy markdown
5. Verify policy appears in list with "Pending" status
6. Wait for embedding worker to process (status should change to "Completed")

**Test 2: Employee Data Queries**
1. Login as employee user
2. Navigate to /chat
3. Ask: "What is my leave balance?"
4. Verify: Response includes actual leave balance numbers
5. Ask: "Show my attendance for this month"
6. Verify: Response includes attendance summary

**Test 3: Policy Questions (RAG)**
1. In the same chat, ask: "What is the leave policy?"
2. Verify: Response cites the policy document created in Test 1
3. Ask a follow-up: "How many casual leaves do I get?"
4. Verify: Response uses conversation context

**Test 4: RBAC Enforcement**
1. As employee, ask: "Show me [another employee name]'s salary"
2. Verify: Response indicates access denied
3. Login as manager
4. Ask about subordinate's leave balance
5. Verify: Manager can see subordinate data

**Test 5: Conversation Persistence**
1. Note the current conversation
2. Refresh the page
3. Verify: Conversation history is preserved
4. Start a new conversation
5. Verify: Previous conversation appears in sidebar

**Test 6: Mobile Responsiveness**
1. Use browser devtools to simulate mobile device
2. Verify: Chat interface is usable on small screens
3. Verify: Sidebar collapses and can be toggled

  </how-to-verify>
  <resume-signal>
Type one of:
- "approved" - All tests pass, phase complete
- "issues: [description]" - Describe what's not working
  </resume-signal>
</task>

</tasks>

<verification>
Phase 6 requirements verification:

| Requirement | Test | Expected Result |
|-------------|------|-----------------|
| AI-01: HR queries via chat | Test 2 | Employee can ask questions |
| AI-02: Employee-specific data | Test 2 | Retrieves real data from DB |
| AI-03: Policy questions | Test 3 | Can ask about policies |
| AI-04: RAG search | Test 3 | Searches policy documents |
| AI-05: RBAC enforcement | Test 4 | Role-based access respected |
| AI-06: Conversation history | Test 5 | History persists |
</verification>

<success_criteria>
All tests pass:
- [ ] Admin can create policy documents
- [ ] Embedding worker processes documents
- [ ] Employee can query personal data
- [ ] Employee can ask policy questions
- [ ] RBAC prevents unauthorized access
- [ ] Conversation history persists
- [ ] Mobile UI is functional
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-assistant/06-06-SUMMARY.md`
</output>
