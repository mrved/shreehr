# Plan 07-02: Security Hardening

## Objective
Implement centralized RBAC middleware, audit logging for sensitive operations, and PII access tracking.

## Context
@file:src/lib/auth.ts
@file:src/middleware.ts
@file:docs/research/SECURITY-TESTDATA-RESEARCH.md

## Tasks

### Task 1: Create Audit Log Schema
**Type:** auto

**Files:**
- `prisma/schema.prisma` (modify)
- `src/lib/audit.ts` (create)

**Action:**
Add AuditLog model:
```prisma
model AuditLog {
  id          String   @id @default(cuid())
  user_id     String?
  action      String   // LOGIN, LOGOUT, VIEW_PII, TOOL_EXEC, etc.
  resource    String   // Employee, Payroll, etc.
  resource_id String?
  details     Json?    // Additional context
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())
  
  user User? @relation(fields: [user_id], references: [id])
  
  @@index([user_id])
  @@index([action])
  @@index([created_at])
  @@map("audit_logs")
}
```

Create `audit.ts` with:
- `logAudit(action, resource, resourceId?, details?)` function
- Automatic user extraction from session

**Verify:**
```bash
npx prisma db push
```

**Done:** AuditLog table created, logging utility ready

### Task 2: Create RBAC Utility
**Type:** auto

**Files:**
- `src/lib/rbac.ts` (create)

**Action:**
Create centralized permission checking:

```typescript
export const PERMISSIONS = {
  // Employee data
  'employee:read:own': ['EMPLOYEE', 'HR_MANAGER', 'PAYROLL_MANAGER', 'ADMIN', 'SUPER_ADMIN'],
  'employee:read:team': ['HR_MANAGER', 'ADMIN', 'SUPER_ADMIN'],
  'employee:read:all': ['ADMIN', 'SUPER_ADMIN'],
  'employee:write': ['ADMIN', 'SUPER_ADMIN'],
  
  // Payroll
  'payroll:read:own': ['EMPLOYEE', 'HR_MANAGER', 'PAYROLL_MANAGER', 'ADMIN', 'SUPER_ADMIN'],
  'payroll:read:all': ['PAYROLL_MANAGER', 'ADMIN', 'SUPER_ADMIN'],
  'payroll:run': ['PAYROLL_MANAGER', 'ADMIN', 'SUPER_ADMIN'],
  
  // Leave
  'leave:approve:team': ['HR_MANAGER', 'ADMIN', 'SUPER_ADMIN'],
  'leave:approve:all': ['ADMIN', 'SUPER_ADMIN'],
  
  // Admin
  'admin:settings': ['ADMIN', 'SUPER_ADMIN'],
  'admin:audit': ['SUPER_ADMIN'],
  'admin:mcp': ['SUPER_ADMIN'],
} as const;

export function hasPermission(role: string, permission: keyof typeof PERMISSIONS): boolean
export function requirePermission(session: Session, permission: string): void // throws if denied
```

**Verify:**
TypeScript compiles, unit tests pass

**Done:** RBAC utility with typed permissions

### Task 3: Add Audit Logging to AI Tools
**Type:** auto

**Files:**
- `src/app/api/chat/route.ts` (modify)

**Action:**
Wrap each AI tool execution with audit logging:
- Log tool name, parameters (sanitized), user, timestamp
- Log PII access when salary/bank details requested
- Don't log conversation content (privacy)

**Verify:**
Make AI query, check audit_logs table has entry

**Done:** AI tool executions logged

## Success Criteria
1. AuditLog table exists with proper indexes
2. RBAC utility provides typed permission checks
3. AI tool executions create audit entries
4. PII access (salary, bank) logged separately
