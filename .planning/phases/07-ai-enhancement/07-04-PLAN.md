# Plan 07-04: MCP for SUPER_ADMIN Analytics

## Objective
Enable PostgreSQL MCP for SUPER_ADMIN users only, allowing natural language analytics queries.

## Context
@file:src/app/api/chat/route.ts
@file:src/lib/rbac.ts
@file:docs/research/AI-ASSISTANT-RESEARCH.md

## Tasks

### Task 1: Install MCP Packages
**Type:** auto

**Files:**
- `package.json` (modify)

**Action:**
```bash
pnpm add @anthropic-ai/mcp @anthropic-ai/mcp-postgres
```

Note: MCP only works with Claude, not Ollama.

**Verify:**
```bash
pnpm list @anthropic-ai/mcp
```

**Done:** MCP packages installed

### Task 2: Create MCP Configuration
**Type:** auto

**Files:**
- `src/lib/ai/mcp-config.ts` (create)

**Action:**
Create MCP configuration for PostgreSQL:

```typescript
import { MCPClient } from '@anthropic-ai/mcp';
import { PostgresMCPServer } from '@anthropic-ai/mcp-postgres';

export async function createMCPClient() {
  const server = new PostgresMCPServer({
    connectionString: process.env.DATABASE_URL,
    // Restrict to read-only for safety
    readOnly: true,
    // Exclude sensitive tables
    excludeTables: ['users', 'sessions', 'verification_tokens'],
    // Mask PII columns
    maskColumns: {
      employees: ['pan_number', 'aadhaar_number', 'bank_account_number'],
    },
  });
  
  return new MCPClient({ server });
}
```

**Verify:**
TypeScript compiles

**Done:** MCP configured with safety restrictions

### Task 3: Add MCP to Chat Route (SUPER_ADMIN only)
**Type:** auto

**Files:**
- `src/app/api/chat/route.ts` (modify)

**Action:**
Add MCP tools conditionally for SUPER_ADMIN:

```typescript
// In chat route
const tools = [...baseTools];

if (session.user.role === 'SUPER_ADMIN') {
  const mcpClient = await createMCPClient();
  const mcpTools = await mcpClient.getTools();
  tools.push(...mcpTools);
  
  // Log MCP usage for audit
  await logAudit('MCP_ENABLED', 'Chat', null, { userId: session.user.id });
}
```

**Verify:**
- SUPER_ADMIN can run: "Show me total payroll by department"
- EMPLOYEE cannot access MCP queries

**Done:** MCP available for SUPER_ADMIN only

### Task 4: Add Analytics Prompt Enhancements
**Type:** auto

**Files:**
- `src/lib/ai/prompts.ts` (modify)

**Action:**
Add SUPER_ADMIN-specific system prompt additions:

```typescript
const SUPER_ADMIN_PROMPT = `
You have access to direct database queries via MCP.
Use this for analytics questions like:
- "Total salary expense by department"
- "Employee count by state"
- "Leave trends over time"

Always use aggregations. Never return individual PII.
`;
```

**Verify:**
SUPER_ADMIN gets enhanced prompt

**Done:** Analytics prompts added

## Success Criteria
1. MCP installed and configured
2. PostgreSQL connection read-only
3. Sensitive tables/columns excluded
4. Only SUPER_ADMIN can access MCP
5. MCP usage logged in audit
