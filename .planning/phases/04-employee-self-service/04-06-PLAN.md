---
phase: 04-employee-self-service
plan: 06
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/app/(employee)/investments/page.tsx
  - src/app/(employee)/investments/declare/page.tsx
  - src/components/employee/investment-declaration-form.tsx
  - src/components/employee/investment-summary.tsx
autonomous: true

must_haves:
  truths:
    - "Employee can view their investment declarations"
    - "Employee can create new declaration for current financial year"
    - "Form validates 80C total does not exceed Rs.1,50,000"
    - "Employee sees real-time total as they fill 80C fields"
  artifacts:
    - path: "src/app/(employee)/investments/page.tsx"
      provides: "Investment declarations list page"
      min_lines: 40
    - path: "src/app/(employee)/investments/declare/page.tsx"
      provides: "Declaration form page"
      min_lines: 30
    - path: "src/components/employee/investment-declaration-form.tsx"
      provides: "Multi-section investment form"
      min_lines: 150
    - path: "src/components/employee/investment-summary.tsx"
      provides: "Declaration summary component"
      min_lines: 40
  key_links:
    - from: "src/components/employee/investment-declaration-form.tsx"
      to: "/api/investments"
      via: "Submit declaration"
      pattern: "api/investments"
    - from: "src/components/employee/investment-declaration-form.tsx"
      to: "src/lib/validations/investment.ts"
      via: "Client-side validation"
      pattern: "investment.*Schema"
---

<objective>
Create mobile-first investment declaration UI for 80C, 80D, and HRA tax-saving declarations.

Purpose: Enable employees to declare investments for TDS calculation through an intuitive form interface.
Output: Investment declaration pages with multi-section form and real-time validation.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employee-self-service/04-RESEARCH.md

# Dependencies from Plan 02
@src/app/api/investments/route.ts
@src/lib/validations/investment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create investment declaration form component</name>
  <files>src/components/employee/investment-declaration-form.tsx, src/components/employee/investment-summary.tsx</files>
  <action>
1. Create `src/components/employee/investment-summary.tsx`:
   - Props: { declaration: InvestmentDeclaration }
   - Display sections: 80C, 80D, HRA, Other
   - Show each field with label and amount
   - Calculate and show section totals
   - Show overall tax savings estimate (rough calculation)
   - Status badge (DRAFT, SUBMITTED, VERIFIED)
   - Mobile: accordion sections, Desktop: side-by-side

2. Create `src/components/employee/investment-declaration-form.tsx`:
   - Client component using React Hook Form + Zod
   - Multi-section form with collapsible sections:

   Section 80C (max Rs.1,50,000):
   - PPF contribution
   - ELSS mutual funds
   - Life insurance premium
   - Children tuition fees (max 2 children)
   - NPS contribution
   - Home loan principal
   - Sukanya Samriddhi
   - Other 80C
   - **Real-time total** with remaining limit shown
   - Warning when total exceeds limit

   Section 80D (Health Insurance):
   - Self & family premium (max Rs.25,000)
   - Parents premium (max Rs.50,000 if senior)
   - Preventive health checkup (max Rs.5,000)

   Section HRA (House Rent):
   - Monthly rent amount
   - Landlord name
   - Landlord PAN (required if annual rent > Rs.1L)
   - Rental address
   - Note: PAN required for rent > Rs.8,333/month

   Other Sections:
   - 80E Education loan interest
   - 80G Donations (50%/100% deductible dropdown)
   - Section 24 Home loan interest (max Rs.2L)

   Form behavior:
   - Currency inputs with Rs. prefix
   - Amounts in rupees (convert to paise on submit)
   - useWatch to calculate real-time totals
   - Show calculated tax benefit preview
   - Save as DRAFT button
   - Submit for verification button

Currency input pattern:
```tsx
<div className="relative">
  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">Rs.</span>
  <input
    type="number"
    className="pl-10 w-full"
    {...register('section_80c_ppf', { valueAsNumber: true })}
  />
</div>
```

Real-time total:
```tsx
const section80C = useWatch({ control, name: [
  'section_80c_ppf', 'section_80c_elss', 'section_80c_life_insurance',
  // ... other 80C fields
]});
const total80C = section80C.reduce((sum, val) => sum + (val || 0), 0);
const remaining80C = 150000 - total80C;
```
  </action>
  <verify>`pnpm tsc --noEmit` passes</verify>
  <done>Investment form with real-time 80C total validation ready</done>
</task>

<task type="auto">
  <name>Task 2: Create investment pages</name>
  <files>src/app/(employee)/investments/page.tsx, src/app/(employee)/investments/declare/page.tsx</files>
  <action>
1. Create `src/app/(employee)/investments/page.tsx`:
   - Server component
   - Fetch employee's investment declarations
   - If current FY declaration exists:
     - Show InvestmentSummary component
     - "Edit" button if DRAFT status
     - "View" button if SUBMITTED/VERIFIED
   - If no current FY declaration:
     - Call to action: "Declare Investments"
     - Explain tax benefits
   - Show past FY declarations in list
   - Link to /investments/declare

2. Create `src/app/(employee)/investments/declare/page.tsx`:
   - Server component
   - Calculate current financial year (April to March)
   - Check if declaration exists for current FY
   - If exists and DRAFT: load for editing
   - If exists and SUBMITTED/VERIFIED: redirect to view
   - Pass existing data (if any) to form
   - Render InvestmentDeclarationForm
   - Handle success redirect to /investments

Financial year helper:
```typescript
function getCurrentFinancialYear(): string {
  const today = new Date();
  const month = today.getMonth(); // 0-11
  const year = today.getFullYear();
  // FY starts April (month 3)
  if (month >= 3) {
    return `${year}-${(year + 1).toString().slice(-2)}`; // "2025-26"
  }
  return `${year - 1}-${year.toString().slice(-2)}`; // "2024-25"
}
```

Mobile layout:
- Full-width form sections
- Sticky submit button at bottom
- Collapsible sections to reduce scroll
- Clear section headers with limits shown
  </action>
  <verify>
1. `pnpm tsc --noEmit` passes
2. Visit /investments shows declaration status
3. Visit /investments/declare shows form
  </verify>
  <done>Investment declaration pages complete with form</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. 80C total shows real-time as fields are filled
3. Warning appears when 80C exceeds Rs.1,50,000
4. Form submits successfully
5. Mobile layout works with collapsible sections
</verification>

<success_criteria>
- Investment list page shows current FY declaration
- Form has all 80C, 80D, HRA fields
- Real-time 80C total with remaining limit
- Validation prevents exceeding limits
- Save as draft and submit options
- Mobile-optimized with collapsible sections
</success_criteria>

<output>
After completion, create `.planning/phases/04-employee-self-service/04-06-SUMMARY.md`
</output>
