---
phase: 04-employee-self-service
plan: 06
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/app/(employee)/investments/page.tsx
  - src/app/(employee)/investments/declare/page.tsx
  - src/components/employee/investment-declaration-form.tsx
  - src/components/employee/investment-summary.tsx
  - src/components/employee/document-upload.tsx
  - src/app/api/investments/[declarationId]/documents/route.ts
autonomous: true

must_haves:
  truths:
    - "Employee can view their investment declarations"
    - "Employee can create new declaration for current financial year"
    - "Form validates 80C total does not exceed Rs.1,50,000"
    - "Employee sees real-time total as they fill 80C fields"
    - "Employee can upload supporting documents (investment proofs) for each declaration"
    - "Employee can view and delete uploaded documents"
  artifacts:
    - path: "src/app/(employee)/investments/page.tsx"
      provides: "Investment declarations list page"
      min_lines: 40
    - path: "src/app/(employee)/investments/declare/page.tsx"
      provides: "Declaration form page"
      min_lines: 30
    - path: "src/components/employee/investment-declaration-form.tsx"
      provides: "Multi-section investment form with document upload"
      min_lines: 180
    - path: "src/components/employee/investment-summary.tsx"
      provides: "Declaration summary component"
      min_lines: 40
    - path: "src/components/employee/document-upload.tsx"
      provides: "Investment proof upload component"
      min_lines: 80
    - path: "src/app/api/investments/[declarationId]/documents/route.ts"
      provides: "Document upload API for investment proofs"
      exports: ["GET", "POST", "DELETE"]
  key_links:
    - from: "src/components/employee/investment-declaration-form.tsx"
      to: "/api/investments"
      via: "Submit declaration"
      pattern: "api/investments"
    - from: "src/components/employee/investment-declaration-form.tsx"
      to: "src/lib/validations/investment.ts"
      via: "Client-side validation"
      pattern: "investment.*Schema"
    - from: "src/components/employee/document-upload.tsx"
      to: "/api/investments/[declarationId]/documents"
      via: "Upload investment proofs"
      pattern: "api/investments.*documents"
    - from: "src/app/api/investments/[declarationId]/documents/route.ts"
      to: "src/lib/storage.ts"
      via: "Store uploaded files"
      pattern: "saveFile|getFile"
---

<objective>
Create mobile-first investment declaration UI for 80C, 80D, and HRA tax-saving declarations with document upload for investment proofs.

Purpose: Enable employees to declare investments for TDS calculation through an intuitive form interface and upload supporting documents (PF statements, insurance receipts, rent receipts, etc.).
Output: Investment declaration pages with multi-section form, real-time validation, and document upload functionality.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employee-self-service/04-RESEARCH.md

# Dependencies from Plan 02
@src/app/api/investments/route.ts
@src/lib/validations/investment.ts

# Existing storage infrastructure
@src/lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create investment declaration form component with document upload</name>
  <files>src/components/employee/investment-declaration-form.tsx, src/components/employee/investment-summary.tsx, src/components/employee/document-upload.tsx</files>
  <action>
1. Create `src/components/employee/investment-summary.tsx`:
   - Props: { declaration: InvestmentDeclaration }
   - Display sections: 80C, 80D, HRA, Other
   - Show each field with label and amount
   - Calculate and show section totals
   - Show overall tax savings estimate (rough calculation)
   - Status badge (DRAFT, SUBMITTED, VERIFIED)
   - Mobile: accordion sections, Desktop: side-by-side

2. Create `src/components/employee/document-upload.tsx` (ESS-06):
   - Client component for uploading investment proof documents
   - Props: { declarationId: string, section: string, onUploadComplete: () => void }
   - Features:
     - Drag & drop zone OR file picker button
     - Accept PDF, JPG, PNG (use ALLOWED_MIME_TYPES from @/lib/storage)
     - Max 10MB per file (MAX_FILE_SIZE from @/lib/storage)
     - Multiple file upload support
     - Upload progress indicator
     - List of uploaded files with:
       - File name (truncated if long)
       - File size
       - Delete button
       - View/Download link
     - Grouped by section (80C proofs, 80D proofs, HRA proofs)
   - Upload flow:
     - POST to `/api/investments/${declarationId}/documents`
     - FormData with file + section field
     - Show success toast on complete
     - Show error toast on failure (file too large, wrong type)

Document categories for each section:
- 80C: PF statements, ELSS statements, LIC receipts, tuition fee receipts, NPS statements
- 80D: Health insurance premium receipts, preventive checkup bills
- HRA: Rent receipts, rental agreement, landlord PAN card copy (if rent > Rs.1L/year)
- 80E: Education loan interest certificate
- 80G: Donation receipts with 80G certificate number

3. Create `src/components/employee/investment-declaration-form.tsx`:
   - Client component using React Hook Form + Zod
   - Multi-section form with collapsible sections:

   Section 80C (max Rs.1,50,000):
   - PPF contribution
   - ELSS mutual funds
   - Life insurance premium
   - Children tuition fees (max 2 children)
   - NPS contribution
   - Home loan principal
   - Sukanya Samriddhi
   - Other 80C
   - **Real-time total** with remaining limit shown
   - Warning when total exceeds limit
   - **Document upload section** for 80C proofs (uses DocumentUpload component)

   Section 80D (Health Insurance):
   - Self & family premium (max Rs.25,000)
   - Parents premium (max Rs.50,000 if senior)
   - Preventive health checkup (max Rs.5,000)
   - **Document upload section** for 80D proofs

   Section HRA (House Rent):
   - Monthly rent amount
   - Landlord name
   - Landlord PAN (required if annual rent > Rs.1L)
   - Rental address
   - Note: PAN required for rent > Rs.8,333/month
   - **Document upload section** for rent receipts/agreement

   Other Sections:
   - 80E Education loan interest
   - 80G Donations (50%/100% deductible dropdown)
   - Section 24 Home loan interest (max Rs.2L)
   - **Document upload section** for other proofs

   Form behavior:
   - Currency inputs with Rs. prefix
   - Amounts in rupees (convert to paise on submit)
   - useWatch to calculate real-time totals
   - Show calculated tax benefit preview
   - Save as DRAFT button (can save without documents)
   - Submit for verification button (warns if no documents uploaded)
   - Document upload only enabled after initial save (needs declarationId)

Currency input pattern:
```tsx
<div className="relative">
  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">Rs.</span>
  <input
    type="number"
    className="pl-10 w-full"
    {...register('section_80c_ppf', { valueAsNumber: true })}
  />
</div>
```

Real-time total:
```tsx
const section80C = useWatch({ control, name: [
  'section_80c_ppf', 'section_80c_elss', 'section_80c_life_insurance',
  // ... other 80C fields
]});
const total80C = section80C.reduce((sum, val) => sum + (val || 0), 0);
const remaining80C = 150000 - total80C;
```

Document upload in each section:
```tsx
{declarationId && (
  <div className="mt-4 pt-4 border-t">
    <h4 className="text-sm font-medium mb-2">Upload Proofs</h4>
    <DocumentUpload
      declarationId={declarationId}
      section="80C"
      onUploadComplete={refetchDocuments}
    />
  </div>
)}
```
  </action>
  <verify>`pnpm tsc --noEmit` passes</verify>
  <done>Investment form with real-time 80C total validation and document upload ready</done>
</task>

<task type="auto">
  <name>Task 2: Create investment pages and document upload API (ESS-06)</name>
  <files>src/app/(employee)/investments/page.tsx, src/app/(employee)/investments/declare/page.tsx, src/app/api/investments/[declarationId]/documents/route.ts</files>
  <action>
1. Create `src/app/api/investments/[declarationId]/documents/route.ts`:
   - API for managing investment proof documents
   - Uses existing storage infrastructure from @/lib/storage.ts

   GET handler:
   - Fetch all documents for a declaration
   - Return: { documents: { id, fileName, originalName, section, size, uploadedAt }[] }
   - Only allow owner (employee) or admin to view

   POST handler:
   - Accept multipart/form-data with file and section
   - Validate file using validateFile() from @/lib/storage
   - Use saveFile() to store (creates /uploads/employees/{employeeId}/{filename})
   - Create database record linking file to declaration
   - Store: declaration_id, file_name, original_name, storage_path, section, mime_type, size, retention_date
   - Return: { document: { id, fileName, section } }

   DELETE handler:
   - Accept documentId in query string
   - Verify ownership (employee or admin)
   - Remove from database (keep file until retention expires per storage policy)
   - Return: { success: true }

Database schema addition (if not exists - check first):
```sql
-- May need to add to investment_declaration_documents table
-- or create new table for proof documents
CREATE TABLE investment_proof_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  declaration_id UUID REFERENCES investment_declarations(id),
  file_name VARCHAR(255) NOT NULL,
  original_name VARCHAR(255) NOT NULL,
  storage_path VARCHAR(500) NOT NULL,
  section VARCHAR(50) NOT NULL, -- '80C', '80D', 'HRA', 'OTHER'
  mime_type VARCHAR(100) NOT NULL,
  size_bytes INTEGER NOT NULL,
  retention_date TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP -- soft delete
);
```

2. Create `src/app/(employee)/investments/page.tsx`:
   - Server component
   - Fetch employee's investment declarations
   - If current FY declaration exists:
     - Show InvestmentSummary component
     - Show document count: "X documents uploaded"
     - "Edit" button if DRAFT status
     - "View" button if SUBMITTED/VERIFIED
   - If no current FY declaration:
     - Call to action: "Declare Investments"
     - Explain tax benefits
   - Show past FY declarations in list
   - Link to /investments/declare

3. Create `src/app/(employee)/investments/declare/page.tsx`:
   - Server component
   - Calculate current financial year (April to March)
   - Check if declaration exists for current FY
   - If exists and DRAFT: load for editing (pass declarationId for document upload)
   - If exists and SUBMITTED/VERIFIED: redirect to view
   - Pass existing data (if any) to form
   - Render InvestmentDeclarationForm with declarationId prop
   - Handle success redirect to /investments

Financial year helper:
```typescript
function getCurrentFinancialYear(): string {
  const today = new Date();
  const month = today.getMonth(); // 0-11
  const year = today.getFullYear();
  // FY starts April (month 3)
  if (month >= 3) {
    return `${year}-${(year + 1).toString().slice(-2)}`; // "2025-26"
  }
  return `${year - 1}-${year.toString().slice(-2)}`; // "2024-25"
}
```

Mobile layout:
- Full-width form sections
- Sticky submit button at bottom
- Collapsible sections to reduce scroll
- Clear section headers with limits shown
- Document upload with preview thumbnails
  </action>
  <verify>
1. `pnpm tsc --noEmit` passes
2. Visit /investments shows declaration status with document count
3. Visit /investments/declare shows form
4. Can upload documents after saving declaration as draft
5. Uploaded documents appear in list with delete option
  </verify>
  <done>Investment declaration pages complete with document upload for proofs</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. 80C total shows real-time as fields are filled
3. Warning appears when 80C exceeds Rs.1,50,000
4. Form submits successfully
5. Mobile layout works with collapsible sections
6. Document upload works for each section (80C, 80D, HRA, Other)
7. Uploaded documents can be viewed, downloaded, and deleted
8. File validation enforces 10MB limit and allowed types
</verification>

<success_criteria>
- Investment list page shows current FY declaration
- Form has all 80C, 80D, HRA fields
- Real-time 80C total with remaining limit
- Validation prevents exceeding limits
- Save as draft and submit options
- Mobile-optimized with collapsible sections
- Document upload functional for investment proofs
- Can upload multiple files per section
- Uploaded files listed with delete option
- Only PDF, JPG, PNG, DOC allowed (max 10MB)
</success_criteria>

<output>
After completion, create `.planning/phases/04-employee-self-service/04-06-SUMMARY.md`
</output>
