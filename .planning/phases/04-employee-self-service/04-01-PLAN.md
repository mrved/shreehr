---
phase: 04-employee-self-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/email/resend.ts
  - src/lib/email/queue.ts
  - src/lib/email/worker.ts
  - src/lib/email/templates/payslip-notification.ts
  - src/lib/email/templates/index.ts
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for payslip notifications"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
      - name: EMAIL_FROM
        source: "Your verified domain email (e.g., noreply@shreehr.local)"
    dashboard_config:
      - task: "Verify sending domain"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "Email service can send transactional emails via Resend"
    - "Email jobs are queued and processed asynchronously"
    - "Failed emails retry with exponential backoff"
  artifacts:
    - path: "src/lib/email/resend.ts"
      provides: "Resend email sending function"
      exports: ["sendEmail"]
    - path: "src/lib/email/queue.ts"
      provides: "BullMQ email queue"
      exports: ["emailQueue", "addEmailJob"]
    - path: "src/lib/email/worker.ts"
      provides: "Email worker processing"
      exports: ["startEmailWorker"]
    - path: "src/lib/email/templates/payslip-notification.ts"
      provides: "Payslip notification email template"
      exports: ["payslipNotificationTemplate"]
  key_links:
    - from: "src/lib/email/worker.ts"
      to: "src/lib/email/resend.ts"
      via: "Worker calls sendEmail on job processing"
      pattern: "sendEmail\\("
    - from: "src/lib/email/queue.ts"
      to: "src/lib/queues/connection.ts"
      via: "Uses existing Redis connection"
      pattern: "import.*connection"
---

<objective>
Set up email notification infrastructure using Resend and BullMQ for async email delivery.

Purpose: Enable payslip and approval notifications to employees via email with reliable delivery and retry logic.
Output: Email service with queue, worker, and payslip notification template ready for integration.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employee-self-service/04-RESEARCH.md

# Existing BullMQ infrastructure
@src/lib/queues/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Resend email service</name>
  <files>src/lib/email/resend.ts</files>
  <action>
Create email service using Resend SDK:
1. Install resend: `pnpm add resend`
2. Create `src/lib/email/resend.ts`:
   - Export `sendEmail({ to, subject, html, text })` function
   - Use RESEND_API_KEY from env
   - Use EMAIL_FROM from env (default: noreply@shreehr.local)
   - Return result with messageId on success
   - Throw error with descriptive message on failure
3. Add RESEND_API_KEY and EMAIL_FROM to .env.example

Do NOT use Nodemailer - Resend provides better DX and webhook tracking.
  </action>
  <verify>TypeScript compiles: `pnpm tsc --noEmit`</verify>
  <done>sendEmail function exported and callable</done>
</task>

<task type="auto">
  <name>Task 2: Create email queue and worker</name>
  <files>src/lib/email/queue.ts, src/lib/email/worker.ts, src/lib/email/templates/payslip-notification.ts, src/lib/email/templates/index.ts</files>
  <action>
Create email queue infrastructure using existing BullMQ setup:

1. Create `src/lib/email/queue.ts`:
   - Import connection from `@/lib/queues/connection`
   - Create `emailQueue` with name 'emails'
   - Export `addEmailJob(template, to, data)` helper function
   - Job data structure: { template: string, to: string, data: object }

2. Create `src/lib/email/worker.ts`:
   - Import Worker from bullmq and connection
   - Import sendEmail from ./resend
   - Import templates from ./templates
   - Create worker processing emails queue
   - Concurrency: 5 (process 5 emails at a time)
   - Retry: 3 attempts with exponential backoff (2s, 4s, 8s)
   - Keep completed jobs 24h, failed jobs 7 days
   - Template lookup: switch on job.data.template to get HTML
   - Log success/failure for debugging

3. Create `src/lib/email/templates/payslip-notification.ts`:
   - Export `payslipNotificationTemplate(data)` function
   - data: { employeeName, month, year, payslipUrl }
   - Return { subject, html, text }
   - HTML: Simple styled email with ShreeHR branding
   - Include link to view payslip in portal
   - Include month/year in subject

4. Create `src/lib/email/templates/index.ts`:
   - Re-export all templates
   - Export `getTemplate(name, data)` function for dynamic lookup

Pattern from existing payroll worker: src/lib/queues/workers/payroll.worker.ts
  </action>
  <verify>TypeScript compiles: `pnpm tsc --noEmit`</verify>
  <done>Email queue accepts jobs and worker processes them with retry logic</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. Email queue and worker modules compile without errors
3. Templates export correct structure
</verification>

<success_criteria>
- Resend SDK installed and configured
- Email queue created with addEmailJob helper
- Worker processes jobs with 3 retry attempts
- Payslip notification template ready
- Environment variables documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/04-employee-self-service/04-01-SUMMARY.md`
</output>
