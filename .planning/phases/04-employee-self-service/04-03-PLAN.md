---
phase: 04-employee-self-service
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/profile.ts
  - src/app/api/profile/route.ts
  - src/app/api/profile/update-requests/route.ts
  - src/app/api/profile/update-requests/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Employee can request profile updates for address and emergency contact"
    - "Profile updates require admin approval before applying"
    - "Admin can approve or reject profile update requests"
    - "Approved updates are applied to Employee record"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ProfileUpdateRequest model"
      contains: "model ProfileUpdateRequest"
    - path: "src/lib/validations/profile.ts"
      provides: "Profile update validation schemas"
      exports: ["profileUpdateSchema"]
    - path: "src/app/api/profile/route.ts"
      provides: "Employee profile view endpoint"
      exports: ["GET"]
    - path: "src/app/api/profile/update-requests/route.ts"
      provides: "Profile update request endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/profile/update-requests/[id]/route.ts"
      provides: "Profile update approval workflow"
      exports: ["GET", "PATCH"]
  key_links:
    - from: "src/app/api/profile/update-requests/[id]/route.ts"
      to: "prisma.employee"
      via: "Updates employee on approval"
      pattern: "prisma\\.employee\\.update"
    - from: "src/app/api/profile/update-requests/route.ts"
      to: "src/lib/validations/profile.ts"
      via: "Zod validation"
      pattern: "profileUpdateSchema"
---

<objective>
Create profile update request workflow with admin approval for employee personal information changes.

Purpose: Allow employees to update address and emergency contact while maintaining data integrity through approval.
Output: ProfileUpdateRequest model, validation schemas, and approval workflow APIs.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employee-self-service/04-RESEARCH.md

# Existing patterns
@prisma/schema.prisma
@src/app/api/leave-requests/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ProfileUpdateRequest model</name>
  <files>prisma/schema.prisma</files>
  <action>
Add ProfileUpdateRequest model to prisma/schema.prisma:

```prisma
// ============================================================================
// PROFILE UPDATE REQUESTS (approval workflow)
// ============================================================================

model ProfileUpdateRequest {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  // Requested changes stored as JSON
  // Contains: { field_name: { old: value, new: value } }
  changes     Json

  // Fields that can be updated by employees
  // address_line1, address_line2, city, state, postal_code
  // emergency_contact, emergency_phone, personal_phone, personal_email

  status          ProfileUpdateStatus @default(PENDING)
  reason          String? // Employee's reason for update

  // Approval tracking
  approved_by     String?
  approver        User?    @relation("ProfileUpdateApprovedBy", fields: [approved_by], references: [id])
  approved_at     DateTime?
  rejection_reason String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt
  updated_by String?

  @@index([employee_id, status])
  @@index([status, created_at])
  @@map("profile_update_requests")
}

enum ProfileUpdateStatus {
  PENDING
  APPROVED
  REJECTED
}
```

Add relation to Employee:
```prisma
profile_update_requests ProfileUpdateRequest[]
```

Add relation to User (for approvals):
```prisma
approved_profile_updates ProfileUpdateRequest[] @relation("ProfileUpdateApprovedBy")
```

Run: `pnpm db:push`
  </action>
  <verify>`pnpm db:push` succeeds</verify>
  <done>ProfileUpdateRequest model exists in database</done>
</task>

<task type="auto">
  <name>Task 2: Create profile APIs with approval workflow</name>
  <files>src/lib/validations/profile.ts, src/app/api/profile/route.ts, src/app/api/profile/update-requests/route.ts, src/app/api/profile/update-requests/[id]/route.ts</files>
  <action>
1. Create `src/lib/validations/profile.ts`:
   - Define UPDATABLE_FIELDS = ['address_line1', 'address_line2', 'city', 'state', 'postal_code', 'emergency_contact', 'emergency_phone', 'personal_phone', 'personal_email']
   - `profileUpdateSchema`: Validate each field is string, optional
   - Validate at least one field provided
   - Validate postal_code is 6 digits if provided
   - Validate phone numbers are 10 digits if provided
   - Validate email format if provided

2. Create `src/app/api/profile/route.ts`:
   - GET: Return current employee profile (from session.user.employeeId)
   - Include non-sensitive employee data
   - Mask PAN/Aadhaar (only last 4 digits)
   - Return 401 if no employeeId in session

3. Create `src/app/api/profile/update-requests/route.ts`:
   - GET: List update requests
     - Employee: own requests only
     - Admin/HR: all pending requests for approval queue
   - POST: Create update request
     - Validate fields are in UPDATABLE_FIELDS
     - Build changes JSON: { field: { old: currentValue, new: newValue } }
     - Only include fields that actually changed
     - Return 400 if no actual changes
     - Check for pending request on same fields

4. Create `src/app/api/profile/update-requests/[id]/route.ts`:
   - GET: Single request with changes diff
   - PATCH: Approve or reject
     - Only ADMIN, HR_MANAGER can approve
     - If approved: Apply changes to Employee record
     - Set approved_by, approved_at
     - If rejected: Set rejection_reason
     - Return 400 if already processed

Follow patterns from leave approval: src/app/api/leave-requests/[id]/route.ts
  </action>
  <verify>`pnpm tsc --noEmit` passes</verify>
  <done>Profile update workflow with approval ready</done>
</task>

</tasks>

<verification>
1. `pnpm db:push` succeeds
2. `pnpm tsc --noEmit` passes
3. ProfileUpdateRequest stores changes as JSON diff
4. Only updatable fields can be requested
5. Approval applies changes to Employee record
</verification>

<success_criteria>
- ProfileUpdateRequest model tracks change requests
- Employee can submit update requests
- Admin can view pending requests
- Approval applies changes to Employee record
- Rejection stores reason
</success_criteria>

<output>
After completion, create `.planning/phases/04-employee-self-service/04-03-SUMMARY.md`
</output>
