---
phase: 04-employee-self-service
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/investment.ts
  - src/app/api/investments/route.ts
  - src/app/api/investments/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Employee can declare 80C investments with category breakdown"
    - "Employee can declare 80D health insurance premium"
    - "Employee can declare HRA with landlord details"
    - "System validates 80C total does not exceed Rs.1,50,000"
    - "Admin can view and verify investment declarations"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "InvestmentDeclaration model"
      contains: "model InvestmentDeclaration"
    - path: "src/lib/validations/investment.ts"
      provides: "Zod schemas for investment validation"
      exports: ["investmentCreateSchema", "investment80CSchema", "investment80DSchema"]
    - path: "src/app/api/investments/route.ts"
      provides: "Investment CRUD endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/investments/[id]/route.ts"
      provides: "Individual investment operations"
      exports: ["GET", "PATCH", "DELETE"]
  key_links:
    - from: "src/app/api/investments/route.ts"
      to: "prisma.investmentDeclaration"
      via: "Database CRUD"
      pattern: "prisma\\.investmentDeclaration"
    - from: "src/app/api/investments/route.ts"
      to: "src/lib/validations/investment.ts"
      via: "Zod validation"
      pattern: "investmentCreateSchema\\.parse"
---

<objective>
Create investment declaration schema and APIs for 80C, 80D, and HRA tax-saving declarations.

Purpose: Enable employees to declare investments for TDS calculation, reducing their tax deduction at source.
Output: InvestmentDeclaration model, validation schemas with Indian tax rules, and CRUD APIs.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employee-self-service/04-RESEARCH.md

# Existing patterns
@prisma/schema.prisma
@src/lib/validations/leave.ts
@src/app/api/leave-requests/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add InvestmentDeclaration model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add InvestmentDeclaration model to prisma/schema.prisma:

```prisma
// ============================================================================
// INVESTMENT DECLARATIONS (for TDS calculation)
// ============================================================================

model InvestmentDeclaration {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  // Financial year
  financial_year String // e.g., "2025-26"

  // Section 80C (max Rs.1,50,000 total) - stored in paise
  section_80c_ppf          Int @default(0)
  section_80c_elss         Int @default(0)
  section_80c_life_insurance Int @default(0)
  section_80c_tuition_fees Int @default(0)
  section_80c_nps          Int @default(0)
  section_80c_home_loan_principal Int @default(0)
  section_80c_sukanya      Int @default(0)
  section_80c_other        Int @default(0)

  // Section 80D Health Insurance (max Rs.25,000 self, Rs.50,000 parents if senior)
  section_80d_self         Int @default(0)
  section_80d_parents      Int @default(0)
  section_80d_checkup      Int @default(0) // Max Rs.5,000

  // HRA (House Rent Allowance)
  hra_monthly_rent         Int @default(0)
  hra_landlord_name        String?
  hra_landlord_pan         String? // Required if annual rent > Rs.1,00,000
  hra_rental_address       String?

  // Other deductions
  section_80e_education_loan Int @default(0) // No limit
  section_80g_donations    Int @default(0)
  section_24_home_loan_interest Int @default(0) // Max Rs.2,00,000

  // Status
  status         InvestmentDeclarationStatus @default(DRAFT)
  submitted_at   DateTime?
  verified_at    DateTime?
  verified_by    String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt
  updated_by String?

  @@unique([employee_id, financial_year])
  @@index([financial_year, status])
  @@map("investment_declarations")
}

enum InvestmentDeclarationStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}
```

Also add relation to Employee model:
```prisma
investment_declarations InvestmentDeclaration[]
```

Run: `pnpm db:push` to update database schema.
  </action>
  <verify>`pnpm db:push` succeeds without errors</verify>
  <done>InvestmentDeclaration model exists in database</done>
</task>

<task type="auto">
  <name>Task 2: Create validation schemas and APIs</name>
  <files>src/lib/validations/investment.ts, src/app/api/investments/route.ts, src/app/api/investments/[id]/route.ts</files>
  <action>
1. Create `src/lib/validations/investment.ts`:
   - Use paise (integers) for all amounts like existing payroll patterns
   - Helper: `MAX_80C_PAISE = 15000000` (Rs.1,50,000)
   - Helper: `MAX_80D_SELF_PAISE = 2500000` (Rs.25,000)
   - Helper: `MAX_80D_PARENTS_PAISE = 5000000` (Rs.50,000 for senior)
   - Helper: `MAX_CHECKUP_PAISE = 500000` (Rs.5,000)

   Zod schemas:
   - `investment80CSchema`: Validate each field >= 0, add .refine() for total <= MAX_80C_PAISE
   - `investment80DSchema`: Validate self <= 25K, parents <= 50K, checkup <= 5K
   - `hraSchema`: Validate rent >= 0, landlord PAN optional but regex if provided
   - `investmentCreateSchema`: Combine all sections with financial_year
   - `investmentUpdateSchema`: Same but all fields optional

2. Create `src/app/api/investments/route.ts`:
   - GET: List employee's declarations (RBAC: employee sees own, admin sees all)
   - POST: Create new declaration with validation
   - Employee can only have one declaration per financial_year
   - Return 400 if 80C total exceeds limit

3. Create `src/app/api/investments/[id]/route.ts`:
   - GET: Single declaration with RBAC
   - PATCH: Update declaration (only if DRAFT status)
   - DELETE: Delete declaration (only if DRAFT status)
   - Add `submit` action that sets status=SUBMITTED and submitted_at

Follow patterns from src/app/api/leave-requests/ for RBAC and validation.
  </action>
  <verify>`pnpm tsc --noEmit` passes</verify>
  <done>Investment APIs accept declarations with proper tax rule validation</done>
</task>

</tasks>

<verification>
1. `pnpm db:push` succeeds
2. `pnpm tsc --noEmit` passes
3. InvestmentDeclaration model has all 80C/80D/HRA fields
4. 80C total validation enforces Rs.1,50,000 limit
</verification>

<success_criteria>
- InvestmentDeclaration model in database
- Zod schemas validate Indian tax limits
- CRUD APIs with proper RBAC
- Employee can only edit DRAFT declarations
- 80C total cannot exceed Rs.1,50,000
</success_criteria>

<output>
After completion, create `.planning/phases/04-employee-self-service/04-02-SUMMARY.md`
</output>
