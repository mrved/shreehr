---
phase: 04-employee-self-service
plan: 07
type: execute
wave: 2
depends_on: ["04-01", "04-03"]
files_modified:
  - src/app/(employee)/profile/page.tsx
  - src/app/(employee)/profile/edit/page.tsx
  - src/components/employee/profile-view.tsx
  - src/components/employee/profile-edit-form.tsx
  - src/lib/queues/workers/payroll.worker.ts
  - src/app/(dashboard)/approvals/page.tsx
  - src/components/admin/profile-approval-list.tsx
autonomous: true

must_haves:
  truths:
    - "Employee can view their profile information"
    - "Employee can request profile updates"
    - "Admin can approve or reject profile update requests"
    - "Payslip generation triggers email notification to employee"
  artifacts:
    - path: "src/app/(employee)/profile/page.tsx"
      provides: "Profile view page"
      min_lines: 40
    - path: "src/app/(employee)/profile/edit/page.tsx"
      provides: "Profile edit page"
      min_lines: 30
    - path: "src/components/employee/profile-edit-form.tsx"
      provides: "Profile update request form"
      min_lines: 80
    - path: "src/app/(dashboard)/approvals/page.tsx"
      provides: "Admin approvals dashboard"
      min_lines: 50
    - path: "src/lib/queues/workers/payroll.worker.ts"
      provides: "Payroll worker with email notification"
      contains: "addEmailJob"
  key_links:
    - from: "src/components/employee/profile-edit-form.tsx"
      to: "/api/profile/update-requests"
      via: "Submit profile update request"
      pattern: "api/profile/update-requests"
    - from: "src/lib/queues/workers/payroll.worker.ts"
      to: "src/lib/email/queue.ts"
      via: "Queue email on payslip generation"
      pattern: "addEmailJob"
---

<objective>
Create profile viewing/editing pages and integrate payslip email notifications into the payroll worker.

Purpose: Complete the employee self-service portal with profile management and automated notifications.
Output: Profile pages, approval workflow UI, and payslip notification integration.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employee-self-service/04-RESEARCH.md

# Dependencies from prior plans
@src/lib/email/queue.ts
@src/app/api/profile/update-requests/route.ts

# Existing payroll worker
@src/lib/queues/workers/payroll.worker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile view and edit pages</name>
  <files>src/app/(employee)/profile/page.tsx, src/app/(employee)/profile/edit/page.tsx, src/components/employee/profile-view.tsx, src/components/employee/profile-edit-form.tsx</files>
  <action>
1. Create `src/components/employee/profile-view.tsx`:
   - Props: { employee: Employee, pendingRequest?: ProfileUpdateRequest }
   - Display sections:
     - Personal Info (name, DOB, gender, marital status)
     - Contact Info (email, phone, emergency contact)
     - Address (full address formatted)
     - Employment (department, designation, DOJ, employee code)
     - Statutory (UAN, ESIC - masked partially)
   - "Edit" button linking to /profile/edit
   - If pendingRequest exists: show banner "Update request pending approval"
   - Mobile: stacked sections, Desktop: 2-column grid

2. Create `src/components/employee/profile-edit-form.tsx`:
   - Client component using React Hook Form
   - Only editable fields (from UPDATABLE_FIELDS in validation):
     - Address: address_line1, address_line2, city, state, postal_code
     - Contact: personal_phone, personal_email, emergency_contact, emergency_phone
   - Show current values as defaults
   - Reason textarea (why updating)
   - Highlight changed fields visually
   - Submit creates ProfileUpdateRequest
   - Cancel returns to /profile

3. Create `src/app/(employee)/profile/page.tsx`:
   - Server component
   - Fetch employee data via auth() -> employeeId
   - Fetch any pending ProfileUpdateRequest
   - Render ProfileView component

4. Create `src/app/(employee)/profile/edit/page.tsx`:
   - Server component
   - Check if pending request exists -> show warning
   - Fetch current employee data
   - Render ProfileEditForm with current values

Form layout:
```tsx
<form className="space-y-6">
  <fieldset>
    <legend className="text-lg font-semibold">Address</legend>
    <div className="mt-4 grid gap-4 md:grid-cols-2">
      {/* Address fields */}
    </div>
  </fieldset>

  <fieldset>
    <legend className="text-lg font-semibold">Contact</legend>
    <div className="mt-4 grid gap-4 md:grid-cols-2">
      {/* Contact fields */}
    </div>
  </fieldset>

  <div>
    <label>Reason for Update</label>
    <textarea {...register('reason')} required />
  </div>

  <div className="flex gap-4">
    <Button type="submit">Submit for Approval</Button>
    <Button variant="outline" href="/profile">Cancel</Button>
  </div>
</form>
```
  </action>
  <verify>`pnpm tsc --noEmit` passes</verify>
  <done>Profile view and edit pages complete</done>
</task>

<task type="auto">
  <name>Task 2: Add admin approval UI and payslip notifications</name>
  <files>src/app/(dashboard)/approvals/page.tsx, src/components/admin/profile-approval-list.tsx, src/lib/queues/workers/payroll.worker.ts</files>
  <action>
1. Create `src/components/admin/profile-approval-list.tsx`:
   - Props: { requests: ProfileUpdateRequest[] }
   - Table/card list showing:
     - Employee name and code
     - Request date
     - Fields being changed (with old -> new diff)
     - Approve/Reject buttons
   - Modal for rejection reason
   - Calls PATCH /api/profile/update-requests/[id] with action

2. Create `src/app/(dashboard)/approvals/page.tsx`:
   - Server component
   - RBAC: Only ADMIN, HR_MANAGER can access
   - Tabs: "Profile Updates", "Leave Requests" (if not already existing)
   - Fetch pending ProfileUpdateRequests
   - Fetch pending LeaveRequests (for managers)
   - Render ProfileApprovalList
   - Show counts in tabs

3. Update `src/lib/queues/workers/payroll.worker.ts`:
   - Import addEmailJob from @/lib/email/queue
   - In FINALIZATION stage, after marking run as COMPLETED:
     - For each successfully processed employee:
       - Get employee email from database
       - Call addEmailJob('payslip-available', employee.personal_email || user.email, {
           employeeName: firstName + lastName,
           month: payrollRun.month,
           year: payrollRun.year,
           payslipUrl: `/payslips/${payrollRun.id}`
         })
   - Add try-catch around email queueing (don't fail payroll if email fails)
   - Log email queue success/failure

Email integration pattern:
```typescript
// In finalization stage
const employees = await prisma.employee.findMany({
  where: { id: { in: successfulEmployeeIds } },
  include: { user: { select: { email: true } } }
});

for (const employee of employees) {
  const email = employee.personal_email || employee.user?.email;
  if (email) {
    try {
      await addEmailJob('payslip-available', email, {
        employeeName: `${employee.first_name} ${employee.last_name}`,
        month: run.month,
        year: run.year,
        payslipUrl: `/payslips/${run.id}`
      });
    } catch (err) {
      console.error(`Failed to queue email for ${employee.id}:`, err);
      // Don't throw - email failure shouldn't fail payroll
    }
  }
}
```
  </action>
  <verify>
1. `pnpm tsc --noEmit` passes
2. Visit /approvals shows pending requests
3. Payroll worker imports addEmailJob without errors
  </verify>
  <done>Approval UI and payslip notifications integrated</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. Profile page shows employee info
3. Profile edit creates update request
4. Approvals page lists pending requests
5. Payroll worker queues email notifications
</verification>

<success_criteria>
- Profile view shows all employee sections
- Profile edit shows only editable fields
- Changed fields highlighted
- Approval page accessible to admin/HR
- Approve/reject workflow functional
- Payroll completion queues payslip emails
- Email failures don't break payroll
</success_criteria>

<output>
After completion, create `.planning/phases/04-employee-self-service/04-07-SUMMARY.md`
</output>
