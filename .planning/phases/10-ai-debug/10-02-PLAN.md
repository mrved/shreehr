# Phase 10.02: AI Chat & Floating Button Debug

## Date: 2026-02-04

## Issues Identified

### Issue 1: AI Chat Not Working

**Root Cause:** Message format mismatch between AI SDK v6 and API route

AI SDK v6 (`ai@^6.0.69`) uses a `parts` array format for messages:
```ts
{ parts: [{ type: 'text', text: 'message content' }] }
```

But the API route (`/api/chat/route.ts`) incorrectly accesses:
```ts
lastMessage.content as string  // undefined or wrong type
```

**Fix:** Update API route to properly extract text from message parts:
```ts
// Extract text content from parts array (AI SDK v6 format)
const textContent = lastMessage.parts
  ?.filter((part: { type: string }) => part.type === 'text')
  .map((part: { type: string; text: string }) => part.text)
  .join('\n') || '';
```

### Issue 2: Floating Chat Button Not Visible

**Root Cause:** In dashboard layout, FloatingChatButton is passed as a child to DashboardShell

```tsx
// Current (broken)
<DashboardShell user={session.user}>
  {children}
  <FloatingChatButton href="/dashboard/chat" />
</DashboardShell>
```

DashboardShell renders children inside `<main className="p-4 sm:p-6">`, so the fixed-position button is nested inside a flex/layout context that might affect rendering.

**Fix:** Move FloatingChatButton outside DashboardShell (like employee layout):
```tsx
// Fixed
<>
  <DashboardShell user={session.user}>
    {children}
  </DashboardShell>
  <FloatingChatButton href="/dashboard/chat" />
</>
```

## Environment Variables (Verified)

Vercel has these env vars set correctly:
- ✅ AI_PROVIDER (encrypted)
- ✅ ANTHROPIC_API_KEY (encrypted)
- ✅ AUTH_SECRET
- ✅ DATABASE_URL
- ✅ DIRECT_URL

## Files to Modify

1. `src/app/api/chat/route.ts` - Fix message parts extraction
2. `src/app/dashboard/layout.tsx` - Move FloatingChatButton outside DashboardShell

## Implementation Plan

1. Fix message format extraction in API route
2. Fix dashboard layout FloatingChatButton placement
3. Commit and push
4. Verify deployment

## Testing

After deployment:
1. Navigate to /employee/chat - should see floating button and be able to chat
2. Navigate to /dashboard/chat - should see floating button and be able to chat
3. Test chat functionality - should get responses from Claude
