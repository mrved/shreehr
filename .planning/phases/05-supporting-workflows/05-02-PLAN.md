---
phase: 05-supporting-workflows
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/expense.ts
  - src/lib/workflows/expense.ts
  - src/app/api/expense-policies/route.ts
  - src/app/api/expense-policies/[id]/route.ts
  - src/app/api/expenses/route.ts
  - src/app/api/expenses/[id]/route.ts
  - src/app/api/expenses/[id]/receipt/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create and configure expense policies with limits and receipt requirements"
    - "Employee can submit expense claim with amount, category, and receipt"
    - "System validates expense against policy limits and receipt requirements"
    - "Manager can approve/reject expense claims assigned to them"
    - "Multi-level approval routes claims based on amount thresholds"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ExpensePolicy, ExpenseClaim, ExpenseApproval models"
      contains: "model ExpenseClaim"
    - path: "src/lib/workflows/expense.ts"
      provides: "Approval routing and status transitions"
      exports: ["getRequiredApprovers", "canTransitionExpense", "validateExpenseAgainstPolicy"]
    - path: "src/app/api/expenses/route.ts"
      provides: "List and create expense claims"
      exports: ["GET", "POST"]
    - path: "src/app/api/expenses/[id]/route.ts"
      provides: "Get, approve/reject expense"
      exports: ["GET", "PATCH"]
  key_links:
    - from: "src/app/api/expenses/route.ts"
      to: "src/lib/workflows/expense.ts"
      via: "policy validation"
      pattern: "validateExpenseAgainstPolicy"
    - from: "src/app/api/expenses/[id]/route.ts"
      to: "src/lib/workflows/expense.ts"
      via: "approval routing"
      pattern: "getRequiredApprovers"
---

<objective>
Implement expense management workflow with configurable policies, receipt handling, and multi-level approval routing based on amount thresholds.

Purpose: Enable employees to submit expense claims with policy validation, and managers to approve/reject with automatic routing for higher amounts (EXP-01, EXP-02, EXP-03, EXP-04, EXP-05).

Output: Prisma models, validation schemas, approval routing logic, and API endpoints for expense policy configuration and claim management.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-supporting-workflows/05-RESEARCH.md
@prisma/schema.prisma
@src/lib/validations/investment.ts
@src/lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add expense Prisma models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add ExpensePolicy model:
- id (cuid), name (String unique), code (String unique - e.g., "TRAVEL", "FOOD")
- description (String optional), max_amount_paise (Int nullable - null means no limit)
- requires_receipt (Boolean default true), requires_approval (Boolean default true)
- auto_approve_below_paise (Int nullable - auto-approve if amount < this)
- is_active (Boolean default true)
- Audit fields: created_at, updated_at

Add ExpenseClaim model:
- id (cuid), employee_id (relation to Employee)
- policy_id (relation to ExpensePolicy)
- amount_paise (Int), description (String), expense_date (DateTime Date)
- receipt_path (String nullable), receipt_original_name (String nullable)
- status (ExpenseStatus enum: DRAFT, SUBMITTED, PENDING_APPROVAL, APPROVED, REJECTED, REIMBURSED)
- current_approval_level (Int default 1)
- policy_snapshot (Json - captures policy state at submission time)
- rejection_reason (String nullable)
- synced_to_payroll (Boolean default false), payroll_run_id (String nullable)
- Audit fields: created_at, created_by, updated_at, updated_by

Add ExpenseApproval model:
- id (cuid), expense_id (relation to ExpenseClaim)
- level (Int), approver_role (String - MANAGER, HR_MANAGER, ADMIN)
- approver_id (String nullable - actual user who approved)
- status (ApprovalStatus enum: PENDING, APPROVED, REJECTED)
- comments (String nullable), acted_at (DateTime nullable)
- created_at (DateTime)

Add ExpenseStatus enum: DRAFT, SUBMITTED, PENDING_APPROVAL, APPROVED, REJECTED, REIMBURSED
Add ApprovalStatus enum: PENDING, APPROVED, REJECTED

Add relations:
- Employee has many expense_claims
- ExpenseClaim has many approvals
- Add User relation for created_by

Run `pnpm db:push` after changes.
  </action>
  <verify>Run `pnpm prisma validate` - should pass with no errors</verify>
  <done>ExpensePolicy, ExpenseClaim, ExpenseApproval models exist with all fields and relations</done>
</task>

<task type="auto">
  <name>Task 2: Create expense validation schemas and workflow logic</name>
  <files>
    src/lib/validations/expense.ts
    src/lib/workflows/expense.ts
  </files>
  <action>
**src/lib/validations/expense.ts:**
Create Zod schemas:
- CreateExpensePolicySchema: name (string min 2), code (string uppercase 2-20 chars), description (optional), max_amount_paise (positive int or null), requires_receipt (boolean), requires_approval (boolean), auto_approve_below_paise (positive int or null)
- UpdateExpensePolicySchema: partial of create schema
- CreateExpenseClaimSchema: policy_id (cuid), amount_paise (positive int), description (string min 5), expense_date (date not future)
- SubmitExpenseClaimSchema: just the action flag { action: "submit" }
- ApproveRejectExpenseSchema: action (enum: approve, reject), comments (string, required if reject)

**src/lib/workflows/expense.ts:**
Create workflow helpers:
- APPROVAL_LEVELS constant: Array of { level: 1, role: "MANAGER", minAmount: 0, maxAmount: 50000*100 (Rs.500) }, { level: 2, role: "HR_MANAGER", minAmount: 50000*100+1, maxAmount: 250000*100 (Rs.2500) }, { level: 3, role: "ADMIN", minAmount: 250000*100+1, maxAmount: null }
- getRequiredApprovers(amountPaise: number) - returns array of approval levels needed (sequential)
- EXPENSE_TRANSITIONS constant: Record<ExpenseStatus, ExpenseStatus[]> mapping valid transitions
- canTransitionExpense(from, to, claim?) - validates transition with optional validators
- validateExpenseAgainstPolicy(policyId, amountPaise, hasReceipt) - async function that checks policy limits and receipt requirement, returns { valid, error?, needsApproval }
- shouldAutoApprove(policy, amountPaise) - returns boolean if auto-approve applies
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass with no type errors</verify>
  <done>Validation schemas and workflow functions export correctly, approval routing logic works for different amounts</done>
</task>

<task type="auto">
  <name>Task 3: Create expense policy and claim API endpoints</name>
  <files>
    src/app/api/expense-policies/route.ts
    src/app/api/expense-policies/[id]/route.ts
    src/app/api/expenses/route.ts
    src/app/api/expenses/[id]/route.ts
    src/app/api/expenses/[id]/receipt/route.ts
  </files>
  <action>
**src/app/api/expense-policies/route.ts:**
- GET: List all active policies. RBAC: Any authenticated user.
- POST: Create policy. RBAC: ADMIN only. Validate with CreateExpensePolicySchema.

**src/app/api/expense-policies/[id]/route.ts:**
- GET: Get policy by ID.
- PATCH: Update policy. RBAC: ADMIN only.
- DELETE: Soft delete (set is_active=false). RBAC: ADMIN only.

**src/app/api/expenses/route.ts:**
- GET: List expense claims. RBAC: Employees see own, MANAGER sees subordinates' pending, ADMIN/HR_MANAGER sees all. Support ?status filter and ?pending_approval=true for approvers.
- POST: Create draft expense claim. Validate with CreateExpenseClaimSchema. Validate against policy using validateExpenseAgainstPolicy. Store policy_snapshot from current policy. Return created claim in DRAFT status.

**src/app/api/expenses/[id]/route.ts:**
- GET: Get expense by ID with policy and approvals. RBAC: Owner, approver, or admin.
- PATCH: Handle actions based on body.action:
  - action=submit: Transition DRAFT->SUBMITTED->PENDING_APPROVAL. Validate receipt uploaded if policy requires. Create ExpenseApproval records for each required level from getRequiredApprovers(). If shouldAutoApprove(), transition directly to APPROVED.
  - action=approve: Find pending approval for current user's role/level. Mark approval as APPROVED. If all levels approved, transition claim to APPROVED. If more levels needed, keep PENDING_APPROVAL.
  - action=reject: Mark approval as REJECTED with comments. Transition claim to REJECTED.
  Use canTransitionExpense for all transitions. RBAC for approve/reject: must be approver at current level.
- DELETE: Delete only DRAFT claims.

**src/app/api/expenses/[id]/receipt/route.ts:**
- POST: Upload receipt. Use existing storage pattern from documents API. Save to uploads/expenses/{claimId}/. Accept multipart form data with file field. Validate file type (image/pdf, max 5MB). Update claim with receipt_path and receipt_original_name. RBAC: Claim owner only, only for DRAFT status.
- GET: Download receipt. RBAC: Claim owner, approvers, or admin.
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass. Run `pnpm lint` - should pass.</verify>
  <done>Policy CRUD works, claims can be created/submitted/approved/rejected, receipt upload saves file correctly</done>
</task>

</tasks>

<verification>
1. `pnpm prisma validate` - schema valid
2. `pnpm tsc --noEmit` - no type errors
3. `pnpm lint` - no lint errors
4. Database has ExpensePolicy, ExpenseClaim, ExpenseApproval tables
</verification>

<success_criteria>
- Expense policies can be created with limits and receipt requirements
- Claims validate against policy limits before submission
- Multi-level approval records created based on amount thresholds
- Approvers can only act on claims assigned to their level
- Policy snapshot captured at submission time to prevent policy change issues
- Receipts uploaded to filesystem with validation
</success_criteria>

<output>
After completion, create `.planning/phases/05-supporting-workflows/05-02-SUMMARY.md`
</output>
