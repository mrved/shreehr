---
phase: 05-supporting-workflows
plan: 05
type: execute
wave: 2
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - src/app/(dashboard)/onboarding/page.tsx
  - src/app/(dashboard)/onboarding/[id]/page.tsx
  - src/app/(dashboard)/expenses/page.tsx
  - src/app/(dashboard)/expenses/[id]/page.tsx
  - src/app/(dashboard)/loans/page.tsx
  - src/app/(dashboard)/loans/[id]/page.tsx
  - src/components/onboarding/onboarding-list.tsx
  - src/components/onboarding/onboarding-form.tsx
  - src/components/onboarding/checklist-manager.tsx
  - src/components/expenses/expense-list.tsx
  - src/components/expenses/expense-form.tsx
  - src/components/expenses/expense-approval.tsx
  - src/components/loans/loan-list.tsx
  - src/components/loans/loan-form.tsx
  - src/components/loans/loan-schedule.tsx
  - src/app/(employee)/expenses/page.tsx
  - src/app/(employee)/expenses/new/page.tsx
  - src/app/(employee)/loans/page.tsx
autonomous: false

must_haves:
  truths:
    - "HR can view onboarding dashboard with status overview"
    - "HR can create onboarding with checklist and send offer"
    - "HR can mark checklist items as complete"
    - "Employee can submit expense claims with receipt upload"
    - "Manager can view and approve/reject pending expenses"
    - "Employee can view their loans and repayment schedule"
    - "Admin can create loans with EMI calculation preview"
  artifacts:
    - path: "src/app/(dashboard)/onboarding/page.tsx"
      provides: "HR onboarding list page"
      min_lines: 50
    - path: "src/app/(dashboard)/expenses/page.tsx"
      provides: "Admin/manager expense list page"
      min_lines: 50
    - path: "src/app/(dashboard)/loans/page.tsx"
      provides: "Admin loan list page"
      min_lines: 50
    - path: "src/app/(employee)/expenses/page.tsx"
      provides: "Employee expense list page"
      min_lines: 30
    - path: "src/app/(employee)/loans/page.tsx"
      provides: "Employee loan list page"
      min_lines: 30
  key_links:
    - from: "src/components/expenses/expense-form.tsx"
      to: "/api/expenses"
      via: "form submission"
      pattern: "fetch.*api/expenses"
    - from: "src/components/loans/loan-schedule.tsx"
      to: "/api/loans/[id]/schedule"
      via: "schedule fetch"
      pattern: "fetch.*api/loans.*schedule"
---

<objective>
Build admin dashboard pages for managing onboarding, expenses, and loans, plus employee portal pages for submitting expenses and viewing loans.

Purpose: Provide user interfaces for all three supporting workflows so HR/Admin can manage workflows and employees can participate (ONB-03, EXP-01, EXP-03, LOAN-04, LOAN-05).

Output: Dashboard pages with list views, forms, and approval interfaces; Employee portal pages for expense submission and loan viewing.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-supporting-workflows/05-RESEARCH.md
@src/app/(dashboard)/payroll/page.tsx
@src/app/(employee)/investments/page.tsx
@src/components/employee/investment-declaration-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding dashboard pages and components</name>
  <files>
    src/app/(dashboard)/onboarding/page.tsx
    src/app/(dashboard)/onboarding/new/page.tsx
    src/app/(dashboard)/onboarding/[id]/page.tsx
    src/components/onboarding/onboarding-list.tsx
    src/components/onboarding/onboarding-form.tsx
    src/components/onboarding/checklist-manager.tsx
  </files>
  <action>
**src/components/onboarding/onboarding-list.tsx:**
Client component showing onboarding records in table:
- Columns: Candidate Name, Position, Department, Joining Date, Status, Progress, Actions
- Status badges with colors (PENDING=yellow, ACCEPTED=blue, IN_PROGRESS=purple, COMPLETED=green, CANCELLED=red)
- Progress bar showing checklist completion percentage
- Filter by status dropdown
- Link to detail page for each record

**src/components/onboarding/onboarding-form.tsx:**
Form for creating onboarding record using React Hook Form:
- Candidate details: name, email, phone (with Indian phone validation)
- Position selection (designation dropdown)
- Department dropdown
- Offered salary input (in rupees, convert to paise on submit)
- Joining date picker (must be future date)
- Checklist: use useFieldArray for dynamic items, pre-populate with defaults
- Each checklist item: category (IT/Admin/Manager/HR), title, assignee (role or user), due date, required toggle
- Submit calls POST /api/onboarding

**src/components/onboarding/checklist-manager.tsx:**
Component for viewing and updating checklist:
- Grouped by category (IT, Admin, Manager, HR)
- Each item shows: title, assignee, due date, required badge, completion status
- Checkbox to mark complete (calls PATCH /api/onboarding/[id]/checklist)
- Completed items show who completed and when
- Progress summary at top

**src/app/(dashboard)/onboarding/page.tsx:**
Server component page:
- Fetch onboarding list from API
- Render OnboardingList component
- "New Onboarding" button linking to /onboarding/new
- RBAC: ADMIN, HR_MANAGER only

**src/app/(dashboard)/onboarding/new/page.tsx:**
Page wrapper for OnboardingForm with success redirect

**src/app/(dashboard)/onboarding/[id]/page.tsx:**
Detail page:
- Fetch onboarding record by ID
- Show candidate details card
- Show ChecklistManager for task management
- Status transition buttons (Accept Offer, Start Tasks, Complete, Cancel) based on current status
- If PENDING, show "Resend Offer Email" button
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass. Visual check: pages render without errors.</verify>
  <done>Onboarding dashboard shows list with status, form creates records with checklist, detail page manages tasks</done>
</task>

<task type="auto">
  <name>Task 2: Create expense management pages and components</name>
  <files>
    src/app/(dashboard)/expenses/page.tsx
    src/app/(dashboard)/expenses/[id]/page.tsx
    src/components/expenses/expense-list.tsx
    src/components/expenses/expense-form.tsx
    src/components/expenses/expense-approval.tsx
    src/app/(employee)/expenses/page.tsx
    src/app/(employee)/expenses/new/page.tsx
  </files>
  <action>
**src/components/expenses/expense-list.tsx:**
Client component for expense claims list:
- Columns: Date, Category, Description, Amount, Status, Actions
- Status badges with colors
- For managers: show "Pending Approval" tab with claims needing their approval
- Filter by status and date range
- Click row to view detail

**src/components/expenses/expense-form.tsx:**
Form for submitting expense claim:
- Policy/category dropdown (fetch from /api/expense-policies)
- Amount input in rupees (convert to paise)
- Expense date picker (not future)
- Description textarea
- Receipt upload: drag-drop zone, accepts images and PDFs, max 5MB
- Show policy limits below fields (e.g., "Max limit: Rs.5,000, Receipt required")
- Submit as draft, then separate "Submit for Approval" button
- Validate against policy limits client-side before submit

**src/components/expenses/expense-approval.tsx:**
Approval interface for managers:
- Show expense details: employee name, date, category, amount, description
- Receipt viewer (image preview or PDF icon with download link)
- Policy info: what was the limit, is receipt required
- Approve/Reject buttons
- Reject requires comments textarea
- Show approval chain: which levels needed, current level, who approved previous levels

**src/app/(dashboard)/expenses/page.tsx:**
Admin/manager expense dashboard:
- Tabs: All Expenses, Pending My Approval
- Pending Approval shows claims where user's role matches current_approval_level
- RBAC: ADMIN, HR_MANAGER, PAYROLL_MANAGER see all; MANAGER sees subordinates

**src/app/(dashboard)/expenses/[id]/page.tsx:**
Detail page:
- Show expense details
- If pending approval at user's level, show ExpenseApproval component
- If own expense, show status timeline

**src/app/(employee)/expenses/page.tsx:**
Employee expense list:
- Fetch own expenses from /api/expenses
- Show as cards on mobile, table on desktop
- Status summary at top (draft count, pending count, approved total for month)
- "Submit Expense" button linking to new page

**src/app/(employee)/expenses/new/page.tsx:**
Page wrapper for ExpenseForm with employee layout
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass. Visual check: pages render without errors.</verify>
  <done>Expense pages show claims with approval workflow, employees can submit with receipt, managers can approve/reject</done>
</task>

<task type="auto">
  <name>Task 3: Create loan management pages and components</name>
  <files>
    src/app/(dashboard)/loans/page.tsx
    src/app/(dashboard)/loans/new/page.tsx
    src/app/(dashboard)/loans/[id]/page.tsx
    src/components/loans/loan-list.tsx
    src/components/loans/loan-form.tsx
    src/components/loans/loan-schedule.tsx
    src/app/(employee)/loans/page.tsx
    src/app/(employee)/loans/[id]/page.tsx
  </files>
  <action>
**src/components/loans/loan-list.tsx:**
Client component for loans list:
- Columns: Employee, Type, Principal, EMI, Remaining, Status, Start Date
- Status badges with colors (PENDING, ACTIVE, CLOSED)
- Filter by status
- For employees: only show their loans

**src/components/loans/loan-form.tsx:**
Form for creating loan (admin):
- Employee selector (search/dropdown)
- Loan type dropdown (SALARY_ADVANCE, PERSONAL, EMERGENCY)
- Principal amount input in rupees
- Interest rate input (percentage, 0-30)
- Tenure in months (1-60)
- Start date picker (when deductions begin)
- **EMI Preview section:** Real-time calculation as user types
  - Show calculated EMI amount
  - Show total interest
  - Show total repayment
  - Mini schedule preview (first 3 months and last month)
- Submit creates loan in PENDING status

**src/components/loans/loan-schedule.tsx:**
Amortization schedule viewer:
- Fetch from /api/loans/[id]/schedule
- Table: Month, Date, EMI, Principal, Interest, Balance
- Summary card: Total Principal, Total Interest, Total Repayment
- Color coding: Past months (green if paid, red if skipped), Current month (yellow), Future (gray)
- Mobile: collapsible months, show summary prominently

**src/app/(dashboard)/loans/page.tsx:**
Admin loan dashboard:
- Fetch all loans
- Render LoanList
- "Create Loan" button to /loans/new
- Summary stats: Active loans count, Total outstanding
- RBAC: ADMIN, HR_MANAGER, PAYROLL_MANAGER

**src/app/(dashboard)/loans/new/page.tsx:**
Page wrapper for LoanForm with success redirect

**src/app/(dashboard)/loans/[id]/page.tsx:**
Detail page:
- Loan details card: employee, type, amounts, status
- LoanSchedule component
- Status actions: Disburse (if PENDING), Close/Cancel (if ACTIVE)
- Deduction history showing which months were deducted

**src/app/(employee)/loans/page.tsx:**
Employee loan list:
- Fetch own loans from /api/loans
- Summary card: Total loans, Total remaining
- Loan cards with key info

**src/app/(employee)/loans/[id]/page.tsx:**
Employee loan detail:
- Loan details (read-only)
- Full LoanSchedule component
- Download schedule as PDF button (stretch goal - can skip)
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass. Visual check: pages render without errors.</verify>
  <done>Loan pages show list and detail, form has real-time EMI preview, schedule shows full amortization with payment status</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` - no type errors
2. `pnpm lint` - no lint errors
3. All pages accessible at their routes
4. Forms submit to correct APIs
</verification>

<success_criteria>
- HR can access /onboarding and create new onboarding records
- Onboarding checklist can be viewed and items marked complete
- Employees can access /expenses in portal and submit claims with receipts
- Managers see pending approvals and can approve/reject
- Admin can access /loans and create loans with EMI preview
- Employees can view their loans and full repayment schedule
</success_criteria>

<output>
After completion, create `.planning/phases/05-supporting-workflows/05-05-SUMMARY.md`
</output>
