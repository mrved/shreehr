---
phase: 05-supporting-workflows
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/loan.ts
  - src/lib/workflows/loan.ts
  - src/app/api/loans/route.ts
  - src/app/api/loans/[id]/route.ts
  - src/app/api/loans/[id]/schedule/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create employee loan with principal, interest rate, and tenure"
    - "System calculates EMI using reducing balance formula"
    - "System generates full amortization schedule showing principal/interest breakdown"
    - "Employee can view their loans with balance and repayment schedule"
    - "Loan tracks remaining balance updated after each deduction"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "EmployeeLoan and LoanDeduction models"
      contains: "model EmployeeLoan"
    - path: "src/lib/workflows/loan.ts"
      provides: "EMI calculation and amortization schedule"
      exports: ["calculateEMI", "generateAmortizationSchedule"]
    - path: "src/app/api/loans/route.ts"
      provides: "List and create loans"
      exports: ["GET", "POST"]
    - path: "src/app/api/loans/[id]/schedule/route.ts"
      provides: "Get amortization schedule"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/loans/route.ts"
      to: "src/lib/workflows/loan.ts"
      via: "EMI calculation"
      pattern: "calculateEMI"
    - from: "src/app/api/loans/[id]/schedule/route.ts"
      to: "src/lib/workflows/loan.ts"
      via: "schedule generation"
      pattern: "generateAmortizationSchedule"
---

<objective>
Implement employee loan management with EMI calculation using reducing balance method, amortization schedule generation, and deduction tracking for payroll integration.

Purpose: Enable admin to create employee loans with automatic EMI calculation and employees to view loan balance and repayment schedules (LOAN-01, LOAN-02, LOAN-03, LOAN-04, LOAN-05).

Output: Prisma models, EMI calculation functions with tests, and API endpoints for loan creation, viewing, and schedule generation.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-supporting-workflows/05-RESEARCH.md
@prisma/schema.prisma
@src/lib/payroll/types.ts
@src/lib/payroll/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loan Prisma models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add EmployeeLoan model:
- id (cuid), employee_id (relation to Employee)
- loan_type (String - e.g., "SALARY_ADVANCE", "PERSONAL", "EMERGENCY")
- principal_paise (Int - original loan amount)
- annual_interest_rate (Float - percentage, e.g., 12.5)
- tenure_months (Int)
- emi_paise (Int - calculated monthly EMI)
- total_interest_paise (Int - total interest over tenure)
- total_repayment_paise (Int - principal + total interest)
- disbursed_paise (Int - amount disbursed, could differ from principal)
- remaining_balance_paise (Int - current outstanding)
- start_date (DateTime Date - when deductions start)
- end_date (DateTime Date - calculated end date)
- status (LoanStatus enum: PENDING, ACTIVE, CLOSED, CANCELLED, DEFAULTED)
- disbursement_date (DateTime nullable)
- closed_at (DateTime nullable)
- closure_reason (String nullable)
- Audit fields: created_at, created_by, updated_at, updated_by

Add LoanDeduction model:
- id (cuid), loan_id (relation to EmployeeLoan)
- month (Int 1-12), year (Int)
- emi_amount_paise (Int)
- principal_paise (Int - principal portion of EMI)
- interest_paise (Int - interest portion of EMI)
- balance_after_paise (Int - remaining balance after this deduction)
- payroll_run_id (String nullable - linked when synced)
- status (DeductionStatus enum: SCHEDULED, DEDUCTED, SKIPPED)
- created_at (DateTime)

Add LoanStatus enum: PENDING, ACTIVE, CLOSED, CANCELLED, DEFAULTED
Add DeductionStatus enum: SCHEDULED, DEDUCTED, SKIPPED

Add relations:
- Employee has many loans
- EmployeeLoan has many deductions
- Add User relation for created_by

Add unique constraint on LoanDeduction: (loan_id, month, year) - prevent double deduction

Run `pnpm db:push` after changes.
  </action>
  <verify>Run `pnpm prisma validate` - should pass with no errors</verify>
  <done>EmployeeLoan and LoanDeduction models exist with all fields, status enums defined</done>
</task>

<task type="auto">
  <name>Task 2: Create loan validation schemas and EMI calculation logic</name>
  <files>
    src/lib/validations/loan.ts
    src/lib/workflows/loan.ts
    src/lib/workflows/loan.test.ts
  </files>
  <action>
**src/lib/validations/loan.ts:**
Create Zod schemas:
- CreateLoanSchema: employee_id (cuid), loan_type (enum: SALARY_ADVANCE, PERSONAL, EMERGENCY), principal_paise (positive int, min 100000 = Rs.1000), annual_interest_rate (number 0-30), tenure_months (int 1-60), start_date (future date)
- UpdateLoanStatusSchema: action (enum: disburse, close, cancel), closure_reason (required if close/cancel)
- LoanFilterSchema: employee_id (optional), status (optional enum)

**src/lib/workflows/loan.ts:**
Create EMI calculation and workflow helpers:

```typescript
interface LoanParams {
  principalPaise: number;
  annualInterestRate: number;
  tenureMonths: number;
}

interface EMIScheduleEntry {
  month: number;
  emiPaise: number;
  principalPaise: number;
  interestPaise: number;
  balanceAfterPaise: number;
}

// EMI = [P × R × (1+R)^N] / [(1+R)^N - 1]
// where P = principal, R = monthly interest rate, N = tenure months
function calculateEMI(params: LoanParams): number {
  const { principalPaise, annualInterestRate, tenureMonths } = params;

  // Handle zero interest case
  if (annualInterestRate === 0) {
    return Math.round(principalPaise / tenureMonths);
  }

  const monthlyRate = annualInterestRate / 100 / 12;
  const factor = Math.pow(1 + monthlyRate, tenureMonths);
  const emi = (principalPaise * monthlyRate * factor) / (factor - 1);
  return Math.round(emi);
}

function generateAmortizationSchedule(params: LoanParams): EMIScheduleEntry[] {
  // Generate full schedule with principal/interest breakdown per month
  // Use reducing balance method
  // Round each component, adjust last EMI to zero out balance exactly
}

function calculateTotalInterest(params: LoanParams): number {
  // Total interest = (EMI × tenure) - principal
}

function calculateEndDate(startDate: Date, tenureMonths: number): Date {
  // Add tenure months to start date
}
```

Export all functions.

**src/lib/workflows/loan.test.ts:**
Write unit tests for EMI calculation:
- Test 1: Rs.100,000 @ 12% for 12 months should give EMI ~Rs.8,885
- Test 2: Rs.50,000 @ 0% for 10 months should give EMI Rs.5,000 exactly
- Test 3: Schedule total should equal principal + total interest (within 1 paise tolerance for rounding)
- Test 4: Schedule final balance should be 0
- Test 5: Each month's principal + interest = EMI
  </action>
  <verify>Run `pnpm test src/lib/workflows/loan.test.ts` - all tests should pass</verify>
  <done>EMI calculation correct, amortization schedule generates correctly, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create loan API endpoints</name>
  <files>
    src/app/api/loans/route.ts
    src/app/api/loans/[id]/route.ts
    src/app/api/loans/[id]/schedule/route.ts
  </files>
  <action>
**src/app/api/loans/route.ts:**
- GET: List loans. RBAC: Employees see own loans, ADMIN/HR_MANAGER/PAYROLL_MANAGER see all. Support ?employee_id and ?status filters. Return with employee name and calculated fields.
- POST: Create loan. RBAC: ADMIN, HR_MANAGER, PAYROLL_MANAGER only. Validate with CreateLoanSchema. Calculate EMI, total interest, total repayment, end date using workflow functions. Create loan in PENDING status. Pre-create LoanDeduction records (SCHEDULED) for each month of tenure using amortization schedule.

**src/app/api/loans/[id]/route.ts:**
- GET: Get loan by ID with employee details and deductions summary (paid count, remaining count).
- PATCH: Handle status actions:
  - action=disburse: PENDING->ACTIVE, set disbursement_date, set disbursed_paise
  - action=close: ACTIVE->CLOSED, set closed_at, requires remaining_balance_paise=0 OR closure_reason (early closure)
  - action=cancel: PENDING/ACTIVE->CANCELLED, requires closure_reason, delete SCHEDULED deductions
  RBAC: ADMIN, HR_MANAGER, PAYROLL_MANAGER only.
- DELETE: Only PENDING loans can be deleted.

**src/app/api/loans/[id]/schedule/route.ts:**
- GET: Get full amortization schedule for loan. Returns array of EMIScheduleEntry with month number, date (calculated from start_date), EMI, principal, interest, balance. Also returns summary: total principal, total interest, total repayment. For ACTIVE loans, mark past months as DEDUCTED/SKIPPED from LoanDeduction records.
  RBAC: Loan owner or admin.
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass. Run `pnpm lint` - should pass.</verify>
  <done>Loans can be created with auto-calculated EMI and schedule, status transitions work, schedule API returns full breakdown</done>
</task>

</tasks>

<verification>
1. `pnpm prisma validate` - schema valid
2. `pnpm tsc --noEmit` - no type errors
3. `pnpm test src/lib/workflows/loan.test.ts` - EMI tests pass
4. `pnpm lint` - no lint errors
5. Database has EmployeeLoan, LoanDeduction tables
</verification>

<success_criteria>
- Loans created with correct EMI calculation (reducing balance method)
- Amortization schedule shows correct principal/interest breakdown per month
- Schedule total equals principal + calculated interest
- LoanDeduction records pre-created for entire tenure
- Unique constraint prevents double deductions per month
- Employee can view own loans and schedules
</success_criteria>

<output>
After completion, create `.planning/phases/05-supporting-workflows/05-03-SUMMARY.md`
</output>
