---
phase: 05-supporting-workflows
plan: 04
type: execute
wave: 2
depends_on: ["05-02", "05-03"]
files_modified:
  - src/lib/queues/workers/payroll.worker.ts
  - src/lib/payroll/calculator.ts
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Approved expenses are added as reimbursement in next payroll"
    - "Active loan EMI is deducted from monthly salary"
    - "Payslip shows expense reimbursements and loan deductions separately"
    - "Expenses marked as synced after payroll processing"
    - "Loan deduction records updated with payroll run reference"
  artifacts:
    - path: "src/lib/payroll/calculator.ts"
      provides: "Updated payroll calculation with expenses and loans"
      contains: "reimbursements_paise"
    - path: "src/lib/queues/workers/payroll.worker.ts"
      provides: "Payroll worker with expense/loan sync"
      contains: "syncExpensesToPayroll"
    - path: "prisma/schema.prisma"
      provides: "PayrollRecord with reimbursement and loan fields"
      contains: "reimbursements_paise"
  key_links:
    - from: "src/lib/queues/workers/payroll.worker.ts"
      to: "prisma.expenseClaim"
      via: "expense sync query"
      pattern: "expenseClaim\\.findMany.*APPROVED"
    - from: "src/lib/queues/workers/payroll.worker.ts"
      to: "prisma.loanDeduction"
      via: "loan deduction query"
      pattern: "loanDeduction\\.findMany.*SCHEDULED"
---

<objective>
Integrate expense reimbursements and loan EMI deductions into the payroll calculation pipeline, ensuring approved expenses increase net pay and loan EMIs decrease net pay.

Purpose: Complete the financial integration so approved expenses are automatically reimbursed and loan EMIs are automatically deducted during payroll processing (EXP-05, LOAN-03).

Output: Updated payroll calculator and worker with expense/loan sync logic, PayrollRecord with new fields for tracking.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-supporting-workflows/05-RESEARCH.md
@src/lib/queues/workers/payroll.worker.ts
@src/lib/payroll/calculator.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add payroll fields for expenses and loans</name>
  <files>prisma/schema.prisma</files>
  <action>
Update PayrollRecord model to add new fields after other_deductions_paise:

```prisma
// Expense reimbursements (added to net pay)
reimbursements_paise Int @default(0)

// Loan deductions (subtracted from net pay)
loan_deductions_paise Int @default(0)
```

The net_salary_paise calculation will be:
gross_salary_paise - total_deductions_paise + reimbursements_paise - loan_deductions_paise

Add relation from PayrollRecord to track synced expenses:
- Add payroll_record_id to ExpenseClaim as optional relation field

Update ExpenseClaim model:
- Add payroll_record_id (String nullable)
- Add relation to PayrollRecord

Update LoanDeduction model:
- Add payroll_record_id (String nullable)
- Add relation to PayrollRecord

Run `pnpm db:push` after changes.
  </action>
  <verify>Run `pnpm prisma validate` - should pass with no errors</verify>
  <done>PayrollRecord has reimbursements_paise and loan_deductions_paise fields, relations to ExpenseClaim and LoanDeduction exist</done>
</task>

<task type="auto">
  <name>Task 2: Update payroll calculator with expense and loan integration</name>
  <files>src/lib/payroll/calculator.ts</files>
  <action>
Read existing calculator.ts and add expense/loan functions:

**Add new helper functions:**

```typescript
/**
 * Get approved expenses for an employee that haven't been synced to payroll
 */
async function getUnsyncedExpenses(employeeId: string, month: number, year: number): Promise<{
  total_paise: number;
  expense_ids: string[];
}> {
  // Find expenses where:
  // - employee_id matches
  // - status = APPROVED
  // - synced_to_payroll = false
  // - expense_date is in the payroll month or earlier (approved expenses for reimbursement)
  // Return sum of amount_paise and list of IDs
}

/**
 * Get scheduled loan deductions for an employee for the given month
 */
async function getScheduledLoanDeductions(employeeId: string, month: number, year: number): Promise<{
  total_paise: number;
  deductions: Array<{ deduction_id: string; loan_id: string; emi_paise: number; principal_paise: number; interest_paise: number }>;
}> {
  // Find LoanDeduction where:
  // - loan.employee_id matches
  // - month and year match
  // - status = SCHEDULED
  // - loan.status = ACTIVE
  // Return sum and breakdown
}
```

**Update calculateEmployeePayroll function:**

After calculating total_deductions_paise, add:

```typescript
// Get expense reimbursements
const expenses = await getUnsyncedExpenses(employeeId, month, year);
const reimbursements_paise = expenses.total_paise;

// Get loan deductions
const loans = await getScheduledLoanDeductions(employeeId, month, year);
const loan_deductions_paise = loans.total_paise;

// Updated net pay calculation
const net_salary_paise =
  gross_salary_paise -
  total_deductions_paise +
  reimbursements_paise -
  loan_deductions_paise;
```

Return reimbursements_paise, loan_deductions_paise, expense_ids, and loan_deduction_details in the result object.
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass with no type errors</verify>
  <done>Calculator returns reimbursements and loan deductions with correct net pay calculation</done>
</task>

<task type="auto">
  <name>Task 3: Update payroll worker to sync expenses and loans</name>
  <files>src/lib/queues/workers/payroll.worker.ts</files>
  <action>
Read existing payroll.worker.ts and update the calculation stage:

**In the CALCULATION stage, after creating PayrollRecord:**

Add sync logic that runs after each employee's payroll record is created:

```typescript
// After creating/updating PayrollRecord...

// Sync expenses: mark as synced and link to payroll record
if (calculationResult.expense_ids?.length > 0) {
  await prisma.expenseClaim.updateMany({
    where: { id: { in: calculationResult.expense_ids } },
    data: {
      synced_to_payroll: true,
      payroll_record_id: payrollRecord.id,
      status: 'REIMBURSED'  // Transition to REIMBURSED
    }
  });
}

// Sync loan deductions: mark as deducted and update loan balance
if (calculationResult.loan_deduction_details?.length > 0) {
  for (const deduction of calculationResult.loan_deduction_details) {
    await prisma.$transaction([
      // Update deduction status
      prisma.loanDeduction.update({
        where: { id: deduction.deduction_id },
        data: {
          status: 'DEDUCTED',
          payroll_run_id: payrollRun.id
        }
      }),
      // Update loan remaining balance
      prisma.employeeLoan.update({
        where: { id: deduction.loan_id },
        data: {
          remaining_balance_paise: {
            decrement: deduction.principal_paise
          }
        }
      })
    ]);

    // Check if loan is fully paid and close it
    const loan = await prisma.employeeLoan.findUnique({
      where: { id: deduction.loan_id }
    });
    if (loan && loan.remaining_balance_paise <= 0) {
      await prisma.employeeLoan.update({
        where: { id: deduction.loan_id },
        data: {
          status: 'CLOSED',
          closed_at: new Date(),
          remaining_balance_paise: 0  // Ensure it's exactly 0
        }
      });
    }
  }
}
```

**Update PayrollRecord upsert to include new fields:**

Add reimbursements_paise and loan_deductions_paise to the create/update data.

**Ensure net_salary_paise formula is updated:**

```typescript
net_salary_paise:
  calculationResult.gross_salary_paise -
  calculationResult.total_deductions_paise +
  calculationResult.reimbursements_paise -
  calculationResult.loan_deductions_paise
```
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass. Run `pnpm lint` - should pass.</verify>
  <done>Payroll worker syncs expenses as REIMBURSED, updates loan deductions as DEDUCTED, decrements loan balance, auto-closes paid loans</done>
</task>

</tasks>

<verification>
1. `pnpm prisma validate` - schema valid
2. `pnpm tsc --noEmit` - no type errors
3. `pnpm lint` - no lint errors
4. PayrollRecord has reimbursements_paise and loan_deductions_paise fields
</verification>

<success_criteria>
- Approved expenses fetched and added to payroll record as reimbursements
- Scheduled loan deductions fetched and deducted from net pay
- Expenses transitioned to REIMBURSED and linked to payroll record
- Loan deductions marked DEDUCTED with payroll reference
- Loan remaining balance decremented by principal paid
- Loans auto-close when balance reaches zero
- Net pay = gross - deductions + reimbursements - loan_emi
</success_criteria>

<output>
After completion, create `.planning/phases/05-supporting-workflows/05-04-SUMMARY.md`
</output>
