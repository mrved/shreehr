---
phase: 05-supporting-workflows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/onboarding.ts
  - src/lib/workflows/onboarding.ts
  - src/app/api/onboarding/route.ts
  - src/app/api/onboarding/[id]/route.ts
  - src/app/api/onboarding/[id]/checklist/route.ts
  - src/lib/email/templates/offer-letter-notification.ts
  - src/lib/email/templates/index.ts
autonomous: true

must_haves:
  truths:
    - "HR can create onboarding record with candidate details and checklist"
    - "HR can send digital offer letter notification to candidate"
    - "Candidate can accept offer via API action"
    - "HR can update checklist task completion status"
    - "System tracks onboarding status with valid transitions"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "OnboardingRecord and OnboardingChecklist models"
      contains: "model OnboardingRecord"
    - path: "src/lib/workflows/onboarding.ts"
      provides: "Status transition validation and default checklist"
      exports: ["canTransitionOnboarding", "generateDefaultChecklist"]
    - path: "src/app/api/onboarding/route.ts"
      provides: "List and create onboarding records"
      exports: ["GET", "POST"]
    - path: "src/app/api/onboarding/[id]/route.ts"
      provides: "Get, update status, cancel onboarding"
      exports: ["GET", "PATCH", "DELETE"]
  key_links:
    - from: "src/app/api/onboarding/route.ts"
      to: "prisma.onboardingRecord"
      via: "database query"
      pattern: "prisma\\.onboardingRecord\\.(findMany|create)"
    - from: "src/app/api/onboarding/[id]/route.ts"
      to: "src/lib/workflows/onboarding.ts"
      via: "status validation"
      pattern: "canTransitionOnboarding"
---

<objective>
Implement onboarding workflow data models and APIs for HR to create onboarding records, send offer letter notifications, track candidate acceptance, and manage task checklists.

Purpose: Enable digital onboarding process where HR can create checklists, candidates can accept offers, and stakeholders can track task completion (ONB-01, ONB-02, ONB-03, ONB-04, ONB-05).

Output: Prisma models, Zod validation schemas, workflow state machine, and API endpoints for onboarding CRUD with checklist management.
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-supporting-workflows/05-RESEARCH.md
@prisma/schema.prisma
@src/lib/validations/profile.ts
@src/lib/email/templates/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onboarding Prisma models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add OnboardingRecord model after InvestmentProofDocument with fields:
- id (cuid), employee_id (nullable - linked after acceptance), candidate_email, candidate_name, candidate_phone
- position, department_id, designation_id (with relations to Department/Designation)
- offered_salary_paise (Int), offer_date (DateTime), joining_date (DateTime)
- status (OnboardingStatus enum: PENDING, ACCEPTED, IN_PROGRESS, COMPLETED, CANCELLED)
- checklist (Json - array of checklist items validated with Zod)
- offer_sent_at, offer_accepted_at, completed_at (nullable DateTime)
- offer_token (String, unique - for candidate acceptance link)
- cancellation_reason (String, nullable)
- Audit fields: created_at, created_by, updated_at, updated_by

Add OnboardingStatus enum with values: PENDING, ACCEPTED, IN_PROGRESS, COMPLETED, CANCELLED

Add relation to User for created_by in User model (created_onboarding_records relation).

Run `pnpm db:push` after changes to sync schema.
  </action>
  <verify>Run `pnpm prisma validate` - should pass with no errors</verify>
  <done>OnboardingRecord model exists with all fields, OnboardingStatus enum defined, schema validates</done>
</task>

<task type="auto">
  <name>Task 2: Create onboarding validation schemas and workflow logic</name>
  <files>
    src/lib/validations/onboarding.ts
    src/lib/workflows/onboarding.ts
  </files>
  <action>
**src/lib/validations/onboarding.ts:**
Create Zod schemas following existing patterns (see investment.ts, profile.ts):
- ChecklistItemSchema: id (string), category (enum: IT, ADMIN, MANAGER, HR), title (string), description (optional), assignedTo (string), dueDate (optional date), completedAt (optional date), completedBy (optional string), required (boolean)
- CreateOnboardingSchema: candidate_email (email), candidate_name (string min 2), candidate_phone (Indian phone regex), position (string), department_id (cuid), designation_id (cuid), offered_salary_paise (positive int), joining_date (future date), checklist (array of ChecklistItemSchema, min 1 item)
- UpdateOnboardingStatusSchema: action (enum: accept, start_tasks, complete, cancel), cancellation_reason (required if action=cancel)
- UpdateChecklistSchema: item_id (string), completed (boolean)

**src/lib/workflows/onboarding.ts:**
Create workflow helpers:
- ALLOWED_TRANSITIONS constant: Record<OnboardingStatus, OnboardingStatus[]> mapping valid transitions (PENDING->ACCEPTED/CANCELLED, ACCEPTED->IN_PROGRESS/CANCELLED, IN_PROGRESS->COMPLETED/CANCELLED, COMPLETED->[], CANCELLED->[])
- canTransitionOnboarding(from, to) function returning { valid: boolean, error?: string }
- generateDefaultChecklist(joiningDate: Date) function returning default items: IT laptop provisioning (2 days before), IT email creation (1 day before), Admin desk assignment (1 day before), HR documentation (on join date), Manager welcome meeting (on join date)
- calculateChecklistProgress(items: ChecklistItem[]) returning { total, completed, percentage }
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass with no type errors</verify>
  <done>Validation schemas export correctly, workflow functions export canTransitionOnboarding, generateDefaultChecklist, calculateChecklistProgress</done>
</task>

<task type="auto">
  <name>Task 3: Create onboarding API endpoints and email template</name>
  <files>
    src/app/api/onboarding/route.ts
    src/app/api/onboarding/[id]/route.ts
    src/app/api/onboarding/[id]/checklist/route.ts
    src/lib/email/templates/offer-letter-notification.ts
    src/lib/email/templates/index.ts
  </files>
  <action>
**src/app/api/onboarding/route.ts:**
- GET: List onboarding records with optional status filter. RBAC: ADMIN, HR_MANAGER can list all. Include department, designation relations. Support ?status=PENDING query param.
- POST: Create onboarding record. RBAC: ADMIN, HR_MANAGER only. Validate with CreateOnboardingSchema. Generate unique offer_token with crypto.randomUUID(). If checklist not provided, use generateDefaultChecklist(). Queue offer letter notification email via addEmailJob. Return created record.

**src/app/api/onboarding/[id]/route.ts:**
- GET: Get onboarding record by ID. RBAC: ADMIN, HR_MANAGER, or employee linked to record.
- PATCH: Update onboarding status via action. Validate with UpdateOnboardingStatusSchema. Use canTransitionOnboarding to validate transition. For action=accept: verify offer_token from body, set offer_accepted_at, transition to ACCEPTED. For action=start_tasks: transition to IN_PROGRESS. For action=complete: verify all required checklist items completed, transition to COMPLETED, set completed_at. For action=cancel: require cancellation_reason.
- DELETE: Soft delete by setting status to CANCELLED (only if status is PENDING).

**src/app/api/onboarding/[id]/checklist/route.ts:**
- PATCH: Update checklist item completion. Validate with UpdateChecklistSchema. Find item by item_id in checklist JSON, update completedAt and completedBy fields. RBAC: ADMIN, HR_MANAGER, or user matching item's assignedTo.

**src/lib/email/templates/offer-letter-notification.ts:**
Create template following payslip-notification.ts pattern:
- Export offerLetterNotification function taking { candidateName, position, companyName, joiningDate, acceptUrl }
- Return { subject: "Offer Letter from {companyName}", html: styled email with accept button linking to acceptUrl, text: plain text version }

**src/lib/email/templates/index.ts:**
Add offerLetterNotification to TEMPLATES registry with key "offer-letter".
  </action>
  <verify>Run `pnpm tsc --noEmit` - should pass. Run `pnpm lint` - should pass.</verify>
  <done>All API endpoints return correct responses, email template registered, offer notification queued on create</done>
</task>

</tasks>

<verification>
1. `pnpm prisma validate` - schema valid
2. `pnpm tsc --noEmit` - no type errors
3. `pnpm lint` - no lint errors
4. Database has OnboardingRecord table after `pnpm db:push`
</verification>

<success_criteria>
- OnboardingRecord model exists with status enum and checklist JSON field
- POST /api/onboarding creates record with generated checklist and queues email
- PATCH /api/onboarding/[id] validates status transitions correctly
- PATCH /api/onboarding/[id]/checklist updates individual checklist items
- Default checklist generated with IT, Admin, HR, Manager tasks
</success_criteria>

<output>
After completion, create `.planning/phases/05-supporting-workflows/05-01-SUMMARY.md`
</output>
