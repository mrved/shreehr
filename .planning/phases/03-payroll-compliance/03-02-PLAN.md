---
phase: 03-payroll-compliance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/payroll/constants.ts
  - src/lib/statutory/pt.ts
  - src/app/api/pt-slabs/route.ts
  - src/app/api/pt-slabs/[state]/route.ts
  - prisma/seed-pt-slabs.ts
autonomous: true

must_haves:
  truths:
    - "Admin can configure PT slabs for different states"
    - "System calculates correct PT based on employee work state and salary"
    - "Karnataka February PT is Rs.300 (not Rs.200) for proper annual total"
    - "PT calculation respects gender-based exemptions (if configured)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ProfessionalTaxSlab model"
      contains: "model ProfessionalTaxSlab"
    - path: "src/lib/statutory/pt.ts"
      provides: "PT calculation function"
      exports: ["calculatePT", "getPTSlabsForState"]
    - path: "prisma/seed-pt-slabs.ts"
      provides: "Default PT slabs for Karnataka, Maharashtra, Tamil Nadu"
  key_links:
    - from: "src/lib/statutory/pt.ts"
      to: "prisma.professionalTaxSlab"
      via: "database query"
      pattern: "prisma\\.professionalTaxSlab\\.findFirst"
---

<objective>
Create Professional Tax configuration system with state-wise slabs

Purpose: Professional Tax varies by state in India with different slabs, rates, and rules (gender-based exemptions, February special rates). A database-driven configuration allows runtime updates without code changes when states revise their slabs.

Output:
- ProfessionalTaxSlab model in Prisma schema
- PT calculation utility with state-specific logic
- CRUD API for PT slab management
- Seed data for Karnataka, Maharashtra, Tamil Nadu
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payroll-compliance/03-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfessionalTaxSlab model and constants</name>
  <files>
    prisma/schema.prisma
    src/lib/payroll/constants.ts
  </files>
  <action>
1. Add ProfessionalTaxSlab model to schema.prisma:
   ```prisma
   model ProfessionalTaxSlab {
     id String @id @default(cuid())

     state         String  // State code: "KA", "MH", "TN", "AP", etc.
     state_name    String  // Full name: "Karnataka", "Maharashtra"

     // Salary range in paise
     min_salary_paise Int
     max_salary_paise Int? // null = no upper limit

     // Gender filter (null = all genders)
     gender String? // "MALE", "FEMALE", null

     // Tax amounts in paise
     monthly_tax_paise  Int
     february_tax_paise Int // Karnataka has higher February rate

     // For states with different payment frequencies
     payment_frequency PaymentFrequency @default(MONTHLY)

     is_active Boolean @default(true)

     // Audit fields
     created_at DateTime @default(now())
     updated_at DateTime @updatedAt

     @@index([state, is_active])
     @@index([state, min_salary_paise])
     @@map("professional_tax_slabs")
   }

   enum PaymentFrequency {
     MONTHLY
     HALF_YEARLY  // Some states like West Bengal
     ANNUAL
   }
   ```

2. Create src/lib/payroll/constants.ts with statutory constants:
   ```typescript
   // Professional Tax Constants
   export const PT_ANNUAL_MAX_PAISE = 250000; // Rs.2,500 max PT per year

   // State codes
   export const INDIAN_STATES = {
     AP: 'Andhra Pradesh',
     AR: 'Arunachal Pradesh',
     AS: 'Assam',
     BR: 'Bihar',
     CG: 'Chhattisgarh',
     GA: 'Goa',
     GJ: 'Gujarat',
     HR: 'Haryana',
     HP: 'Himachal Pradesh',
     JH: 'Jharkhand',
     KA: 'Karnataka',
     KL: 'Kerala',
     MP: 'Madhya Pradesh',
     MH: 'Maharashtra',
     MN: 'Manipur',
     ML: 'Meghalaya',
     MZ: 'Mizoram',
     NL: 'Nagaland',
     OD: 'Odisha',
     PB: 'Punjab',
     RJ: 'Rajasthan',
     SK: 'Sikkim',
     TN: 'Tamil Nadu',
     TS: 'Telangana',
     TR: 'Tripura',
     UK: 'Uttarakhand',
     UP: 'Uttar Pradesh',
     WB: 'West Bengal',
     DL: 'Delhi',
   } as const;

   export type StateCode = keyof typeof INDIAN_STATES;

   // PF Constants
   export const PF_EMPLOYEE_RATE = 0.12; // 12%
   export const PF_EMPLOYER_RATE = 0.12; // 12% total (3.67% EPF + 8.33% EPS)
   export const PF_WAGE_CEILING_PAISE = 1500000; // Rs.15,000
   export const EPS_MAX_MONTHLY_PAISE = 125000; // Rs.1,250 max EPS contribution

   // EPF breakdown of employer 12%
   export const EPF_EMPLOYER_RATE = 0.0367; // 3.67% to EPF
   export const EPS_RATE = 0.0833; // 8.33% to EPS (capped at Rs.1,250)
   export const EDLI_RATE = 0.005; // 0.50% to EDLI
   export const PF_ADMIN_RATE = 0.0051; // 0.50% admin + 0.01%

   // ESI Constants
   export const ESI_EMPLOYEE_RATE = 0.0075; // 0.75%
   export const ESI_EMPLOYER_RATE = 0.0325; // 3.25%
   export const ESI_WAGE_CEILING_PAISE = 2100000; // Rs.21,000

   // TDS Constants
   export const TDS_STANDARD_DEDUCTION_PAISE = 7500000; // Rs.75,000 (Budget 2024)
   ```

3. Run `pnpm db:push` to update database schema.
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - `pnpm db:push` succeeds
    - ProfessionalTaxSlab table created in database
  </verify>
  <done>
    ProfessionalTaxSlab model exists with state, salary range, gender filter, and February special rate fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PT calculation utility and API</name>
  <files>
    src/lib/statutory/pt.ts
    src/app/api/pt-slabs/route.ts
    src/app/api/pt-slabs/[state]/route.ts
  </files>
  <action>
1. Create src/lib/statutory/pt.ts:
   ```typescript
   import { prisma } from '@/lib/db';
   import { INDIAN_STATES, type StateCode } from '@/lib/payroll/constants';

   export interface PTCalculationResult {
     applicable: boolean;
     monthlyPTpaise: number;
     slabId?: string;
     reason?: string;
   }

   /**
    * Calculate Professional Tax for an employee
    *
    * @param stateCode - Employee's work state code (e.g., "KA", "MH")
    * @param grossSalaryPaise - Monthly gross salary in paise
    * @param month - Month number (1-12), needed for February special rate
    * @param gender - Employee gender for exemption rules
    */
   export async function calculatePT(
     stateCode: string,
     grossSalaryPaise: number,
     month: number,
     gender?: string
   ): Promise<PTCalculationResult> {
     // Find applicable slab
     const slab = await prisma.professionalTaxSlab.findFirst({
       where: {
         state: stateCode.toUpperCase(),
         is_active: true,
         min_salary_paise: { lte: grossSalaryPaise },
         OR: [
           { max_salary_paise: { gte: grossSalaryPaise } },
           { max_salary_paise: null } // No upper limit
         ],
         // Gender filter: either matches or no filter set
         ...(gender ? {
           OR: [
             { gender: gender.toUpperCase() },
             { gender: null }
           ]
         } : { gender: null })
       },
       orderBy: {
         min_salary_paise: 'desc' // Get most specific slab
       }
     });

     if (!slab) {
       // No applicable slab found - could be exempt state or below threshold
       return {
         applicable: false,
         monthlyPTpaise: 0,
         reason: `No PT slab found for state ${stateCode} at salary level`
       };
     }

     // February has special rate in some states (like Karnataka)
     const isFebruary = month === 2;
     const ptAmount = isFebruary ? slab.february_tax_paise : slab.monthly_tax_paise;

     return {
       applicable: true,
       monthlyPTpaise: ptAmount,
       slabId: slab.id
     };
   }

   /**
    * Get all PT slabs for a state
    */
   export async function getPTSlabsForState(stateCode: string) {
     return prisma.professionalTaxSlab.findMany({
       where: {
         state: stateCode.toUpperCase(),
         is_active: true
       },
       orderBy: { min_salary_paise: 'asc' }
     });
   }

   /**
    * Get all active states with PT configuration
    */
   export async function getConfiguredPTStates() {
     const states = await prisma.professionalTaxSlab.findMany({
       where: { is_active: true },
       select: { state: true, state_name: true },
       distinct: ['state']
     });

     return states.map(s => ({
       code: s.state,
       name: s.state_name
     }));
   }

   /**
    * Validate state code
    */
   export function isValidStateCode(code: string): code is StateCode {
     return code.toUpperCase() in INDIAN_STATES;
   }
   ```

2. Create src/app/api/pt-slabs/route.ts:
   ```typescript
   import { NextRequest, NextResponse } from 'next/server';
   import { getServerSession } from 'next-auth';
   import { authOptions } from '@/lib/auth-options';
   import { prisma } from '@/lib/db';
   import { z } from 'zod';
   import { INDIAN_STATES, type StateCode } from '@/lib/payroll/constants';

   const ptSlabSchema = z.object({
     state: z.string().length(2).transform(s => s.toUpperCase()),
     state_name: z.string().min(2),
     min_salary_paise: z.number().int().min(0),
     max_salary_paise: z.number().int().positive().optional().nullable(),
     gender: z.enum(['MALE', 'FEMALE']).optional().nullable(),
     monthly_tax_paise: z.number().int().min(0),
     february_tax_paise: z.number().int().min(0),
     payment_frequency: z.enum(['MONTHLY', 'HALF_YEARLY', 'ANNUAL']).default('MONTHLY'),
     is_active: z.boolean().default(true)
   });

   // GET /api/pt-slabs - List all PT slabs
   export async function GET(request: NextRequest) {
     const session = await getServerSession(authOptions);
     if (!session?.user) {
       return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
     }

     const { searchParams } = new URL(request.url);
     const state = searchParams.get('state');
     const activeOnly = searchParams.get('active_only') !== 'false';

     const where: any = {};
     if (state) {
       where.state = state.toUpperCase();
     }
     if (activeOnly) {
       where.is_active = true;
     }

     const slabs = await prisma.professionalTaxSlab.findMany({
       where,
       orderBy: [
         { state: 'asc' },
         { min_salary_paise: 'asc' }
       ]
     });

     // Group by state for easier consumption
     const grouped = slabs.reduce((acc, slab) => {
       if (!acc[slab.state]) {
         acc[slab.state] = {
           code: slab.state,
           name: slab.state_name,
           slabs: []
         };
       }
       acc[slab.state].slabs.push(slab);
       return acc;
     }, {} as Record<string, { code: string; name: string; slabs: typeof slabs }>);

     return NextResponse.json({
       data: Object.values(grouped),
       available_states: INDIAN_STATES
     });
   }

   // POST /api/pt-slabs - Create PT slab
   export async function POST(request: NextRequest) {
     const session = await getServerSession(authOptions);
     if (!session?.user) {
       return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
     }

     // Only ADMIN can configure PT slabs
     if (!['SUPER_ADMIN', 'ADMIN'].includes(session.user.role)) {
       return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
     }

     try {
       const body = await request.json();
       const validated = ptSlabSchema.parse(body);

       // Validate state code
       if (!(validated.state in INDIAN_STATES)) {
         return NextResponse.json(
           { error: `Invalid state code: ${validated.state}` },
           { status: 400 }
         );
       }

       const slab = await prisma.professionalTaxSlab.create({
         data: validated
       });

       return NextResponse.json({ data: slab }, { status: 201 });

     } catch (error: any) {
       if (error.name === 'ZodError') {
         return NextResponse.json(
           { error: 'Validation failed', details: error.errors },
           { status: 400 }
         );
       }

       console.error('Create PT slab error:', error);
       return NextResponse.json(
         { error: 'Failed to create PT slab' },
         { status: 500 }
       );
     }
   }
   ```

3. Create src/app/api/pt-slabs/[state]/route.ts:
   ```typescript
   import { NextRequest, NextResponse } from 'next/server';
   import { getServerSession } from 'next-auth';
   import { authOptions } from '@/lib/auth-options';
   import { prisma } from '@/lib/db';
   import { getPTSlabsForState } from '@/lib/statutory/pt';

   // GET /api/pt-slabs/[state] - Get slabs for specific state
   export async function GET(
     request: NextRequest,
     { params }: { params: Promise<{ state: string }> }
   ) {
     const session = await getServerSession(authOptions);
     if (!session?.user) {
       return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
     }

     const { state } = await params;
     const slabs = await getPTSlabsForState(state);

     if (slabs.length === 0) {
       return NextResponse.json(
         { error: `No PT slabs configured for state: ${state}` },
         { status: 404 }
       );
     }

     return NextResponse.json({
       data: {
         code: state.toUpperCase(),
         name: slabs[0].state_name,
         slabs
       }
     });
   }

   // DELETE /api/pt-slabs/[state] - Delete all slabs for state
   export async function DELETE(
     request: NextRequest,
     { params }: { params: Promise<{ state: string }> }
   ) {
     const session = await getServerSession(authOptions);
     if (!session?.user) {
       return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
     }

     if (!['SUPER_ADMIN', 'ADMIN'].includes(session.user.role)) {
       return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
     }

     const { state } = await params;

     const result = await prisma.professionalTaxSlab.deleteMany({
       where: { state: state.toUpperCase() }
     });

     return NextResponse.json({
       message: `Deleted ${result.count} PT slabs for ${state}`
     });
   }
   ```
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - calculatePT returns correct monthly amount for a given state/salary
    - calculatePT returns higher amount for February in Karnataka
  </verify>
  <done>
    PT calculation utility and CRUD API created with state-specific logic and February special rate handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PT seed data for common states</name>
  <files>
    prisma/seed-pt-slabs.ts
    package.json
  </files>
  <action>
Create prisma/seed-pt-slabs.ts with default PT slabs for Karnataka, Maharashtra, Tamil Nadu:

```typescript
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// PT rates for FY 2025-26
// All amounts in paise (100 paise = 1 rupee)

const karnatakaPTSlabs = [
  // Karnataka PT: Up to Rs.15,000 - Nil
  {
    state: 'KA',
    state_name: 'Karnataka',
    min_salary_paise: 0,
    max_salary_paise: 1500000,
    monthly_tax_paise: 0,
    february_tax_paise: 0,
  },
  // Rs.15,001 - Rs.25,000 - Rs.200/month (Rs.300 in Feb for Rs.2,400 annual)
  {
    state: 'KA',
    state_name: 'Karnataka',
    min_salary_paise: 1500001,
    max_salary_paise: 2500000,
    monthly_tax_paise: 20000,
    february_tax_paise: 30000, // Higher in February
  },
  // Above Rs.25,000 - Rs.200/month (Rs.300 in Feb)
  {
    state: 'KA',
    state_name: 'Karnataka',
    min_salary_paise: 2500001,
    max_salary_paise: null,
    monthly_tax_paise: 20000,
    february_tax_paise: 30000,
  },
];

const maharashtraPTSlabs = [
  // Maharashtra PT: Up to Rs.7,500 - Nil
  {
    state: 'MH',
    state_name: 'Maharashtra',
    min_salary_paise: 0,
    max_salary_paise: 750000,
    gender: null,
    monthly_tax_paise: 0,
    february_tax_paise: 0,
  },
  // Rs.7,501 - Rs.10,000 - Rs.175/month
  {
    state: 'MH',
    state_name: 'Maharashtra',
    min_salary_paise: 750001,
    max_salary_paise: 1000000,
    gender: 'MALE',
    monthly_tax_paise: 17500,
    february_tax_paise: 17500,
  },
  // Rs.7,501 - Rs.10,000 - Nil for Female
  {
    state: 'MH',
    state_name: 'Maharashtra',
    min_salary_paise: 750001,
    max_salary_paise: 1000000,
    gender: 'FEMALE',
    monthly_tax_paise: 0,
    february_tax_paise: 0,
  },
  // Above Rs.10,000 - Rs.200/month (Rs.300 in Feb)
  {
    state: 'MH',
    state_name: 'Maharashtra',
    min_salary_paise: 1000001,
    max_salary_paise: null,
    gender: null,
    monthly_tax_paise: 20000,
    february_tax_paise: 30000,
  },
];

const tamilNaduPTSlabs = [
  // Tamil Nadu PT: Up to Rs.21,000 - Nil
  {
    state: 'TN',
    state_name: 'Tamil Nadu',
    min_salary_paise: 0,
    max_salary_paise: 2100000,
    monthly_tax_paise: 0,
    february_tax_paise: 0,
  },
  // Rs.21,001 - Rs.30,000 - Rs.100/month
  {
    state: 'TN',
    state_name: 'Tamil Nadu',
    min_salary_paise: 2100001,
    max_salary_paise: 3000000,
    monthly_tax_paise: 10000,
    february_tax_paise: 10000,
  },
  // Rs.30,001 - Rs.45,000 - Rs.235/month
  {
    state: 'TN',
    state_name: 'Tamil Nadu',
    min_salary_paise: 3000001,
    max_salary_paise: 4500000,
    monthly_tax_paise: 23500,
    february_tax_paise: 23500,
  },
  // Rs.45,001 - Rs.60,000 - Rs.510/month
  {
    state: 'TN',
    state_name: 'Tamil Nadu',
    min_salary_paise: 4500001,
    max_salary_paise: 6000000,
    monthly_tax_paise: 51000,
    february_tax_paise: 51000,
  },
  // Rs.60,001 - Rs.75,000 - Rs.760/month
  {
    state: 'TN',
    state_name: 'Tamil Nadu',
    min_salary_paise: 6000001,
    max_salary_paise: 7500000,
    monthly_tax_paise: 76000,
    february_tax_paise: 76000,
  },
  // Above Rs.75,000 - Rs.1,095/month
  {
    state: 'TN',
    state_name: 'Tamil Nadu',
    min_salary_paise: 7500001,
    max_salary_paise: null,
    monthly_tax_paise: 109500,
    february_tax_paise: 109500,
  },
];

const telanganaPTSlabs = [
  // Telangana PT: Up to Rs.15,000 - Nil
  {
    state: 'TS',
    state_name: 'Telangana',
    min_salary_paise: 0,
    max_salary_paise: 1500000,
    monthly_tax_paise: 0,
    february_tax_paise: 0,
  },
  // Rs.15,001 - Rs.20,000 - Rs.150/month
  {
    state: 'TS',
    state_name: 'Telangana',
    min_salary_paise: 1500001,
    max_salary_paise: 2000000,
    monthly_tax_paise: 15000,
    february_tax_paise: 15000,
  },
  // Above Rs.20,000 - Rs.200/month
  {
    state: 'TS',
    state_name: 'Telangana',
    min_salary_paise: 2000001,
    max_salary_paise: null,
    monthly_tax_paise: 20000,
    february_tax_paise: 20000,
  },
];

async function seedPTSlabs() {
  console.log('Seeding PT slabs...');

  // Clear existing slabs
  await prisma.professionalTaxSlab.deleteMany({});

  // Insert all slabs
  const allSlabs = [
    ...karnatakaPTSlabs,
    ...maharashtraPTSlabs,
    ...tamilNaduPTSlabs,
    ...telanganaPTSlabs,
  ].map(slab => ({
    ...slab,
    payment_frequency: 'MONTHLY' as const,
    is_active: true,
  }));

  const result = await prisma.professionalTaxSlab.createMany({
    data: allSlabs,
  });

  console.log(`Created ${result.count} PT slabs for KA, MH, TN, TS`);

  // Print summary
  const summary = await prisma.professionalTaxSlab.groupBy({
    by: ['state'],
    _count: true,
  });

  console.log('\nPT Slabs by state:');
  for (const s of summary) {
    console.log(`  ${s.state}: ${s._count} slabs`);
  }
}

seedPTSlabs()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

Add script to package.json:
```json
{
  "scripts": {
    "db:seed-pt": "npx tsx prisma/seed-pt-slabs.ts"
  }
}
```
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - `pnpm db:seed-pt` runs successfully
    - PT slabs created for KA, MH, TN, TS in database
  </verify>
  <done>
    PT seed data created for Karnataka, Maharashtra, Tamil Nadu, Telangana with correct slabs including February special rates and gender exemptions
  </done>
</task>

</tasks>

<verification>
1. Database: ProfessionalTaxSlab table exists with correct columns
2. Calculation: PT correctly applies state slabs with February special rate
3. API: CRUD operations work with RBAC (ADMIN only for create/delete)
4. Seed: Running seed creates slabs for KA, MH, TN, TS
</verification>

<success_criteria>
- [ ] ProfessionalTaxSlab model added to Prisma schema
- [ ] calculatePT returns Rs.200 for Karnataka in non-February months
- [ ] calculatePT returns Rs.300 for Karnataka in February
- [ ] Maharashtra female exemption (Rs.7,501-10,000) works
- [ ] API allows admin to add slabs for new states
</success_criteria>

<output>
After completion, create `.planning/phases/03-payroll-compliance/03-02-SUMMARY.md`
</output>
