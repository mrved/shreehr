---
phase: 03-payroll-compliance
plan: 09
type: execute
wave: 5
depends_on: ["03-04", "03-05", "03-06"]
files_modified:
  - src/app/(dashboard)/payroll/page.tsx
  - src/app/(dashboard)/payroll/run/page.tsx
  - src/app/(dashboard)/payroll/[runId]/page.tsx
  - src/app/(dashboard)/payroll/salary-structures/page.tsx
  - src/components/payroll/payroll-run-form.tsx
  - src/components/payroll/payroll-records-table.tsx
  - src/components/payroll/salary-structure-form.tsx
  - src/app/api/payroll/run/route.ts
autonomous: false

must_haves:
  truths:
    - "Admin can view payroll dashboard with recent runs and deadlines"
    - "Admin can initiate monthly payroll run with progress tracking"
    - "Admin can view payroll records for completed run"
    - "Admin can configure salary structures for employees"
    - "Admin can download payslips and statutory files from UI"
  artifacts:
    - path: "src/app/(dashboard)/payroll/page.tsx"
      provides: "Payroll dashboard page"
    - path: "src/app/(dashboard)/payroll/run/page.tsx"
      provides: "Run payroll wizard page"
    - path: "src/components/payroll/payroll-run-form.tsx"
      provides: "Payroll run initiation form"
    - path: "src/components/payroll/payroll-records-table.tsx"
      provides: "Payroll records data table"
  key_links:
    - from: "src/components/payroll/payroll-run-form.tsx"
      to: "/api/payroll/run"
      via: "form submission"
      pattern: "fetch.*api/payroll/run"
    - from: "src/app/(dashboard)/payroll/[runId]/page.tsx"
      to: "src/components/payroll/payroll-records-table.tsx"
      via: "component import"
      pattern: "PayrollRecordsTable"
---

<objective>
Create payroll admin UI with dashboard, payroll run wizard, and record viewing

Purpose: Admin needs a comprehensive interface to manage payroll operations - running monthly payroll, viewing results, downloading reports, and managing salary structures. This UI ties together all the backend functionality built in previous plans.

Output:
- Payroll dashboard with recent runs and deadline summary
- Payroll run wizard with validation and progress
- Payroll records table with download links
- Salary structure management page
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payroll-compliance/03-04-SUMMARY.md
@.planning/phases/03-payroll-compliance/03-05-SUMMARY.md
@.planning/phases/03-payroll-compliance/03-06-SUMMARY.md
@src/app/(dashboard)/layout.tsx
@src/components/ui/button.tsx
@src/components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payroll run API and dashboard page</name>
  <files>
    src/app/api/payroll/run/route.ts
    src/app/api/payroll/runs/route.ts
    src/app/(dashboard)/payroll/page.tsx
  </files>
  <action>
1. Create src/app/api/payroll/run/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';
import { prisma } from '@/lib/db';
import { addPayrollJob } from '@/lib/queues/payroll.queue';

// POST /api/payroll/run - Initiate new payroll run
export async function POST(request: NextRequest) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  if (!['SUPER_ADMIN', 'ADMIN', 'PAYROLL_MANAGER'].includes(session.user.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  try {
    const { month, year } = await request.json();

    if (!month || !year) {
      return NextResponse.json(
        { error: 'Month and year are required' },
        { status: 400 }
      );
    }

    // Check if payroll already exists for this month
    const existing = await prisma.payrollRun.findUnique({
      where: { month_year: { month, year } },
    });

    if (existing && existing.status !== 'REVERTED') {
      return NextResponse.json(
        {
          error: `Payroll for ${year}-${month} already exists`,
          status: existing.status,
          id: existing.id,
        },
        { status: 400 }
      );
    }

    // Check attendance lock
    const lock = await prisma.attendanceLock.findUnique({
      where: { month_year: { month, year } },
    });

    if (!lock) {
      return NextResponse.json(
        { error: `Attendance not locked for ${year}-${month}. Lock attendance first.` },
        { status: 400 }
      );
    }

    // Create PayrollRun record
    const payrollRun = await prisma.payrollRun.create({
      data: {
        month,
        year,
        status: 'PENDING',
        current_stage: 'VALIDATION',
        created_by: session.user.id,
      },
    });

    // Queue the payroll job
    const job = await addPayrollJob({
      payrollRunId: payrollRun.id,
      month,
      year,
      stage: 'validation',
    });

    // Update with job ID
    await prisma.payrollRun.update({
      where: { id: payrollRun.id },
      data: { job_id: job.id },
    });

    return NextResponse.json({
      data: payrollRun,
      message: 'Payroll run initiated',
      jobId: job.id,
    }, { status: 201 });

  } catch (error: any) {
    console.error('Payroll run error:', error);
    return NextResponse.json(
      { error: 'Failed to initiate payroll run', details: error.message },
      { status: 500 }
    );
  }
}
```

2. Create src/app/api/payroll/runs/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';
import { prisma } from '@/lib/db';

// GET /api/payroll/runs - List payroll runs
export async function GET(request: NextRequest) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  if (!['SUPER_ADMIN', 'ADMIN', 'HR_MANAGER', 'PAYROLL_MANAGER'].includes(session.user.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  const { searchParams } = new URL(request.url);
  const year = searchParams.get('year');
  const status = searchParams.get('status');
  const limit = parseInt(searchParams.get('limit') || '12');

  const where: any = {};
  if (year) where.year = parseInt(year);
  if (status) where.status = status.toUpperCase();

  const runs = await prisma.payrollRun.findMany({
    where,
    orderBy: [{ year: 'desc' }, { month: 'desc' }],
    take: limit,
    include: {
      _count: {
        select: { records: true },
      },
    },
  });

  return NextResponse.json({ data: runs });
}
```

3. Create src/app/(dashboard)/payroll/page.tsx:
```typescript
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

interface PayrollRun {
  id: string;
  month: number;
  year: number;
  status: string;
  current_stage: string;
  total_employees: number;
  success_count: number;
  error_count: number;
  completed_at?: string;
  _count: { records: number };
}

const MONTHS = [
  'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
];

export default function PayrollDashboard() {
  const [runs, setRuns] = useState<PayrollRun[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchRuns();
  }, []);

  async function fetchRuns() {
    try {
      const res = await fetch('/api/payroll/runs?limit=12');
      const data = await res.json();
      setRuns(data.data || []);
    } catch (error) {
      console.error('Failed to fetch payroll runs:', error);
    } finally {
      setLoading(false);
    }
  }

  function getStatusColor(status: string) {
    switch (status) {
      case 'COMPLETED': return 'bg-green-100 text-green-800';
      case 'PROCESSING': return 'bg-blue-100 text-blue-800';
      case 'FAILED': return 'bg-red-100 text-red-800';
      case 'PENDING': return 'bg-yellow-100 text-yellow-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold">Payroll</h1>
        <div className="space-x-2">
          <Link href="/payroll/salary-structures">
            <Button variant="outline">Salary Structures</Button>
          </Link>
          <Link href="/payroll/run">
            <Button>Run Payroll</Button>
          </Link>
        </div>
      </div>

      {/* Quick Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-gray-500">
              Last Payroll
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-2xl font-bold">
              {runs[0] ? `${MONTHS[runs[0].month - 1]} ${runs[0].year}` : 'None'}
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-gray-500">
              Employees Processed
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-2xl font-bold">
              {runs[0]?._count?.records || 0}
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-gray-500">
              Status
            </CardTitle>
          </CardHeader>
          <CardContent>
            <span className={`px-2 py-1 rounded text-sm ${getStatusColor(runs[0]?.status || '')}`}>
              {runs[0]?.status || 'N/A'}
            </span>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-gray-500">
              Errors
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-2xl font-bold text-red-600">
              {runs[0]?.error_count || 0}
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Recent Payroll Runs */}
      <Card>
        <CardHeader>
          <CardTitle>Recent Payroll Runs</CardTitle>
        </CardHeader>
        <CardContent>
          {loading ? (
            <p className="text-gray-500">Loading...</p>
          ) : runs.length === 0 ? (
            <p className="text-gray-500">No payroll runs yet</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b">
                    <th className="text-left py-2">Period</th>
                    <th className="text-left py-2">Status</th>
                    <th className="text-left py-2">Employees</th>
                    <th className="text-left py-2">Completed</th>
                    <th className="text-left py-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {runs.map((run) => (
                    <tr key={run.id} className="border-b hover:bg-gray-50">
                      <td className="py-2">
                        {MONTHS[run.month - 1]} {run.year}
                      </td>
                      <td className="py-2">
                        <span className={`px-2 py-1 rounded text-xs ${getStatusColor(run.status)}`}>
                          {run.status}
                        </span>
                      </td>
                      <td className="py-2">{run._count.records}</td>
                      <td className="py-2">
                        {run.completed_at
                          ? new Date(run.completed_at).toLocaleDateString()
                          : '-'}
                      </td>
                      <td className="py-2">
                        <Link href={`/payroll/${run.id}`}>
                          <Button variant="outline" size="sm">View</Button>
                        </Link>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - POST /api/payroll/run initiates job and returns run ID
    - GET /api/payroll/runs returns list of payroll runs
    - Dashboard shows recent runs with status
  </verify>
  <done>
    Payroll run API and dashboard created with recent runs listing and quick stats
  </done>
</task>

<task type="auto">
  <name>Task 2: Create payroll run wizard and records view</name>
  <files>
    src/app/(dashboard)/payroll/run/page.tsx
    src/app/(dashboard)/payroll/[runId]/page.tsx
    src/components/payroll/payroll-run-form.tsx
    src/components/payroll/payroll-records-table.tsx
  </files>
  <action>
1. Create src/components/payroll/payroll-run-form.tsx:
```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';

const MONTHS = [
  { value: 1, label: 'January' },
  { value: 2, label: 'February' },
  { value: 3, label: 'March' },
  { value: 4, label: 'April' },
  { value: 5, label: 'May' },
  { value: 6, label: 'June' },
  { value: 7, label: 'July' },
  { value: 8, label: 'August' },
  { value: 9, label: 'September' },
  { value: 10, label: 'October' },
  { value: 11, label: 'November' },
  { value: 12, label: 'December' },
];

export function PayrollRunForm() {
  const router = useRouter();
  const currentDate = new Date();

  const [month, setMonth] = useState(currentDate.getMonth() + 1);
  const [year, setYear] = useState(currentDate.getFullYear());
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [validating, setValidating] = useState(false);
  const [validationResult, setValidationResult] = useState<any>(null);

  async function handleValidate() {
    setValidating(true);
    setError(null);

    try {
      // Check attendance lock
      const lockRes = await fetch(`/api/attendance/lock?month=${month}&year=${year}`);
      const lockData = await lockRes.json();

      if (!lockData.data) {
        setError(`Attendance is not locked for ${MONTHS[month - 1].label} ${year}. Please lock attendance first.`);
        setValidationResult(null);
        return;
      }

      // Check for existing payroll
      const runsRes = await fetch(`/api/payroll/runs?year=${year}`);
      const runsData = await runsRes.json();
      const existing = runsData.data?.find((r: any) => r.month === month && r.status !== 'REVERTED');

      if (existing) {
        setError(`Payroll for ${MONTHS[month - 1].label} ${year} already exists (${existing.status})`);
        setValidationResult(null);
        return;
      }

      // Get employee count
      const empRes = await fetch('/api/employees?status=ACTIVE&limit=1');
      const empData = await empRes.json();

      setValidationResult({
        attendanceLocked: true,
        employeeCount: empData.total || 0,
        period: `${MONTHS[month - 1].label} ${year}`,
      });

    } catch (err: any) {
      setError(err.message);
    } finally {
      setValidating(false);
    }
  }

  async function handleSubmit() {
    setLoading(true);
    setError(null);

    try {
      const res = await fetch('/api/payroll/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ month, year }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || 'Failed to start payroll');
      }

      // Redirect to payroll run detail page
      router.push(`/payroll/${data.data.id}`);

    } catch (err: any) {
      setError(err.message);
      setLoading(false);
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Run Monthly Payroll</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {error && (
          <div className="bg-red-50 text-red-600 p-3 rounded">
            {error}
          </div>
        )}

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Month</label>
            <select
              value={month}
              onChange={(e) => setMonth(parseInt(e.target.value))}
              className="w-full border rounded p-2"
            >
              {MONTHS.map((m) => (
                <option key={m.value} value={m.value}>{m.label}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Year</label>
            <select
              value={year}
              onChange={(e) => setYear(parseInt(e.target.value))}
              className="w-full border rounded p-2"
            >
              {[year - 1, year, year + 1].map((y) => (
                <option key={y} value={y}>{y}</option>
              ))}
            </select>
          </div>
        </div>

        <Button
          onClick={handleValidate}
          disabled={validating}
          variant="outline"
          className="w-full"
        >
          {validating ? 'Validating...' : 'Validate'}
        </Button>

        {validationResult && (
          <div className="bg-green-50 p-4 rounded space-y-2">
            <p className="font-medium text-green-800">Ready to run payroll!</p>
            <ul className="text-sm text-green-700 space-y-1">
              <li>Period: {validationResult.period}</li>
              <li>Attendance: Locked</li>
              <li>Employees: {validationResult.employeeCount}</li>
            </ul>
          </div>
        )}

        <Button
          onClick={handleSubmit}
          disabled={loading || !validationResult}
          className="w-full"
        >
          {loading ? 'Starting Payroll...' : 'Run Payroll'}
        </Button>
      </CardContent>
    </Card>
  );
}
```

2. Create src/app/(dashboard)/payroll/run/page.tsx:
```typescript
import { PayrollRunForm } from '@/components/payroll/payroll-run-form';

export default function RunPayrollPage() {
  return (
    <div className="max-w-2xl mx-auto">
      <h1 className="text-2xl font-bold mb-6">Run Monthly Payroll</h1>
      <PayrollRunForm />
    </div>
  );
}
```

3. Create src/components/payroll/payroll-records-table.tsx:
```typescript
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';

interface PayrollRecord {
  id: string;
  employee: {
    id: string;
    employee_code: string;
    first_name: string;
    last_name: string;
    department: { name: string };
  };
  gross_salary_paise: number;
  total_deductions_paise: number;
  net_salary_paise: number;
  status: string;
  error?: string;
}

interface Props {
  records: PayrollRecord[];
  runId: string;
}

function formatCurrency(paise: number): string {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    minimumFractionDigits: 0,
  }).format(paise / 100);
}

export function PayrollRecordsTable({ records, runId }: Props) {
  const [downloading, setDownloading] = useState<string | null>(null);

  async function downloadPayslip(employeeId: string) {
    setDownloading(employeeId);
    try {
      const res = await fetch(`/api/payroll/${runId}/payslips/${employeeId}`);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `payslip-${employeeId}.pdf`;
      a.click();
    } finally {
      setDownloading(null);
    }
  }

  return (
    <div className="overflow-x-auto">
      <table className="w-full">
        <thead>
          <tr className="border-b bg-gray-50">
            <th className="text-left py-3 px-2">Employee</th>
            <th className="text-left py-3 px-2">Department</th>
            <th className="text-right py-3 px-2">Gross</th>
            <th className="text-right py-3 px-2">Deductions</th>
            <th className="text-right py-3 px-2">Net Pay</th>
            <th className="text-left py-3 px-2">Status</th>
            <th className="text-left py-3 px-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          {records.map((record) => (
            <tr key={record.id} className="border-b hover:bg-gray-50">
              <td className="py-2 px-2">
                <div>
                  <p className="font-medium">
                    {record.employee.first_name} {record.employee.last_name}
                  </p>
                  <p className="text-xs text-gray-500">
                    {record.employee.employee_code}
                  </p>
                </div>
              </td>
              <td className="py-2 px-2 text-sm">
                {record.employee.department.name}
              </td>
              <td className="py-2 px-2 text-right">
                {formatCurrency(record.gross_salary_paise)}
              </td>
              <td className="py-2 px-2 text-right text-red-600">
                {formatCurrency(record.total_deductions_paise)}
              </td>
              <td className="py-2 px-2 text-right font-medium">
                {formatCurrency(record.net_salary_paise)}
              </td>
              <td className="py-2 px-2">
                <span className={`text-xs px-2 py-1 rounded ${
                  record.status === 'CALCULATED' || record.status === 'VERIFIED'
                    ? 'bg-green-100 text-green-800'
                    : record.status === 'ERROR'
                    ? 'bg-red-100 text-red-800'
                    : 'bg-gray-100'
                }`}>
                  {record.status}
                </span>
              </td>
              <td className="py-2 px-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => downloadPayslip(record.employee.id)}
                  disabled={downloading === record.employee.id}
                >
                  {downloading === record.employee.id ? '...' : 'Payslip'}
                </Button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

4. Create src/app/(dashboard)/payroll/[runId]/page.tsx:
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { PayrollRecordsTable } from '@/components/payroll/payroll-records-table';

const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

interface PayrollRun {
  id: string;
  month: number;
  year: number;
  status: string;
  current_stage: string;
  total_employees: number;
  processed_count: number;
  success_count: number;
  error_count: number;
  started_at?: string;
  completed_at?: string;
}

export default function PayrollRunDetailPage() {
  const params = useParams();
  const runId = params.runId as string;

  const [run, setRun] = useState<PayrollRun | null>(null);
  const [records, setRecords] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchData();
    // Poll for updates if processing
    const interval = setInterval(() => {
      if (run?.status === 'PROCESSING') {
        fetchData();
      }
    }, 3000);
    return () => clearInterval(interval);
  }, [runId, run?.status]);

  async function fetchData() {
    try {
      const [runRes, recordsRes] = await Promise.all([
        fetch(`/api/payroll/runs/${runId}`),
        fetch(`/api/payroll/runs/${runId}/records`),
      ]);

      const runData = await runRes.json();
      const recordsData = await recordsRes.json();

      setRun(runData.data);
      setRecords(recordsData.data || []);
    } catch (error) {
      console.error('Failed to fetch payroll data:', error);
    } finally {
      setLoading(false);
    }
  }

  if (loading) {
    return <div className="p-6">Loading...</div>;
  }

  if (!run) {
    return <div className="p-6">Payroll run not found</div>;
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold">
            Payroll: {MONTHS[run.month - 1]} {run.year}
          </h1>
          <p className="text-gray-500">
            {run.status === 'PROCESSING'
              ? `Processing... (${run.current_stage})`
              : run.status}
          </p>
        </div>

        <div className="space-x-2">
          {run.status === 'COMPLETED' && (
            <>
              <Link href={`/api/payroll/${runId}/statutory/ecr`}>
                <Button variant="outline">Download ECR</Button>
              </Link>
              <Link href={`/api/payroll/${runId}/statutory/esi`}>
                <Button variant="outline">Download ESI</Button>
              </Link>
              <Link href={`/api/payroll/${runId}/payslips/download-all`}>
                <Button>Download All Payslips</Button>
              </Link>
            </>
          )}
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardContent className="pt-4">
            <p className="text-sm text-gray-500">Total Employees</p>
            <p className="text-2xl font-bold">{run.total_employees}</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-4">
            <p className="text-sm text-gray-500">Processed</p>
            <p className="text-2xl font-bold">{run.processed_count}</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-4">
            <p className="text-sm text-gray-500">Success</p>
            <p className="text-2xl font-bold text-green-600">{run.success_count}</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-4">
            <p className="text-sm text-gray-500">Errors</p>
            <p className="text-2xl font-bold text-red-600">{run.error_count}</p>
          </CardContent>
        </Card>
      </div>

      {/* Processing Progress */}
      {run.status === 'PROCESSING' && (
        <Card>
          <CardContent className="pt-4">
            <div className="flex items-center space-x-4">
              <div className="flex-1">
                <div className="h-2 bg-gray-200 rounded">
                  <div
                    className="h-2 bg-blue-600 rounded transition-all"
                    style={{
                      width: `${(run.processed_count / run.total_employees) * 100}%`,
                    }}
                  />
                </div>
              </div>
              <span className="text-sm text-gray-500">
                {run.processed_count} / {run.total_employees}
              </span>
            </div>
            <p className="text-sm text-gray-500 mt-2">
              Current stage: {run.current_stage}
            </p>
          </CardContent>
        </Card>
      )}

      {/* Payroll Records */}
      <Card>
        <CardHeader>
          <CardTitle>Payroll Records</CardTitle>
        </CardHeader>
        <CardContent>
          {records.length === 0 ? (
            <p className="text-gray-500">No records yet</p>
          ) : (
            <PayrollRecordsTable records={records} runId={runId} />
          )}
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    - Payroll run form validates attendance lock before allowing run
    - Run detail page shows progress for processing runs
    - Records table displays all employees with net pay
    - Payslip download works from records table
  </verify>
  <done>
    Payroll run wizard and records view created with validation, progress tracking, and download links
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete payroll admin UI including:
- Payroll dashboard with recent runs
- Payroll run wizard with validation
- Payroll records table with individual payslip download
- Statutory file download links (ECR, ESI)
  </what-built>
  <how-to-verify>
1. Start the dev server: `pnpm dev`
2. Login as admin
3. Navigate to /payroll
   - Should see dashboard with recent runs (may be empty)
4. Click "Run Payroll"
   - Select a month/year
   - Click "Validate" - should show error if attendance not locked
5. If attendance is locked, click "Run Payroll"
   - Should redirect to detail page
   - Should show processing progress
6. After completion, verify:
   - Records table shows all employees
   - Payslip download works
   - ECR/ESI download buttons visible
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Dashboard shows recent payroll runs
2. Run wizard validates attendance lock
3. Progress tracking during processing
4. Records table with all deduction details
5. Download links work for payslips and statutory files
</verification>

<success_criteria>
- [ ] Payroll dashboard loads with recent runs
- [ ] Run wizard validates before starting
- [ ] Progress bar shows during processing
- [ ] Records table displays correctly
- [ ] Individual payslip download works
- [ ] Bulk payslip download works
- [ ] ECR/ESI download links visible for completed runs
</success_criteria>

<output>
After completion, create `.planning/phases/03-payroll-compliance/03-09-SUMMARY.md`
</output>
