---
phase: 03-payroll-compliance
plan: 05
type: execute
wave: 3
depends_on: ["03-04"]
files_modified:
  - src/lib/pdf/payslip.tsx
  - src/lib/pdf/components/index.tsx
  - src/app/api/payroll/[runId]/payslips/[employeeId]/route.ts
  - src/app/api/payroll/[runId]/payslips/download-all/route.ts
autonomous: true

must_haves:
  truths:
    - "System generates PDF payslip with all salary components"
    - "Payslip shows employee details (name, ID, PAN, UAN)"
    - "Payslip shows earnings breakdown (Basic, HRA, Allowances)"
    - "Payslip shows deductions breakdown (PF, ESI, PT, TDS)"
    - "Payslip shows net pay and paid days/LOP"
    - "Admin can download individual or bulk payslips"
  artifacts:
    - path: "src/lib/pdf/payslip.tsx"
      provides: "Payslip PDF React component"
      exports: ["PayslipDocument"]
    - path: "src/app/api/payroll/[runId]/payslips/[employeeId]/route.ts"
      provides: "Single payslip download API"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/payroll/[runId]/payslips/[employeeId]/route.ts"
      to: "src/lib/pdf/payslip.tsx"
      via: "renderToStream"
      pattern: "renderToStream.*PayslipDocument"
---

<objective>
Implement PDF payslip generation using @react-pdf/renderer

Purpose: Employees need downloadable payslips showing their monthly earnings, deductions, and net pay. The payslip serves as a legal document and must contain all statutory information including PF/ESI numbers.

Output:
- PayslipDocument React component for PDF generation
- API endpoint for individual payslip download
- Bulk download endpoint for all employees in a payroll run
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payroll-compliance/03-RESEARCH.md
@.planning/phases/03-payroll-compliance/03-04-SUMMARY.md
@src/lib/payroll/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @react-pdf/renderer and create PDF utilities</name>
  <files>
    package.json
    src/lib/pdf/components/index.tsx
    src/lib/pdf/utils.ts
  </files>
  <action>
1. Install @react-pdf/renderer:
   ```bash
   pnpm add @react-pdf/renderer
   ```

2. Create src/lib/pdf/utils.ts with helper functions:
```typescript
import { paiseToRupees } from '@/lib/payroll/types';

/**
 * Format currency for display on payslip
 */
export function formatCurrencyPDF(paise: number): string {
  const rupees = paiseToRupees(paise);
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(rupees);
}

/**
 * Format number with Indian numbering system
 */
export function formatNumberINR(num: number): string {
  return new Intl.NumberFormat('en-IN').format(num);
}

/**
 * Mask PAN for display (show only last 4)
 */
export function maskPAN(pan: string | null): string {
  if (!pan || pan.length < 4) return 'N/A';
  return 'XXXXXX' + pan.slice(-4);
}

/**
 * Mask Aadhaar for display (show only last 4)
 */
export function maskAadhaar(aadhaar: string | null): string {
  if (!aadhaar || aadhaar.length < 4) return 'N/A';
  return 'XXXX-XXXX-' + aadhaar.slice(-4);
}

/**
 * Get month name from number
 */
export function getMonthName(month: number): string {
  const months = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];
  return months[month - 1] || 'Unknown';
}

/**
 * Convert number to words (for net pay in words)
 */
export function numberToWords(num: number): string {
  if (num === 0) return 'Zero';

  const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
    'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
  const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

  function convertLessThanThousand(n: number): string {
    if (n === 0) return '';
    if (n < 20) return ones[n];
    if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
    return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' ' + convertLessThanThousand(n % 100) : '');
  }

  // Indian numbering: Lakh (1,00,000) and Crore (1,00,00,000)
  if (num >= 10000000) {
    return convertLessThanThousand(Math.floor(num / 10000000)) + ' Crore ' + numberToWords(num % 10000000);
  }
  if (num >= 100000) {
    return convertLessThanThousand(Math.floor(num / 100000)) + ' Lakh ' + numberToWords(num % 100000);
  }
  if (num >= 1000) {
    return convertLessThanThousand(Math.floor(num / 1000)) + ' Thousand ' + numberToWords(num % 1000);
  }

  return convertLessThanThousand(num);
}

/**
 * Format net pay in words
 */
export function formatNetPayInWords(paise: number): string {
  const rupees = Math.round(paiseToRupees(paise));
  return 'Rupees ' + numberToWords(rupees) + ' Only';
}
```

3. Create src/lib/pdf/components/index.tsx with reusable PDF components:
```typescript
import React from 'react';
import { View, Text, StyleSheet } from '@react-pdf/renderer';

// Shared styles
export const pdfStyles = StyleSheet.create({
  page: {
    padding: 30,
    fontSize: 10,
    fontFamily: 'Helvetica',
    backgroundColor: '#FFFFFF',
  },
  header: {
    marginBottom: 15,
    paddingBottom: 10,
    borderBottomWidth: 2,
    borderBottomColor: '#2563EB',
  },
  companyName: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#1E40AF',
    marginBottom: 2,
  },
  companyAddress: {
    fontSize: 8,
    color: '#6B7280',
  },
  title: {
    fontSize: 14,
    fontWeight: 'bold',
    textAlign: 'center',
    marginTop: 10,
    marginBottom: 5,
    color: '#1F2937',
  },
  periodText: {
    fontSize: 10,
    textAlign: 'center',
    color: '#4B5563',
    marginBottom: 15,
  },
  section: {
    marginBottom: 10,
  },
  sectionTitle: {
    fontSize: 11,
    fontWeight: 'bold',
    backgroundColor: '#F3F4F6',
    padding: 5,
    marginBottom: 5,
    color: '#374151',
  },
  row: {
    flexDirection: 'row',
    borderBottomWidth: 0.5,
    borderBottomColor: '#E5E7EB',
    paddingVertical: 3,
    paddingHorizontal: 5,
  },
  labelColumn: {
    width: '60%',
  },
  valueColumn: {
    width: '40%',
    textAlign: 'right',
  },
  label: {
    color: '#4B5563',
  },
  value: {
    fontWeight: 'bold',
    color: '#1F2937',
  },
  totalRow: {
    flexDirection: 'row',
    paddingVertical: 5,
    paddingHorizontal: 5,
    backgroundColor: '#EFF6FF',
    borderTopWidth: 1,
    borderTopColor: '#2563EB',
    marginTop: 5,
  },
  totalLabel: {
    width: '60%',
    fontWeight: 'bold',
    color: '#1E40AF',
  },
  totalValue: {
    width: '40%',
    textAlign: 'right',
    fontWeight: 'bold',
    color: '#1E40AF',
    fontSize: 11,
  },
  netPaySection: {
    marginTop: 15,
    padding: 10,
    backgroundColor: '#DBEAFE',
    borderRadius: 4,
  },
  netPayRow: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  netPayLabel: {
    width: '40%',
    fontSize: 12,
    fontWeight: 'bold',
    color: '#1E40AF',
  },
  netPayValue: {
    width: '60%',
    textAlign: 'right',
    fontSize: 14,
    fontWeight: 'bold',
    color: '#1E40AF',
  },
  netPayWords: {
    marginTop: 5,
    fontSize: 8,
    color: '#3B82F6',
    fontStyle: 'italic',
  },
  footer: {
    marginTop: 20,
    paddingTop: 10,
    borderTopWidth: 1,
    borderTopColor: '#E5E7EB',
    fontSize: 8,
    color: '#9CA3AF',
  },
  twoColumn: {
    flexDirection: 'row',
    marginBottom: 10,
  },
  column: {
    width: '50%',
    paddingRight: 10,
  },
});

// Reusable components
export function InfoRow({ label, value }: { label: string; value: string }) {
  return (
    <View style={pdfStyles.row}>
      <Text style={[pdfStyles.labelColumn, pdfStyles.label]}>{label}</Text>
      <Text style={[pdfStyles.valueColumn, pdfStyles.value]}>{value}</Text>
    </View>
  );
}

export function TotalRow({ label, value }: { label: string; value: string }) {
  return (
    <View style={pdfStyles.totalRow}>
      <Text style={pdfStyles.totalLabel}>{label}</Text>
      <Text style={pdfStyles.totalValue}>{value}</Text>
    </View>
  );
}

export function SectionTitle({ title }: { title: string }) {
  return <Text style={pdfStyles.sectionTitle}>{title}</Text>;
}
```
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - @react-pdf/renderer in package.json dependencies
    - Helper functions format currency and mask PAN correctly
  </verify>
  <done>
    PDF utilities and reusable components created for payslip generation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PayslipDocument component</name>
  <files>
    src/lib/pdf/payslip.tsx
  </files>
  <action>
Create src/lib/pdf/payslip.tsx with the full payslip layout:

```typescript
import React from 'react';
import {
  Document,
  Page,
  Text,
  View,
} from '@react-pdf/renderer';
import {
  pdfStyles,
  InfoRow,
  TotalRow,
  SectionTitle,
} from './components';
import {
  formatCurrencyPDF,
  maskPAN,
  getMonthName,
  formatNetPayInWords,
} from './utils';

export interface PayslipData {
  // Company info
  company: {
    name: string;
    address: string;
    pfCode?: string;
    esiCode?: string;
  };

  // Employee info
  employee: {
    id: string;
    code: string;
    name: string;
    designation: string;
    department: string;
    pan?: string;
    uan?: string;
    esicNumber?: string;
    bankAccount?: string;
    bankName?: string;
  };

  // Period info
  period: {
    month: number;
    year: number;
    workingDays: number;
    paidDays: number;
    lopDays: number;
  };

  // Earnings (in paise)
  earnings: {
    basic: number;
    hra: number;
    specialAllowance: number;
    lta: number;
    medical: number;
    conveyance: number;
    otherAllowances: number;
  };

  // Deductions (in paise)
  deductions: {
    pf: number;
    esi: number;
    pt: number;
    tds: number;
    otherDeductions: number;
    lopDeduction: number;
  };

  // Totals (in paise)
  grossBeforeLOP: number;
  grossSalary: number;
  totalDeductions: number;
  netPay: number;

  // Employer contributions (for info)
  employerPF: number;
  employerESI: number;
}

export function PayslipDocument({ data }: { data: PayslipData }) {
  const { company, employee, period, earnings, deductions } = data;

  return (
    <Document>
      <Page size="A4" style={pdfStyles.page}>
        {/* Header */}
        <View style={pdfStyles.header}>
          <Text style={pdfStyles.companyName}>{company.name}</Text>
          <Text style={pdfStyles.companyAddress}>{company.address}</Text>
          {company.pfCode && (
            <Text style={pdfStyles.companyAddress}>PF Code: {company.pfCode}</Text>
          )}
        </View>

        {/* Title */}
        <Text style={pdfStyles.title}>Salary Slip</Text>
        <Text style={pdfStyles.periodText}>
          For the month of {getMonthName(period.month)} {period.year}
        </Text>

        {/* Employee Details */}
        <View style={pdfStyles.section}>
          <SectionTitle title="Employee Details" />
          <View style={pdfStyles.twoColumn}>
            <View style={pdfStyles.column}>
              <InfoRow label="Employee Code" value={employee.code} />
              <InfoRow label="Name" value={employee.name} />
              <InfoRow label="Department" value={employee.department} />
              <InfoRow label="Designation" value={employee.designation} />
            </View>
            <View style={pdfStyles.column}>
              <InfoRow label="PAN" value={maskPAN(employee.pan || null)} />
              <InfoRow label="UAN" value={employee.uan || 'N/A'} />
              <InfoRow label="Bank" value={employee.bankName || 'N/A'} />
              <InfoRow label="ESIC No" value={employee.esicNumber || 'N/A'} />
            </View>
          </View>
        </View>

        {/* Attendance Summary */}
        <View style={pdfStyles.section}>
          <SectionTitle title="Attendance Summary" />
          <View style={pdfStyles.twoColumn}>
            <View style={pdfStyles.column}>
              <InfoRow label="Working Days" value={period.workingDays.toString()} />
              <InfoRow label="Paid Days" value={period.paidDays.toString()} />
            </View>
            <View style={pdfStyles.column}>
              <InfoRow label="LOP Days" value={period.lopDays.toString()} />
            </View>
          </View>
        </View>

        {/* Earnings and Deductions */}
        <View style={pdfStyles.twoColumn}>
          {/* Earnings Column */}
          <View style={pdfStyles.column}>
            <SectionTitle title="Earnings" />
            <InfoRow label="Basic Salary" value={formatCurrencyPDF(earnings.basic)} />
            <InfoRow label="HRA" value={formatCurrencyPDF(earnings.hra)} />
            <InfoRow label="Special Allowance" value={formatCurrencyPDF(earnings.specialAllowance)} />
            {earnings.lta > 0 && (
              <InfoRow label="LTA" value={formatCurrencyPDF(earnings.lta)} />
            )}
            {earnings.medical > 0 && (
              <InfoRow label="Medical Allowance" value={formatCurrencyPDF(earnings.medical)} />
            )}
            {earnings.conveyance > 0 && (
              <InfoRow label="Conveyance" value={formatCurrencyPDF(earnings.conveyance)} />
            )}
            {earnings.otherAllowances > 0 && (
              <InfoRow label="Other Allowances" value={formatCurrencyPDF(earnings.otherAllowances)} />
            )}
            <TotalRow label="Gross Earnings" value={formatCurrencyPDF(data.grossBeforeLOP)} />
          </View>

          {/* Deductions Column */}
          <View style={pdfStyles.column}>
            <SectionTitle title="Deductions" />
            {deductions.pf > 0 && (
              <InfoRow label="Provident Fund" value={formatCurrencyPDF(deductions.pf)} />
            )}
            {deductions.esi > 0 && (
              <InfoRow label="ESI" value={formatCurrencyPDF(deductions.esi)} />
            )}
            {deductions.pt > 0 && (
              <InfoRow label="Professional Tax" value={formatCurrencyPDF(deductions.pt)} />
            )}
            {deductions.tds > 0 && (
              <InfoRow label="Income Tax (TDS)" value={formatCurrencyPDF(deductions.tds)} />
            )}
            {deductions.lopDeduction > 0 && (
              <InfoRow label="Loss of Pay" value={formatCurrencyPDF(deductions.lopDeduction)} />
            )}
            {deductions.otherDeductions > 0 && (
              <InfoRow label="Other Deductions" value={formatCurrencyPDF(deductions.otherDeductions)} />
            )}
            <TotalRow label="Total Deductions" value={formatCurrencyPDF(data.totalDeductions + deductions.lopDeduction)} />
          </View>
        </View>

        {/* Net Pay */}
        <View style={pdfStyles.netPaySection}>
          <View style={pdfStyles.netPayRow}>
            <Text style={pdfStyles.netPayLabel}>Net Pay</Text>
            <Text style={pdfStyles.netPayValue}>{formatCurrencyPDF(data.netPay)}</Text>
          </View>
          <Text style={pdfStyles.netPayWords}>{formatNetPayInWords(data.netPay)}</Text>
        </View>

        {/* Employer Contributions (Info Only) */}
        <View style={[pdfStyles.section, { marginTop: 15 }]}>
          <SectionTitle title="Employer Contributions (For Your Information)" />
          <View style={pdfStyles.twoColumn}>
            <View style={pdfStyles.column}>
              <InfoRow label="Employer PF Contribution" value={formatCurrencyPDF(data.employerPF)} />
            </View>
            <View style={pdfStyles.column}>
              <InfoRow label="Employer ESI Contribution" value={formatCurrencyPDF(data.employerESI)} />
            </View>
          </View>
        </View>

        {/* Footer */}
        <View style={pdfStyles.footer}>
          <Text>This is a system-generated payslip and does not require a signature.</Text>
          <Text>Generated on: {new Date().toLocaleDateString('en-IN')}</Text>
          <Text>For queries, contact HR department.</Text>
        </View>
      </Page>
    </Document>
  );
}
```
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - PayslipDocument renders with all sections
    - Earnings and deductions display in two-column layout
    - Net pay shows amount and words
  </verify>
  <done>
    PayslipDocument React component created with professional layout showing all salary components and deductions
  </done>
</task>

<task type="auto">
  <name>Task 3: Create payslip download API endpoints</name>
  <files>
    src/app/api/payroll/[runId]/payslips/[employeeId]/route.ts
    src/app/api/payroll/[runId]/payslips/download-all/route.ts
  </files>
  <action>
1. Create src/app/api/payroll/[runId]/payslips/[employeeId]/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';
import { prisma } from '@/lib/db';
import { renderToStream } from '@react-pdf/renderer';
import { PayslipDocument, type PayslipData } from '@/lib/pdf/payslip';
import { decrypt } from '@/lib/encryption';

// Company info - could be moved to config/database
const COMPANY_INFO = {
  name: 'ShreeHR Demo Company',
  address: 'Bangalore, Karnataka 560001',
  pfCode: 'KN/BLR/0000000',
  esiCode: 'KA00000000',
};

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ runId: string; employeeId: string }> }
) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { runId, employeeId } = await params;

  // Check permissions
  // Employees can only download their own payslip
  // Admin/HR/Payroll can download any
  const isAdmin = ['SUPER_ADMIN', 'ADMIN', 'HR_MANAGER', 'PAYROLL_MANAGER'].includes(session.user.role);

  if (!isAdmin) {
    // Get user's employee ID
    const user = await prisma.user.findUnique({
      where: { id: session.user.id },
      select: { employee_id: true },
    });

    if (user?.employee_id !== employeeId) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }
  }

  // Get payroll record with employee details
  const record = await prisma.payrollRecord.findFirst({
    where: {
      payroll_run_id: runId,
      employee_id: employeeId,
    },
    include: {
      employee: {
        include: {
          department: true,
          designation: true,
        },
      },
      payroll_run: true,
    },
  });

  if (!record) {
    return NextResponse.json({ error: 'Payroll record not found' }, { status: 404 });
  }

  // Build payslip data
  const payslipData: PayslipData = {
    company: COMPANY_INFO,
    employee: {
      id: record.employee.id,
      code: record.employee.employee_code,
      name: `${record.employee.first_name} ${record.employee.last_name}`,
      designation: record.employee.designation.title,
      department: record.employee.department.name,
      pan: record.employee.pan_encrypted ? decrypt(record.employee.pan_encrypted) : undefined,
      uan: record.employee.uan || undefined,
      esicNumber: record.employee.esic_number || undefined,
      bankName: record.employee.bank_name || undefined,
    },
    period: {
      month: record.month,
      year: record.year,
      workingDays: record.working_days,
      paidDays: record.paid_days,
      lopDays: record.lop_days,
    },
    earnings: {
      basic: record.basic_paise,
      hra: record.hra_paise,
      specialAllowance: record.special_allowance_paise,
      lta: record.lta_paise,
      medical: record.medical_paise,
      conveyance: record.conveyance_paise,
      otherAllowances: record.other_allowances_paise,
    },
    deductions: {
      pf: record.pf_employee_paise,
      esi: record.esi_employee_paise,
      pt: record.pt_paise,
      tds: record.tds_paise,
      otherDeductions: record.other_deductions_paise,
      lopDeduction: record.lop_deduction_paise,
    },
    grossBeforeLOP: record.gross_before_lop_paise,
    grossSalary: record.gross_salary_paise,
    totalDeductions: record.total_deductions_paise,
    netPay: record.net_salary_paise,
    employerPF: record.pf_total_employer_paise,
    employerESI: record.esi_employer_paise,
  };

  try {
    // Generate PDF
    const stream = await renderToStream(
      <PayslipDocument data={payslipData} />
    );

    // Convert stream to response
    const filename = `payslip-${record.employee.employee_code}-${record.year}-${String(record.month).padStart(2, '0')}.pdf`;

    return new Response(stream as any, {
      headers: {
        'Content-Type': 'application/pdf',
        'Content-Disposition': `attachment; filename="${filename}"`,
      },
    });
  } catch (error: any) {
    console.error('PDF generation error:', error);
    return NextResponse.json(
      { error: 'Failed to generate payslip' },
      { status: 500 }
    );
  }
}
```

2. Create src/app/api/payroll/[runId]/payslips/download-all/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';
import { prisma } from '@/lib/db';
import { renderToStream } from '@react-pdf/renderer';
import { PayslipDocument, type PayslipData } from '@/lib/pdf/payslip';
import { decrypt } from '@/lib/encryption';
import JSZip from 'jszip';

const COMPANY_INFO = {
  name: 'ShreeHR Demo Company',
  address: 'Bangalore, Karnataka 560001',
  pfCode: 'KN/BLR/0000000',
  esiCode: 'KA00000000',
};

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ runId: string }> }
) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Only admin roles can bulk download
  if (!['SUPER_ADMIN', 'ADMIN', 'HR_MANAGER', 'PAYROLL_MANAGER'].includes(session.user.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  const { runId } = await params;

  // Get all payroll records for this run
  const records = await prisma.payrollRecord.findMany({
    where: {
      payroll_run_id: runId,
      status: { in: ['CALCULATED', 'VERIFIED', 'PAID'] },
    },
    include: {
      employee: {
        include: {
          department: true,
          designation: true,
        },
      },
      payroll_run: true,
    },
  });

  if (records.length === 0) {
    return NextResponse.json(
      { error: 'No payroll records found' },
      { status: 404 }
    );
  }

  try {
    const zip = new JSZip();
    const month = records[0].month;
    const year = records[0].year;

    // Generate PDF for each employee
    for (const record of records) {
      const payslipData: PayslipData = {
        company: COMPANY_INFO,
        employee: {
          id: record.employee.id,
          code: record.employee.employee_code,
          name: `${record.employee.first_name} ${record.employee.last_name}`,
          designation: record.employee.designation.title,
          department: record.employee.department.name,
          pan: record.employee.pan_encrypted ? decrypt(record.employee.pan_encrypted) : undefined,
          uan: record.employee.uan || undefined,
          esicNumber: record.employee.esic_number || undefined,
          bankName: record.employee.bank_name || undefined,
        },
        period: {
          month: record.month,
          year: record.year,
          workingDays: record.working_days,
          paidDays: record.paid_days,
          lopDays: record.lop_days,
        },
        earnings: {
          basic: record.basic_paise,
          hra: record.hra_paise,
          specialAllowance: record.special_allowance_paise,
          lta: record.lta_paise,
          medical: record.medical_paise,
          conveyance: record.conveyance_paise,
          otherAllowances: record.other_allowances_paise,
        },
        deductions: {
          pf: record.pf_employee_paise,
          esi: record.esi_employee_paise,
          pt: record.pt_paise,
          tds: record.tds_paise,
          otherDeductions: record.other_deductions_paise,
          lopDeduction: record.lop_deduction_paise,
        },
        grossBeforeLOP: record.gross_before_lop_paise,
        grossSalary: record.gross_salary_paise,
        totalDeductions: record.total_deductions_paise,
        netPay: record.net_salary_paise,
        employerPF: record.pf_total_employer_paise,
        employerESI: record.esi_employer_paise,
      };

      // Generate PDF as buffer
      const stream = await renderToStream(
        <PayslipDocument data={payslipData} />
      );

      // Convert stream to buffer
      const chunks: Uint8Array[] = [];
      const reader = (stream as any).getReader();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
      }

      const pdfBuffer = Buffer.concat(chunks);
      const filename = `${record.employee.employee_code}_${record.employee.first_name}_${record.employee.last_name}.pdf`;

      zip.file(filename, pdfBuffer);
    }

    // Generate zip file
    const zipBuffer = await zip.generateAsync({ type: 'nodebuffer' });
    const zipFilename = `payslips-${year}-${String(month).padStart(2, '0')}.zip`;

    return new Response(zipBuffer, {
      headers: {
        'Content-Type': 'application/zip',
        'Content-Disposition': `attachment; filename="${zipFilename}"`,
      },
    });
  } catch (error: any) {
    console.error('Bulk PDF generation error:', error);
    return NextResponse.json(
      { error: 'Failed to generate payslips' },
      { status: 500 }
    );
  }
}
```

Note: For bulk download, you'll need to install jszip:
```bash
pnpm add jszip
```
  </action>
  <verify>
    - Individual payslip downloads as PDF with correct filename
    - Bulk download creates ZIP with all payslips
    - Employee can only download their own payslip
    - Admin can download any payslip
  </verify>
  <done>
    Payslip download APIs created with individual and bulk download support, proper RBAC enforcement
  </done>
</task>

</tasks>

<verification>
1. PDF generation: Single payslip renders correctly with all sections
2. Individual download: Employee-specific payslip downloads as PDF
3. Bulk download: ZIP file contains all employee payslips
4. RBAC: Employees can only download own, admin can download all
</verification>

<success_criteria>
- [ ] @react-pdf/renderer installed and working
- [ ] PayslipDocument shows company header, employee details, earnings, deductions
- [ ] Net pay shows both amount and words
- [ ] Employer contributions displayed as info
- [ ] Individual payslip API returns PDF with correct filename
- [ ] Bulk download API returns ZIP with all payslips
- [ ] RBAC enforced on both endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/03-payroll-compliance/03-05-SUMMARY.md`
</output>
