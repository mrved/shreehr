---
phase: 03-payroll-compliance
plan: 08
type: execute
wave: 5
depends_on: ["03-04"]
files_modified:
  - prisma/schema.prisma
  - src/lib/statutory/deadlines.ts
  - src/app/api/statutory/deadlines/route.ts
  - src/app/api/cron/statutory-alerts/route.ts
autonomous: true

must_haves:
  truths:
    - "System tracks statutory filing deadlines (PF 15th, TDS 7th, ESI 15th)"
    - "Admin sees upcoming deadlines on dashboard"
    - "System generates alerts 7/3/1 days before deadline"
    - "Overdue deadlines marked as critical"
  artifacts:
    - path: "src/lib/statutory/deadlines.ts"
      provides: "Deadline calculation and alert logic"
      exports: ["getUpcomingDeadlines", "checkDeadlineAlerts"]
    - path: "prisma/schema.prisma"
      provides: "StatutoryDeadline model for tracking"
      contains: "model StatutoryDeadline"
    - path: "src/app/api/statutory/deadlines/route.ts"
      provides: "Deadline listing API"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/cron/statutory-alerts/route.ts"
      to: "src/lib/statutory/deadlines.ts"
      via: "alert generation"
      pattern: "checkDeadlineAlerts"
---

<objective>
Implement statutory deadline tracking with alert system

Purpose: Missing statutory filing deadlines results in penalties (PF: 12% p.a. interest + damages, TDS: Rs.200/day late fee). Proactive alerts at 7/3/1 days help prevent late filings.

Output:
- StatutoryDeadline model for tracking filing status
- Deadline calculation utilities
- API for fetching upcoming deadlines
- Cron endpoint for generating alerts
</objective>

<execution_context>
@C:\Users\ved\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ved\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payroll-compliance/03-RESEARCH.md
@.planning/phases/03-payroll-compliance/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatutoryDeadline model and deadline utilities</name>
  <files>
    prisma/schema.prisma
    src/lib/statutory/deadlines.ts
  </files>
  <action>
1. Add StatutoryDeadline model to schema.prisma:
```prisma
model StatutoryDeadline {
  id String @id @default(cuid())

  type        DeadlineType
  description String

  // Period this deadline is for
  month Int
  year  Int

  // Due date
  due_date DateTime @db.Date

  // Filing status
  status FilingStatus @default(PENDING)

  // Filing details (when completed)
  filed_at          DateTime?
  filing_reference  String?   // Challan/Acknowledgment number
  amount_filed_paise Int?

  // Alert tracking
  alert_7_day_sent Boolean @default(false)
  alert_3_day_sent Boolean @default(false)
  alert_1_day_sent Boolean @default(false)
  overdue_alert_sent Boolean @default(false)

  // Audit
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  filed_by   String?

  @@unique([type, month, year])
  @@index([due_date, status])
  @@map("statutory_deadlines")
}

enum DeadlineType {
  PF_PAYMENT      // PF contribution payment
  PF_RETURN       // ECR filing
  ESI_PAYMENT     // ESI contribution payment
  ESI_RETURN      // ESI return filing
  TDS_DEPOSIT     // TDS deposit (7th of month)
  TDS_RETURN_24Q  // Form 24Q quarterly return
  PT_PAYMENT      // Professional Tax payment
  FORM_16         // Annual Form 16 issuance
}

enum FilingStatus {
  PENDING
  FILED
  OVERDUE
  NOT_APPLICABLE
}
```

2. Create src/lib/statutory/deadlines.ts:
```typescript
import { prisma } from '@/lib/db';
import { addDays, isBefore, isAfter, startOfDay, differenceInDays } from 'date-fns';

export type DeadlineType =
  | 'PF_PAYMENT'
  | 'PF_RETURN'
  | 'ESI_PAYMENT'
  | 'ESI_RETURN'
  | 'TDS_DEPOSIT'
  | 'TDS_RETURN_24Q'
  | 'PT_PAYMENT'
  | 'FORM_16';

export type AlertSeverity = 'INFO' | 'WARNING' | 'CRITICAL';

export interface DeadlineInfo {
  type: DeadlineType;
  description: string;
  dueDay: number;
  frequency: 'MONTHLY' | 'QUARTERLY' | 'ANNUAL';
  dueMonth?: number; // For annual deadlines
}

// Standard statutory deadlines
export const STATUTORY_DEADLINES: DeadlineInfo[] = [
  {
    type: 'PF_PAYMENT',
    description: 'PF contribution payment to EPFO',
    dueDay: 15,
    frequency: 'MONTHLY',
  },
  {
    type: 'PF_RETURN',
    description: 'ECR file upload to EPFO portal',
    dueDay: 15,
    frequency: 'MONTHLY',
  },
  {
    type: 'ESI_PAYMENT',
    description: 'ESI contribution payment to ESIC',
    dueDay: 15,
    frequency: 'MONTHLY',
  },
  {
    type: 'TDS_DEPOSIT',
    description: 'TDS deposit to government',
    dueDay: 7,
    frequency: 'MONTHLY',
  },
  {
    type: 'TDS_RETURN_24Q',
    description: 'Form 24Q quarterly TDS return',
    dueDay: 31,
    frequency: 'QUARTERLY',
  },
  {
    type: 'PT_PAYMENT',
    description: 'Professional Tax payment to state',
    dueDay: 20,
    frequency: 'MONTHLY',
  },
  {
    type: 'FORM_16',
    description: 'Form 16 issuance to employees',
    dueDay: 15,
    dueMonth: 6, // June 15
    frequency: 'ANNUAL',
  },
];

export interface DeadlineAlert {
  id: string;
  type: DeadlineType;
  description: string;
  dueDate: Date;
  daysRemaining: number;
  severity: AlertSeverity;
  month: number;
  year: number;
  status: string;
}

/**
 * Calculate due date for a deadline
 */
export function calculateDueDate(
  deadline: DeadlineInfo,
  forMonth: number,
  forYear: number
): Date {
  if (deadline.frequency === 'MONTHLY') {
    // Due on Xth of following month
    const dueMonth = forMonth === 12 ? 1 : forMonth + 1;
    const dueYear = forMonth === 12 ? forYear + 1 : forYear;
    return new Date(dueYear, dueMonth - 1, deadline.dueDay);
  }

  if (deadline.frequency === 'QUARTERLY') {
    // Form 24Q due dates
    // Q1 (Apr-Jun) -> Jul 31
    // Q2 (Jul-Sep) -> Oct 31
    // Q3 (Oct-Dec) -> Jan 31
    // Q4 (Jan-Mar) -> May 31

    const quarter = Math.ceil(forMonth / 3);
    let dueMonth: number;
    let dueYear = forYear;

    switch (quarter) {
      case 2: // Q1: Apr-Jun -> Jul
        dueMonth = 7;
        break;
      case 3: // Q2: Jul-Sep -> Oct
        dueMonth = 10;
        break;
      case 4: // Q3: Oct-Dec -> Jan (next year)
        dueMonth = 1;
        dueYear = forYear + 1;
        break;
      case 1: // Q4: Jan-Mar -> May
        dueMonth = 5;
        break;
      default:
        dueMonth = 7;
    }

    return new Date(dueYear, dueMonth - 1, deadline.dueDay);
  }

  if (deadline.frequency === 'ANNUAL' && deadline.dueMonth) {
    // Form 16 due June 15
    return new Date(forYear, deadline.dueMonth - 1, deadline.dueDay);
  }

  throw new Error(`Unknown deadline frequency: ${deadline.frequency}`);
}

/**
 * Get upcoming statutory deadlines with alert status
 */
export async function getUpcomingDeadlines(
  lookAheadDays: number = 30
): Promise<DeadlineAlert[]> {
  const today = startOfDay(new Date());
  const futureDate = addDays(today, lookAheadDays);

  // Get pending and overdue deadlines
  const deadlines = await prisma.statutoryDeadline.findMany({
    where: {
      status: { in: ['PENDING', 'OVERDUE'] },
      due_date: { lte: futureDate },
    },
    orderBy: { due_date: 'asc' },
  });

  return deadlines.map(d => {
    const daysRemaining = differenceInDays(d.due_date, today);
    let severity: AlertSeverity = 'INFO';

    if (daysRemaining < 0) {
      severity = 'CRITICAL'; // Overdue
    } else if (daysRemaining <= 1) {
      severity = 'CRITICAL';
    } else if (daysRemaining <= 3) {
      severity = 'WARNING';
    }

    return {
      id: d.id,
      type: d.type as DeadlineType,
      description: d.description,
      dueDate: d.due_date,
      daysRemaining,
      severity,
      month: d.month,
      year: d.year,
      status: d.status,
    };
  });
}

/**
 * Generate deadline records for a month
 * Call this at the start of each month or when payroll is run
 */
export async function generateDeadlinesForMonth(
  month: number,
  year: number
): Promise<number> {
  let created = 0;

  for (const deadline of STATUTORY_DEADLINES) {
    // Skip non-monthly deadlines for regular generation
    if (deadline.frequency !== 'MONTHLY') continue;

    const dueDate = calculateDueDate(deadline, month, year);

    // Upsert deadline
    await prisma.statutoryDeadline.upsert({
      where: {
        type_month_year: {
          type: deadline.type,
          month,
          year,
        },
      },
      create: {
        type: deadline.type,
        description: deadline.description,
        month,
        year,
        due_date: dueDate,
        status: 'PENDING',
      },
      update: {
        due_date: dueDate,
        description: deadline.description,
      },
    });

    created++;
  }

  return created;
}

/**
 * Check and send deadline alerts
 * Call this daily via cron
 */
export async function checkDeadlineAlerts(): Promise<{
  alertsSent: number;
  overdueMarked: number;
}> {
  const today = startOfDay(new Date());
  let alertsSent = 0;
  let overdueMarked = 0;

  // Get all pending deadlines
  const deadlines = await prisma.statutoryDeadline.findMany({
    where: {
      status: 'PENDING',
    },
  });

  for (const deadline of deadlines) {
    const daysRemaining = differenceInDays(deadline.due_date, today);

    // Mark overdue
    if (daysRemaining < 0 && deadline.status === 'PENDING') {
      await prisma.statutoryDeadline.update({
        where: { id: deadline.id },
        data: {
          status: 'OVERDUE',
          overdue_alert_sent: true,
        },
      });
      overdueMarked++;
      alertsSent++;
      continue;
    }

    // 7-day alert
    if (daysRemaining <= 7 && daysRemaining > 3 && !deadline.alert_7_day_sent) {
      await prisma.statutoryDeadline.update({
        where: { id: deadline.id },
        data: { alert_7_day_sent: true },
      });
      alertsSent++;
    }

    // 3-day alert
    if (daysRemaining <= 3 && daysRemaining > 1 && !deadline.alert_3_day_sent) {
      await prisma.statutoryDeadline.update({
        where: { id: deadline.id },
        data: { alert_3_day_sent: true },
      });
      alertsSent++;
    }

    // 1-day alert
    if (daysRemaining <= 1 && daysRemaining >= 0 && !deadline.alert_1_day_sent) {
      await prisma.statutoryDeadline.update({
        where: { id: deadline.id },
        data: { alert_1_day_sent: true },
      });
      alertsSent++;
    }
  }

  return { alertsSent, overdueMarked };
}

/**
 * Mark a deadline as filed
 */
export async function markDeadlineFiled(
  deadlineId: string,
  filedBy: string,
  details: {
    filingReference?: string;
    amountFiledPaise?: number;
  }
): Promise<void> {
  await prisma.statutoryDeadline.update({
    where: { id: deadlineId },
    data: {
      status: 'FILED',
      filed_at: new Date(),
      filed_by: filedBy,
      filing_reference: details.filingReference,
      amount_filed_paise: details.amountFiledPaise,
    },
  });
}
```

Run `pnpm db:push` to update database schema.
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - `pnpm db:push` succeeds
    - calculateDueDate returns correct dates for monthly/quarterly/annual
    - getUpcomingDeadlines returns sorted alerts with severity
  </verify>
  <done>
    Statutory deadline model and utilities created with due date calculation, alert generation, and filing status tracking
  </done>
</task>

<task type="auto">
  <name>Task 2: Create deadline API and cron endpoint</name>
  <files>
    src/app/api/statutory/deadlines/route.ts
    src/app/api/statutory/deadlines/[id]/route.ts
    src/app/api/cron/statutory-alerts/route.ts
  </files>
  <action>
1. Create src/app/api/statutory/deadlines/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';
import { prisma } from '@/lib/db';
import {
  getUpcomingDeadlines,
  generateDeadlinesForMonth,
} from '@/lib/statutory/deadlines';

// GET /api/statutory/deadlines - List upcoming deadlines
export async function GET(request: NextRequest) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Only admin/payroll roles can view deadlines
  if (!['SUPER_ADMIN', 'ADMIN', 'PAYROLL_MANAGER'].includes(session.user.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  const { searchParams } = new URL(request.url);
  const lookAhead = parseInt(searchParams.get('days') || '30');
  const status = searchParams.get('status');

  try {
    const deadlines = await getUpcomingDeadlines(lookAhead);

    // Filter by status if provided
    const filtered = status
      ? deadlines.filter(d => d.status === status.toUpperCase())
      : deadlines;

    // Group by severity for dashboard
    const summary = {
      critical: filtered.filter(d => d.severity === 'CRITICAL').length,
      warning: filtered.filter(d => d.severity === 'WARNING').length,
      info: filtered.filter(d => d.severity === 'INFO').length,
      overdue: filtered.filter(d => d.daysRemaining < 0).length,
    };

    return NextResponse.json({
      data: filtered,
      summary,
    });
  } catch (error: any) {
    console.error('Deadline fetch error:', error);
    return NextResponse.json(
      { error: 'Failed to fetch deadlines' },
      { status: 500 }
    );
  }
}

// POST /api/statutory/deadlines - Generate deadlines for a month
export async function POST(request: NextRequest) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  if (!['SUPER_ADMIN', 'ADMIN'].includes(session.user.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  try {
    const { month, year } = await request.json();

    if (!month || !year) {
      return NextResponse.json(
        { error: 'Month and year are required' },
        { status: 400 }
      );
    }

    const created = await generateDeadlinesForMonth(month, year);

    return NextResponse.json({
      message: `Generated ${created} deadlines for ${year}-${month}`,
      count: created,
    });
  } catch (error: any) {
    console.error('Deadline generation error:', error);
    return NextResponse.json(
      { error: 'Failed to generate deadlines' },
      { status: 500 }
    );
  }
}
```

2. Create src/app/api/statutory/deadlines/[id]/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';
import { prisma } from '@/lib/db';
import { markDeadlineFiled } from '@/lib/statutory/deadlines';

// GET /api/statutory/deadlines/[id] - Get single deadline
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  if (!['SUPER_ADMIN', 'ADMIN', 'PAYROLL_MANAGER'].includes(session.user.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  const { id } = await params;

  const deadline = await prisma.statutoryDeadline.findUnique({
    where: { id },
  });

  if (!deadline) {
    return NextResponse.json({ error: 'Deadline not found' }, { status: 404 });
  }

  return NextResponse.json({ data: deadline });
}

// PATCH /api/statutory/deadlines/[id] - Mark deadline as filed
export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  if (!['SUPER_ADMIN', 'ADMIN', 'PAYROLL_MANAGER'].includes(session.user.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  const { id } = await params;

  try {
    const body = await request.json();
    const { filingReference, amountFiledPaise } = body;

    await markDeadlineFiled(id, session.user.id, {
      filingReference,
      amountFiledPaise,
    });

    const updated = await prisma.statutoryDeadline.findUnique({
      where: { id },
    });

    return NextResponse.json({
      data: updated,
      message: 'Deadline marked as filed',
    });
  } catch (error: any) {
    console.error('Deadline update error:', error);
    return NextResponse.json(
      { error: 'Failed to update deadline' },
      { status: 500 }
    );
  }
}
```

3. Create src/app/api/cron/statutory-alerts/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { checkDeadlineAlerts } from '@/lib/statutory/deadlines';

// Verify cron secret to prevent unauthorized access
const CRON_SECRET = process.env.CRON_SECRET;

/**
 * GET /api/cron/statutory-alerts
 *
 * Cron endpoint to check deadlines and send alerts
 * Should be called daily
 *
 * Vercel Cron example (vercel.json):
 * {
 *   "crons": [{
 *     "path": "/api/cron/statutory-alerts",
 *     "schedule": "0 9 * * *"
 *   }]
 * }
 */
export async function GET(request: NextRequest) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization');

  if (CRON_SECRET && authHeader !== `Bearer ${CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  try {
    const result = await checkDeadlineAlerts();

    console.log('Statutory alert check completed:', result);

    return NextResponse.json({
      success: true,
      ...result,
      timestamp: new Date().toISOString(),
    });
  } catch (error: any) {
    console.error('Statutory alert check failed:', error);
    return NextResponse.json(
      {
        success: false,
        error: error.message,
        timestamp: new Date().toISOString(),
      },
      { status: 500 }
    );
  }
}
```
  </action>
  <verify>
    - GET /api/statutory/deadlines returns upcoming deadlines with severity
    - POST /api/statutory/deadlines generates deadlines for month
    - PATCH /api/statutory/deadlines/[id] marks as filed
    - Cron endpoint checks and updates alert flags
  </verify>
  <done>
    Deadline APIs created with listing, generation, filing status update, and daily cron endpoint for alerts
  </done>
</task>

<task type="auto">
  <name>Task 3: Add deadline dashboard component data endpoint</name>
  <files>
    src/app/api/dashboard/statutory/route.ts
  </files>
  <action>
Create src/app/api/dashboard/statutory/route.ts for dashboard widget:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth-options';
import { prisma } from '@/lib/db';
import { differenceInDays, startOfDay } from 'date-fns';

/**
 * GET /api/dashboard/statutory
 *
 * Returns statutory compliance summary for dashboard widget
 */
export async function GET(request: NextRequest) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Allow admin, HR, and payroll roles
  const allowedRoles = ['SUPER_ADMIN', 'ADMIN', 'HR_MANAGER', 'PAYROLL_MANAGER'];
  if (!allowedRoles.includes(session.user.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  const today = startOfDay(new Date());

  // Get upcoming deadlines (next 14 days)
  const upcomingDeadlines = await prisma.statutoryDeadline.findMany({
    where: {
      status: 'PENDING',
      due_date: {
        gte: today,
        lte: new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000),
      },
    },
    orderBy: { due_date: 'asc' },
    take: 5,
  });

  // Get overdue deadlines
  const overdueDeadlines = await prisma.statutoryDeadline.findMany({
    where: {
      status: 'OVERDUE',
    },
    orderBy: { due_date: 'asc' },
  });

  // Get recently filed (last 7 days)
  const recentlyFiled = await prisma.statutoryDeadline.findMany({
    where: {
      status: 'FILED',
      filed_at: {
        gte: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000),
      },
    },
    orderBy: { filed_at: 'desc' },
    take: 5,
  });

  // Format deadlines for dashboard
  const formatDeadline = (d: any) => ({
    id: d.id,
    type: d.type,
    description: d.description,
    dueDate: d.due_date,
    month: d.month,
    year: d.year,
    daysRemaining: differenceInDays(d.due_date, today),
    status: d.status,
    filingReference: d.filing_reference,
  });

  // Calculate compliance score
  // Score = (Filed on time / Total deadlines in last 3 months) * 100
  const threeMonthsAgo = new Date(today);
  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

  const recentDeadlinesAll = await prisma.statutoryDeadline.findMany({
    where: {
      due_date: { gte: threeMonthsAgo },
    },
  });

  const filedOnTime = recentDeadlinesAll.filter(d =>
    d.status === 'FILED' && d.filed_at && d.filed_at <= d.due_date
  ).length;

  const totalApplicable = recentDeadlinesAll.filter(d =>
    d.status !== 'NOT_APPLICABLE'
  ).length;

  const complianceScore = totalApplicable > 0
    ? Math.round((filedOnTime / totalApplicable) * 100)
    : 100;

  return NextResponse.json({
    summary: {
      overdue: overdueDeadlines.length,
      dueSoon: upcomingDeadlines.filter(d =>
        differenceInDays(d.due_date, today) <= 3
      ).length,
      upcoming: upcomingDeadlines.length,
      complianceScore,
    },
    upcomingDeadlines: upcomingDeadlines.map(formatDeadline),
    overdueDeadlines: overdueDeadlines.map(formatDeadline),
    recentlyFiled: recentlyFiled.map(d => ({
      ...formatDeadline(d),
      filedAt: d.filed_at,
    })),
  });
}
```
  </action>
  <verify>
    - Dashboard endpoint returns summary (overdue, due soon, upcoming counts)
    - Compliance score calculated from 3-month history
    - Returns formatted deadline lists for display
  </verify>
  <done>
    Dashboard statutory summary API created with compliance score and categorized deadline lists
  </done>
</task>

</tasks>

<verification>
1. Deadlines generated correctly for monthly filings
2. Alerts triggered at 7/3/1 days before due date
3. Overdue deadlines marked and tracked
4. Dashboard shows summary with compliance score
5. Cron endpoint runs without auth issues
</verification>

<success_criteria>
- [ ] StatutoryDeadline model tracks all deadline types
- [ ] calculateDueDate handles monthly, quarterly, annual frequencies
- [ ] Alert flags (7/3/1 day) set correctly
- [ ] Overdue status applied when past due date
- [ ] Dashboard API returns compliance summary
- [ ] Deadlines can be marked as filed with reference
</success_criteria>

<output>
After completion, create `.planning/phases/03-payroll-compliance/03-08-SUMMARY.md`
</output>
