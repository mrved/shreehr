// ShreeHR Database Schema
// Prisma schema for HR management with Indian statutory compliance

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// CORE USER AND AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password_hash String
  role          UserRole  @default(EMPLOYEE)
  employee_id   String?   @unique
  employee      Employee? @relation(fields: [employee_id], references: [id])
  is_active     Boolean   @default(true)
  last_login_at DateTime?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt
  updated_by String?

  // Relations
  created_employees         Employee[]             @relation("EmployeeCreatedBy")
  updated_employees         Employee[]             @relation("EmployeeUpdatedBy")
  created_departments       Department[]           @relation("DepartmentCreatedBy")
  updated_departments       Department[]           @relation("DepartmentUpdatedBy")
  created_designations      Designation[]          @relation("DesignationCreatedBy")
  updated_designations      Designation[]          @relation("DesignationUpdatedBy")
  created_documents         Document[]             @relation("DocumentCreatedBy")
  updated_documents         Document[]             @relation("DocumentUpdatedBy")
  created_salary_records    SalaryRecord[]         @relation("SalaryRecordCreatedBy")
  updated_salary_records    SalaryRecord[]         @relation("SalaryRecordUpdatedBy")
  created_leave_balances    LeaveBalance[]         @relation("LeaveBalanceCreatedBy")
  updated_leave_balances    LeaveBalance[]         @relation("LeaveBalanceUpdatedBy")
  created_import_batches    ImportBatch[]          @relation("ImportBatchCreatedBy")
  created_leave_types       LeaveType[]            @relation("LeaveTypeCreatedBy")
  updated_leave_types       LeaveType[]            @relation("LeaveTypeUpdatedBy")
  created_leave_requests    LeaveRequest[]         @relation("LeaveRequestCreatedBy")
  updated_leave_requests    LeaveRequest[]         @relation("LeaveRequestUpdatedBy")
  approved_leave_requests   LeaveRequest[]         @relation("LeaveRequestApprovedBy")
  created_attendances       Attendance[]           @relation("AttendanceCreatedBy")
  updated_attendances       Attendance[]           @relation("AttendanceUpdatedBy")
  locked_attendance_periods AttendanceLock[]       @relation("AttendanceLockLockedBy")
  created_corrections       AttendanceCorrection[] @relation("CorrectionCreatedBy")
  updated_corrections       AttendanceCorrection[] @relation("CorrectionUpdatedBy")
  approved_corrections      AttendanceCorrection[] @relation("CorrectionApprovedBy")
  created_salary_structures SalaryStructure[]      @relation("SalaryStructureCreatedBy")
  updated_salary_structures SalaryStructure[]      @relation("SalaryStructureUpdatedBy")
  created_payroll_runs      PayrollRun[]           @relation("PayrollRunCreatedBy")
  approved_profile_updates  ProfileUpdateRequest[] @relation("ProfileUpdateApprovedBy")
  created_onboarding_records OnboardingRecord[]    @relation("OnboardingRecordCreatedBy")
  created_expense_claims    ExpenseClaim[]         @relation("ExpenseClaimCreatedBy")
  updated_expense_claims    ExpenseClaim[]         @relation("ExpenseClaimUpdatedBy")
  created_loans             EmployeeLoan[]         @relation("LoanCreatedBy")
  updated_loans             EmployeeLoan[]         @relation("LoanUpdatedBy")
  conversations             Conversation[]

  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  HR_MANAGER
  PAYROLL_MANAGER
  EMPLOYEE
}

// ============================================================================
// ORGANIZATIONAL STRUCTURE
// ============================================================================

model Department {
  id          String       @id @default(cuid())
  name        String       @unique
  code        String       @unique
  description String?
  parent_id   String?
  parent      Department?  @relation("DepartmentHierarchy", fields: [parent_id], references: [id])
  children    Department[] @relation("DepartmentHierarchy")
  is_active   Boolean      @default(true)

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("DepartmentCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("DepartmentUpdatedBy", fields: [updated_by], references: [id])

  // Relations
  employees        Employee[]
  onboarding_records OnboardingRecord[]

  @@map("departments")
}

model Designation {
  id          String  @id @default(cuid())
  title       String  @unique
  description String?
  level       Int     @default(1)
  is_active   Boolean @default(true)

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("DesignationCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("DesignationUpdatedBy", fields: [updated_by], references: [id])

  // Relations
  employees          Employee[]
  onboarding_records OnboardingRecord[]

  @@map("designations")
}

// ============================================================================
// EMPLOYEE DATA (with PII encryption)
// ============================================================================

model Employee {
  id            String @id @default(cuid())
  employee_code String @unique

  // Personal Information
  first_name     String
  middle_name    String?
  last_name      String
  date_of_birth  DateTime
  gender         Gender
  marital_status MaritalStatus @default(SINGLE)
  blood_group    String?

  // Contact Information
  personal_email    String?
  personal_phone    String
  emergency_contact String?
  emergency_phone   String?

  // Address
  address_line1 String
  address_line2 String?
  city          String
  state         String
  postal_code   String
  country       String  @default("India")

  // PII - Encrypted fields (stored as encrypted strings)
  pan_encrypted          String? // PAN card number
  aadhaar_encrypted      String? // Aadhaar number
  bank_account_encrypted String? // Bank account number

  // Bank Details (non-PII)
  bank_name   String?
  bank_branch String?
  bank_ifsc   String?

  // Employment Details
  department_id        String
  department           Department  @relation(fields: [department_id], references: [id])
  designation_id       String
  designation          Designation @relation(fields: [designation_id], references: [id])
  reporting_manager_id String?
  reporting_manager    Employee?   @relation("EmployeeReportsTo", fields: [reporting_manager_id], references: [id])
  subordinates         Employee[]  @relation("EmployeeReportsTo")

  // Employment Status
  date_of_joining   DateTime
  date_of_leaving   DateTime?
  employment_type   EmploymentType   @default(FULL_TIME)
  employment_status EmploymentStatus @default(ACTIVE)

  // Statutory Compliance
  uan                    String? // Universal Account Number (PF)
  esic_number            String? // ESIC number
  previous_employer_name String?
  previous_employer_uan  String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("EmployeeCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("EmployeeUpdatedBy", fields: [updated_by], references: [id])

  // Relations
  user                    User?
  documents               Document[]
  salary_records          SalaryRecord[]
  salary_structures       SalaryStructure[]
  leave_balances          LeaveBalance[]
  leave_requests          LeaveRequest[]
  attendances             Attendance[]
  payroll_records         PayrollRecord[]
  profile_update_requests ProfileUpdateRequest[]
  investment_declarations InvestmentDeclaration[]
  onboarding_record       OnboardingRecord?
  expense_claims          ExpenseClaim[]
  loans                   EmployeeLoan[]

  @@map("employees")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
}

enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
  RESIGNED
  RETIRED
}

// ============================================================================
// DOCUMENT MANAGEMENT
// ============================================================================

model Document {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  type          DocumentType
  file_name     String // Unique generated filename
  original_name String // Original uploaded filename
  storage_path  String // Full path on local filesystem
  file_size     Int // bytes
  mime_type     String
  description   String?

  uploaded_at     DateTime  @default(now())
  retention_until DateTime // 8 years from upload
  verified_at     DateTime?
  verified_by     String?

  is_deleted Boolean   @default(false)
  deleted_at DateTime?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("DocumentCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("DocumentUpdatedBy", fields: [updated_by], references: [id])

  @@map("documents")
}

enum DocumentType {
  OFFER_LETTER
  ID_PROOF
  ADDRESS_PROOF
  EDUCATION_CERT
  EXPERIENCE_CERT
  PAN_CARD
  AADHAAR_CARD
  BANK_PROOF
  PASSPORT
  DRIVING_LICENSE
  BANK_STATEMENT
  RESIGNATION_LETTER
  RELIEVING_LETTER
  OTHER
}

// ============================================================================
// SALARY AND PAYROLL
// ============================================================================

model SalaryRecord {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  // Salary Period
  month Int // 1-12
  year  Int

  // Salary Structure (stored in paise for precision)
  basic_pay         Int @default(0)
  hra               Int @default(0)
  conveyance        Int @default(0)
  special_allowance Int @default(0)
  other_allowances  Int @default(0)

  // Deductions (stored in paise)
  pf_employee      Int @default(0)
  pf_employer      Int @default(0)
  esi_employee     Int @default(0)
  esi_employer     Int @default(0)
  professional_tax Int @default(0)
  tds              Int @default(0)
  other_deductions Int @default(0)

  // Totals (stored in paise)
  gross_salary Int @default(0)
  net_salary   Int @default(0)

  // Payment Details
  payment_date      DateTime?
  payment_mode      PaymentMode @default(BANK_TRANSFER)
  payment_reference String?

  // Status
  status      SalaryStatus @default(DRAFT)
  approved_by String?
  approved_at DateTime?

  // Import tracking
  source          String       @default("MANUAL")
  import_batch_id String?
  import_batch    ImportBatch? @relation(fields: [import_batch_id], references: [id])

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("SalaryRecordCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("SalaryRecordUpdatedBy", fields: [updated_by], references: [id])

  @@unique([employee_id, month, year])
  @@index([month, year])
  @@map("salary_records")
}

enum PaymentMode {
  BANK_TRANSFER
  CHEQUE
  CASH
  UPI
}

enum SalaryStatus {
  DRAFT
  APPROVED
  PAID
  CANCELLED
}

model SalaryStructure {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  // Effective period
  effective_from DateTime  @db.Date
  effective_to   DateTime? @db.Date

  // Salary components in paise (100 paise = 1 rupee)
  basic_paise             Int
  hra_paise               Int @default(0)
  special_allowance_paise Int @default(0)
  lta_paise               Int @default(0)
  medical_paise           Int @default(0)
  conveyance_paise        Int @default(0)
  other_allowances_paise  Int @default(0)

  // Computed fields stored for reference
  gross_monthly_paise Int // Sum of all components
  annual_ctc_paise    Int // gross * 12 + employer PF + employer ESI

  // Compliance validation
  basic_percentage Float   // Basic as % of gross (must be >= 50)
  is_compliant     Boolean @default(true) // 50% rule compliance

  // Tax regime for TDS
  tax_regime TaxRegime @default(NEW)

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("SalaryStructureCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("SalaryStructureUpdatedBy", fields: [updated_by], references: [id])

  @@index([employee_id])
  @@index([effective_from])
  @@map("salary_structures")
}

enum TaxRegime {
  OLD
  NEW
}

// ============================================================================
// PAYROLL PROCESSING
// ============================================================================

model PayrollRun {
  id    String @id @default(cuid())
  month Int    // 1-12
  year  Int

  // Processing status
  status         PayrollRunStatus @default(PENDING)
  current_stage  PayrollStage     @default(VALIDATION)

  // Progress tracking
  total_employees    Int @default(0)
  processed_count    Int @default(0)
  success_count      Int @default(0)
  error_count        Int @default(0)

  // Timing
  started_at   DateTime?
  completed_at DateTime?

  // BullMQ job tracking
  job_id String?

  // Error details
  errors Json? // Array of { employee_id, error_message }

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("PayrollRunCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt

  // Relations
  records         PayrollRecord[]
  statutory_files StatutoryFile[]

  @@unique([month, year])
  @@map("payroll_runs")
}

enum PayrollRunStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REVERTED
}

enum PayrollStage {
  VALIDATION      // Check attendance lock, salary structures
  CALCULATION     // Calculate gross, deductions for each employee
  STATUTORY       // Generate statutory files (ECR, ESI, TDS)
  FINALIZATION    // Mark as complete, send notifications
}

model PayrollRecord {
  id String @id @default(cuid())

  // Links
  payroll_run_id String
  payroll_run    PayrollRun @relation(fields: [payroll_run_id], references: [id], onDelete: Cascade)
  employee_id    String
  employee       Employee   @relation(fields: [employee_id], references: [id])

  // Period
  month Int
  year  Int

  // Attendance data (from locked attendance)
  working_days Int @default(0)
  paid_days    Int @default(0)
  lop_days     Int @default(0)

  // Earnings (in paise)
  basic_paise             Int @default(0)
  hra_paise               Int @default(0)
  special_allowance_paise Int @default(0)
  lta_paise               Int @default(0)
  medical_paise           Int @default(0)
  conveyance_paise        Int @default(0)
  other_allowances_paise  Int @default(0)

  // Gross (before LOP)
  gross_before_lop_paise Int @default(0)

  // LOP deduction
  lop_deduction_paise Int @default(0)

  // Gross (after LOP)
  gross_salary_paise Int @default(0)

  // Statutory deductions (in paise)
  // PF - Employee
  pf_employee_paise Int @default(0)

  // PF - Employer breakdown
  pf_employer_epf_paise  Int @default(0) // 3.67%
  pf_employer_eps_paise  Int @default(0) // 8.33% capped at Rs.1,250
  pf_employer_edli_paise Int @default(0) // 0.50%
  pf_admin_charges_paise Int @default(0) // ~0.51%
  pf_total_employer_paise Int @default(0)

  // PF base (for ECR)
  pf_base_paise Int @default(0) // min(basic, 15000)

  // ESI
  esi_employee_paise Int @default(0) // 0.75%
  esi_employer_paise Int @default(0) // 3.25%
  esi_applicable     Boolean @default(false)

  // PT
  pt_paise Int @default(0)

  // TDS
  tds_paise             Int @default(0)
  projected_annual_paise Int @default(0) // For TDS calculation
  tax_regime            String @default("NEW")

  // Other deductions
  other_deductions_paise Int @default(0)

  // Expense reimbursements (added to net pay)
  reimbursements_paise Int @default(0)

  // Loan deductions (subtracted from net pay)
  loan_deductions_paise Int @default(0)

  // Totals
  total_deductions_paise Int @default(0)
  net_salary_paise       Int @default(0)

  // Employer cost
  employer_cost_paise Int @default(0) // gross + employer PF + employer ESI

  // Status
  status       PayrollRecordStatus @default(DRAFT)
  processed_at DateTime?
  error        String?

  // Audit fields
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations to synced financial records
  synced_expenses ExpenseClaim[]
  synced_deductions LoanDeduction[]

  @@unique([payroll_run_id, employee_id])
  @@index([employee_id, month, year])
  @@map("payroll_records")
}

enum PayrollRecordStatus {
  DRAFT
  CALCULATED
  VERIFIED
  PAID
  ERROR
}

// ============================================================================
// LEAVE MANAGEMENT
// ============================================================================

model LeaveBalance {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  year       Int
  leave_type String // String for flexibility (Keka has various types)

  opening Float @default(0)
  accrued Float @default(0)
  used    Float @default(0)
  balance Float @default(0)

  // Import tracking
  source          String       @default("MANUAL")
  import_batch_id String?
  import_batch    ImportBatch? @relation(fields: [import_batch_id], references: [id])

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("LeaveBalanceCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("LeaveBalanceUpdatedBy", fields: [updated_by], references: [id])

  @@unique([employee_id, leave_type, year])
  @@map("leave_balances")
}

model LeaveType {
  id          String  @id @default(cuid())
  name        String  @unique // e.g., "Casual Leave", "Sick Leave"
  code        String  @unique // e.g., "CL", "SL", "EL"
  description String?

  annual_quota      Float   @default(0) // Default annual entitlement (can be fractional for half-days)
  max_carry_forward Float   @default(0) // Max days that can be carried to next year
  is_paid           Boolean @default(true) // Paid leave or LOP
  requires_approval Boolean @default(true)
  min_days_notice   Int     @default(0) // Advance notice required

  is_active Boolean @default(true)

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("LeaveTypeCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("LeaveTypeUpdatedBy", fields: [updated_by], references: [id])

  // Relations
  leave_requests LeaveRequest[]

  @@map("leave_types")
}

model LeaveRequest {
  id            String    @id @default(cuid())
  employee_id   String
  employee      Employee  @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  leave_type_id String
  leave_type    LeaveType @relation(fields: [leave_type_id], references: [id])

  start_date      DateTime @db.Date
  end_date        DateTime @db.Date
  days_count      Float // Calculated from dates (supports half-days)
  is_half_day     Boolean  @default(false)
  half_day_period String? // "FIRST_HALF" or "SECOND_HALF"

  reason String
  status LeaveRequestStatus @default(PENDING)

  // Approval tracking
  approved_by      String?
  approver         User?     @relation("LeaveRequestApprovedBy", fields: [approved_by], references: [id])
  approved_at      DateTime?
  rejection_reason String?

  // Cancellation
  cancelled_at        DateTime?
  cancellation_reason String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("LeaveRequestCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("LeaveRequestUpdatedBy", fields: [updated_by], references: [id])

  @@index([employee_id, status])
  @@index([start_date, end_date])
  @@map("leave_requests")
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================================================
// ATTENDANCE TRACKING
// ============================================================================

model Attendance {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  date         DateTime  @db.Date // The attendance date
  check_in     DateTime? // Check-in timestamp
  check_out    DateTime? // Check-out timestamp
  work_minutes Int       @default(0) // Calculated work duration in minutes

  status AttendanceStatus @default(ABSENT)
  source AttendanceSource @default(WEB)

  remarks        String?
  is_regularized Boolean   @default(false) // If manually corrected
  regularized_by String?
  regularized_at DateTime?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("AttendanceCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("AttendanceUpdatedBy", fields: [updated_by], references: [id])

  // Relations for corrections
  corrections AttendanceCorrection[]

  @@unique([employee_id, date])
  @@index([date])
  @@index([status])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  ON_LEAVE
  HOLIDAY
  WEEKEND
}

enum AttendanceSource {
  WEB
  MOBILE
  BIOMETRIC
  IMPORT
  MANUAL
}

model AttendanceLock {
  id    String @id @default(cuid())
  month Int // 1-12
  year  Int

  locked_at DateTime @default(now())
  locked_by String
  locker    User     @relation("AttendanceLockLockedBy", fields: [locked_by], references: [id])

  // Allow corrections with approval
  unlock_requested_by String?
  unlock_requested_at DateTime?
  unlock_reason       String?
  unlock_approved_by  String?
  unlock_approved_at  DateTime?

  @@unique([month, year])
  @@map("attendance_locks")
}

// ============================================================================
// DATA IMPORT TRACKING
// ============================================================================

model ImportBatch {
  id String @id @default(cuid())

  type      ImportType
  file_name String
  file_path String?

  total_records Int
  success_count Int @default(0)
  error_count   Int @default(0)

  status ImportStatus @default(PENDING)
  errors Json?

  started_at   DateTime  @default(now())
  completed_at DateTime?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("ImportBatchCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?

  // Relations
  salary_records SalaryRecord[]
  leave_balances LeaveBalance[]

  @@map("import_batches")
}

enum ImportType {
  EMPLOYEES
  SALARY_HISTORY
  LEAVE_BALANCES
  KEKA_MIGRATION
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

// ============================================================================
// ATTENDANCE CORRECTIONS
// ============================================================================

model AttendanceCorrection {
  id            String     @id @default(cuid())
  attendance_id String
  attendance    Attendance @relation(fields: [attendance_id], references: [id])

  // Requested changes
  new_check_in  DateTime?
  new_check_out DateTime?
  reason        String

  status CorrectionStatus @default(PENDING)

  // Approval tracking
  approved_by      String?
  approver         User?     @relation("CorrectionApprovedBy", fields: [approved_by], references: [id])
  approved_at      DateTime?
  rejection_reason String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("CorrectionCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("CorrectionUpdatedBy", fields: [updated_by], references: [id])

  @@map("attendance_corrections")
}

enum CorrectionStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// PROFESSIONAL TAX CONFIGURATION
// ============================================================================

model ProfessionalTaxSlab {
  id         String @id @default(cuid())
  state_code String // "KA", "MH", "TN", "TS" etc.

  // Slab range (stored in paise)
  salary_from Int // Inclusive, monthly gross
  salary_to   Int? // Inclusive, null means unlimited

  // Tax amount (stored in paise)
  tax_amount Int

  // Month-specific override
  month Int? // 1-12, null means applies to all months

  // Gender exemption
  applies_to_gender Gender? // null means applies to all genders

  frequency PaymentFrequency @default(MONTHLY)

  is_active Boolean @default(true)

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt
  updated_by String?

  @@index([state_code, is_active])
  @@index([state_code, month])
  @@map("professional_tax_slabs")
}

enum PaymentFrequency {
  MONTHLY
  YEARLY
}

// ============================================================================
// STATUTORY FILE TRACKING
// ============================================================================

model StatutoryFile {
  id String @id @default(cuid())

  // File details
  type         StatutoryFileType
  filename     String
  filepath     String
  record_count Int               @default(0)
  total_amount Int               @default(0) // In paise

  // Associated period
  month Int
  year  Int

  // Relations
  payroll_run_id String?
  payroll_run    PayrollRun? @relation(fields: [payroll_run_id], references: [id], onDelete: Cascade)

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt

  @@index([type, month, year])
  @@index([payroll_run_id])
  @@map("statutory_files")
}

enum StatutoryFileType {
  ECR
  ESI_CHALLAN
  FORM_24Q
  FORM_16
  PT_RETURN
}

// ============================================================================
// PROFILE UPDATE REQUESTS (approval workflow)
// ============================================================================

model ProfileUpdateRequest {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  // Requested changes stored as JSON
  // Contains: { field_name: { old: value, new: value } }
  changes     Json

  // Fields that can be updated by employees:
  // address_line1, address_line2, city, state, postal_code
  // emergency_contact, emergency_phone, personal_phone, personal_email

  status          ProfileUpdateStatus @default(PENDING)
  reason          String? // Employee's reason for update

  // Approval tracking
  approved_by     String?
  approver        User?    @relation("ProfileUpdateApprovedBy", fields: [approved_by], references: [id])
  approved_at     DateTime?
  rejection_reason String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt
  updated_by String?

  @@index([employee_id, status])
  @@index([status, created_at])
  @@map("profile_update_requests")
}

enum ProfileUpdateStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// STATUTORY DEADLINE TRACKING
// ============================================================================

model StatutoryDeadline {
  id String @id @default(cuid())

  type        DeadlineType
  description String

  // Period this deadline is for
  month Int
  year  Int

  // Due date
  due_date DateTime @db.Date

  // Filing status
  status FilingStatus @default(PENDING)

  // Filing details (when completed)
  filed_at          DateTime?
  filing_reference  String? // Challan/Acknowledgment number
  amount_filed_paise Int?

  // Alert tracking
  alert_7_day_sent   Boolean @default(false)
  alert_3_day_sent   Boolean @default(false)
  alert_1_day_sent   Boolean @default(false)
  overdue_alert_sent Boolean @default(false)

  // Audit
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  filed_by   String?

  @@unique([type, month, year])
  @@index([due_date, status])
  @@map("statutory_deadlines")
}

enum DeadlineType {
  PF_PAYMENT     // PF contribution payment
  PF_RETURN      // ECR filing
  ESI_PAYMENT    // ESI contribution payment
  ESI_RETURN     // ESI return filing
  TDS_DEPOSIT    // TDS deposit (7th of month)
  TDS_RETURN_24Q // Form 24Q quarterly return
  PT_PAYMENT     // Professional Tax payment
  FORM_16        // Annual Form 16 issuance
}

enum FilingStatus {
  PENDING
  FILED
  OVERDUE
  NOT_APPLICABLE
}

// ============================================================================
// INVESTMENT DECLARATIONS (for TDS calculation)
// ============================================================================

model InvestmentDeclaration {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  // Financial year
  financial_year String // e.g., "2025-26"

  // Section 80C (max Rs.1,50,000 total) - stored in paise
  section_80c_ppf                 Int @default(0)
  section_80c_elss                Int @default(0)
  section_80c_life_insurance      Int @default(0)
  section_80c_tuition_fees        Int @default(0)
  section_80c_nps                 Int @default(0)
  section_80c_home_loan_principal Int @default(0)
  section_80c_sukanya             Int @default(0)
  section_80c_other               Int @default(0)

  // Section 80D Health Insurance (max Rs.25,000 self, Rs.50,000 parents if senior)
  section_80d_self    Int @default(0)
  section_80d_parents Int @default(0)
  section_80d_checkup Int @default(0) // Max Rs.5,000

  // HRA (House Rent Allowance)
  hra_monthly_rent   Int     @default(0)
  hra_landlord_name  String?
  hra_landlord_pan   String? // Required if annual rent > Rs.1,00,000
  hra_rental_address String?

  // Other deductions
  section_80e_education_loan    Int @default(0) // No limit
  section_80g_donations         Int @default(0)
  section_24_home_loan_interest Int @default(0) // Max Rs.2,00,000

  // Status
  status      InvestmentDeclarationStatus @default(DRAFT)
  submitted_at DateTime?
  verified_at DateTime?
  verified_by String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt
  updated_by String?

  // Relations
  proof_documents InvestmentProofDocument[]

  @@unique([employee_id, financial_year])
  @@index([financial_year, status])
  @@map("investment_declarations")
}

enum InvestmentDeclarationStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}

model InvestmentProofDocument {
  id             String                @id @default(cuid())
  declaration_id String
  declaration    InvestmentDeclaration @relation(fields: [declaration_id], references: [id], onDelete: Cascade)

  // File details
  file_name      String // Unique generated filename
  original_name  String // Original uploaded filename
  storage_path   String // Full path on local filesystem
  section        String // '80C', '80D', 'HRA', 'OTHER'
  mime_type      String
  size_bytes     Int

  // Retention (8 years from upload)
  retention_until DateTime

  // Soft delete
  is_deleted Boolean   @default(false)
  deleted_at DateTime?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt

  @@index([declaration_id, section])
  @@map("investment_proof_documents")
}

// ============================================================================
// ONBOARDING WORKFLOWS
// ============================================================================

model OnboardingRecord {
  id          String   @id @default(cuid())
  employee_id String?  @unique
  employee    Employee? @relation(fields: [employee_id], references: [id])

  // Candidate details
  candidate_email String
  candidate_name  String
  candidate_phone String

  // Position details
  position       String
  department_id  String
  department     Department  @relation(fields: [department_id], references: [id])
  designation_id String
  designation    Designation @relation(fields: [designation_id], references: [id])

  // Offer details (in paise)
  offered_salary_paise Int
  offer_date           DateTime @db.Date
  joining_date         DateTime @db.Date

  // Status and workflow
  status OnboardingStatus @default(PENDING)

  // Checklist (JSON array validated with Zod)
  checklist Json // Array of ChecklistItem objects

  // Workflow timestamps
  offer_sent_at     DateTime?
  offer_accepted_at DateTime?
  completed_at      DateTime?

  // Offer acceptance token
  offer_token String @unique

  // Cancellation
  cancellation_reason String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("OnboardingRecordCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?

  @@index([status, joining_date])
  @@index([candidate_email])
  @@map("onboarding_records")
}

enum OnboardingStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================================================
// EMPLOYEE LOANS
// ============================================================================

model EmployeeLoan {
  id          String   @id @default(cuid())
  employee_id String
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  // Loan details
  loan_type           String // "SALARY_ADVANCE", "PERSONAL", "EMERGENCY"
  principal_paise     Int // Original loan amount
  annual_interest_rate Float // Percentage e.g., 12.5
  tenure_months       Int

  // Calculated fields (EMI calculation using reducing balance method)
  emi_paise              Int // Monthly EMI
  total_interest_paise   Int // Total interest over tenure
  total_repayment_paise  Int // Principal + total interest

  // Disbursement
  disbursed_paise    Int      @default(0) // Amount disbursed, could differ from principal
  disbursement_date  DateTime? @db.Date

  // Balance tracking
  remaining_balance_paise Int // Current outstanding balance

  // Tenure dates
  start_date DateTime @db.Date // When deductions start
  end_date   DateTime @db.Date // Calculated end date

  // Status
  status         LoanStatus @default(PENDING)
  closed_at      DateTime?  @db.Date
  closure_reason String?

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("LoanCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("LoanUpdatedBy", fields: [updated_by], references: [id])

  // Relations
  deductions LoanDeduction[]

  @@index([employee_id, status])
  @@index([status, start_date])
  @@map("employee_loans")
}

model LoanDeduction {
  id      String       @id @default(cuid())
  loan_id String
  loan    EmployeeLoan @relation(fields: [loan_id], references: [id], onDelete: Cascade)

  // Period
  month Int // 1-12
  year  Int

  // EMI breakdown (reducing balance method)
  emi_amount_paise   Int // Total EMI for this month
  principal_paise    Int // Principal portion of EMI
  interest_paise     Int // Interest portion of EMI
  balance_after_paise Int // Remaining balance after this deduction

  // Payroll integration
  payroll_record_id String? // Linked when synced with payroll
  payroll_record    PayrollRecord? @relation(fields: [payroll_record_id], references: [id])

  // Status
  status DeductionStatus @default(SCHEDULED)

  // Audit fields
  created_at DateTime @default(now())

  @@unique([loan_id, month, year])
  @@index([loan_id, status])
  @@index([month, year])
  @@map("loan_deductions")
}

enum LoanStatus {
  PENDING
  ACTIVE
  CLOSED
  CANCELLED
  DEFAULTED
}

enum DeductionStatus {
  SCHEDULED
  DEDUCTED
  SKIPPED
}

// ============================================================================
// EXPENSE MANAGEMENT
// ============================================================================

model ExpensePolicy {
  id          String  @id @default(cuid())
  name        String  @unique
  code        String  @unique // e.g., "TRAVEL", "FOOD", "EQUIPMENT"
  description String?

  // Policy limits (stored in paise, null means no limit)
  max_amount_paise         Int?
  auto_approve_below_paise Int? // Auto-approve if amount < this

  // Policy configuration
  requires_receipt   Boolean @default(true)
  requires_approval  Boolean @default(true)
  is_active          Boolean @default(true)

  // Audit fields
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  expense_claims ExpenseClaim[]

  @@map("expense_policies")
}

model ExpenseClaim {
  id          String        @id @default(cuid())
  employee_id String
  employee    Employee      @relation(fields: [employee_id], references: [id])
  policy_id   String
  policy      ExpensePolicy @relation(fields: [policy_id], references: [id])

  // Claim details (amount in paise)
  amount_paise  Int
  description   String
  expense_date  DateTime @db.Date

  // Receipt handling
  receipt_path          String?
  receipt_original_name String?

  // Status and approval
  status                 ExpenseStatus @default(DRAFT)
  current_approval_level Int           @default(1)

  // Policy snapshot (captures policy state at submission time)
  policy_snapshot Json

  // Rejection handling
  rejection_reason String?

  // Payroll integration
  synced_to_payroll Boolean @default(false)
  payroll_record_id String?
  payroll_record    PayrollRecord? @relation(fields: [payroll_record_id], references: [id])

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  creator    User?    @relation("ExpenseClaimCreatedBy", fields: [created_by], references: [id])
  updated_at DateTime @updatedAt
  updated_by String?
  updater    User?    @relation("ExpenseClaimUpdatedBy", fields: [updated_by], references: [id])

  // Relations
  approvals ExpenseApproval[]

  @@index([employee_id, status])
  @@index([status, created_at])
  @@map("expense_claims")
}

enum ExpenseStatus {
  DRAFT
  SUBMITTED
  PENDING_APPROVAL
  APPROVED
  REJECTED
  REIMBURSED
}

model ExpenseApproval {
  id         String       @id @default(cuid())
  expense_id String
  expense    ExpenseClaim @relation(fields: [expense_id], references: [id], onDelete: Cascade)

  // Approval level and role
  level         Int
  approver_role String // MANAGER, HR_MANAGER, ADMIN

  // Approver details (nullable until acted upon)
  approver_id String?
  status      ApprovalStatus @default(PENDING)

  // Action details
  comments String?
  acted_at DateTime?

  // Audit
  created_at DateTime @default(now())

  @@index([expense_id, level])
  @@index([approver_id, status])
  @@map("expense_approvals")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// AI ASSISTANT (Conversations and Policy Documents)
// ============================================================================

model Conversation {
  id        String    @id @default(cuid())
  user_id   String
  user      User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  title     String?   // Auto-generated from first message

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  messages Message[]

  @@index([user_id, updated_at])
  @@map("conversations")
}

model Message {
  id              String       @id @default(cuid())
  conversation_id String
  conversation    Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  role    String // 'user' | 'assistant' | 'system' | 'tool'
  content String @db.Text

  // Tool call tracking (for audit and debugging)
  tool_calls Json? // Array of { name, args, result }

  created_at DateTime @default(now())

  @@index([conversation_id, created_at])
  @@map("messages")
}

model PolicyDocument {
  id          String @id @default(cuid())
  title       String
  description String?
  category    String // 'LEAVE', 'PAYROLL', 'ATTENDANCE', 'EXPENSE', 'GENERAL'

  // Document content
  content      String @db.Text
  file_path    String? // Optional: if uploaded as file

  // Embedding status
  embedding_status EmbeddingStatus @default(PENDING)
  chunk_count      Int             @default(0)
  last_embedded_at DateTime?

  // Visibility (for RBAC filtering in RAG)
  visible_to_roles String[] // ['EMPLOYEE', 'MANAGER', 'ADMIN'] - empty = all

  is_active Boolean @default(true)

  // Audit fields
  created_at DateTime @default(now())
  created_by String?
  updated_at DateTime @updatedAt
  updated_by String?

  @@index([category, is_active])
  @@index([embedding_status])
  @@map("policy_documents")
}

enum EmbeddingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
